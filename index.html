<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vitox AI | India's #1 Video Hosting & Sharing Platform</title>
    <meta name="description"
        content="Vitox AI is India's next-gen video platform. Upload, share, and discover amazing videos powered by AI. Join the community of creators today.">
    <meta name="keywords" content="video platform, video sharing, indian youtube alternative, vitox ai, ai video">
    <link rel="stylesheet" href="style.css">
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>

<body class="dark-theme">

    <!-- Top Bar -->
    <header class="top-bar">
        <div class="header-left">
            <button class="icon-btn menu-btn" onclick="document.querySelector('.sidebar').classList.toggle('active')"><i
                    class="fas fa-bars"></i></button>
            <div class="logo">
                <i class="fas fa-bolt-lightning color-red"></i>
                <span>Vitox AI</span><span class="country-code">IN</span>
            </div>
        </div>

        <div class="header-center">
            <div class="search-container">
                <div class="search-box">
                    <input type="text" placeholder="Search">
                    <button class="search-btn"><i class="fas fa-search"></i></button>
                </div>
                <button class="icon-btn mic-btn"><i class="fas fa-microphone"></i></button>
            </div>
        </div>

        <div class="header-right">
            <button class="btn-text" onclick="location.href='dashboard.html'" title="Creator Studio">
                <i class="fas fa-clapperboard"></i> Studio
            </button>
            <div id="login-container">
                <div id="g_id_onload"
                    data-client_id="392918089798-sqv6ro56e2lkdhu8jmh0j7mb1ka3lhbj.apps.googleusercontent.com"
                    data-context="signin" data-ux_mode="popup" data-callback="handleCredentialResponse"
                    data-auto_prompt="false">
                </div>
                <div class="g_id_signin" data-type="standard" data-shape="pill" data-theme="outline"
                    data-text="signin_with" data-size="medium" data-logo_alignment="left">
                </div>
            </div>
            <!-- Upload Button -->
            <button class="icon-btn" onclick="location.href='upload.html'" title="Upload Video"><i
                    class="fas fa-plus"></i></button>
            <button class="icon-btn" onclick="alert('No new notifications')"><i class="fas fa-bell"></i></button>
            <div class="user-avatar" id="user-avatar" onclick="toggleUserMenu()" title="Account Options">?</div>

            <!-- Hidden User Menu -->
            <div id="user-menu"
                style="display: none; position: absolute; top: 56px; right: 16px; background: #282828; border: 1px solid #3f3f3f; border-radius: 8px; padding: 8px; z-index: 3000;">
                <button class="nav-item" onclick="logout()"
                    style="width: 100%; justify-content: start; background: transparent; border: none; padding: 8px 16px;">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </button>
            </div>
        </div>
    </header>

    <div class="main-layout">
        <!-- Sidebar -->
        <aside class="sidebar">
            <nav class="sidebar-nav">
                <a href="#" class="nav-item active" onclick="loadVideos(); return false;"><i class="fas fa-home"></i>
                    <span>Home</span></a>
                <a href="#" class="nav-item" onclick="alert('Shorts are coming soon in beta!'); return false;"><i
                        class="fas fa-play-circle"></i> <span>Shorts</span></a>
                <a href="#" class="nav-item" onclick="alert('Please login to manage subscriptions.'); return false;"><i
                        class="fas fa-layer-group"></i> <span>Subscriptions</span></a>
                <hr>
                <a href="#" class="nav-item" onclick="alert('Your library is empty.'); return false;"><i
                        class="fas fa-video-slash"></i> <span>Library</span></a>
                <a href="#" class="nav-item" onclick="alert('Watch history will be available soon.'); return false;"><i
                        class="fas fa-history"></i> <span>History</span></a>
                <a href="#" class="nav-item" onclick="alert('Watch later list is empty.'); return false;"><i
                        class="fas fa-clock"></i> <span>Watch later</span></a>
                <a href="#" class="nav-item" onclick="alert('No liked videos yet.'); return false;"><i
                        class="fas fa-thumbs-up"></i> <span>Liked videos</span></a>
            </nav>
        </aside>

        <!-- Content Area -->
        <main class="content">
            <!-- Categories -->
            <div class="categories-bar">
                <button class="chip active">All</button>
                <button class="chip">Music</button>
                <button class="chip">Gaming</button>
                <button class="chip">Live</button>
                <button class="chip">Tech</button>
                <button class="chip">News</button>
                <button class="chip">Comedy</button>
                <button class="chip">Education</button>
                <button class="chip">Recent</button>
            </div>

            <!-- Skeleton Loader (Visible during initial load) -->
            <div id="loading-shimmer">
                <div class="skeleton-card">
                    <div class="skeleton skeleton-thumbnail"></div>
                    <div style="display: flex; gap: 12px; margin-top: 12px;">
                        <div class="skeleton skeleton-avatar"></div>
                        <div style="flex: 1;">
                            <div class="skeleton skeleton-text"></div>
                            <div class="skeleton skeleton-text" style="width: 50%;"></div>
                        </div>
                    </div>
                </div>
                <div class="skeleton-card">
                    <div class="skeleton skeleton-thumbnail"></div>
                    <div style="display: flex; gap: 12px; margin-top: 12px;">
                        <div class="skeleton skeleton-avatar"></div>
                        <div style="flex: 1;">
                            <div class="skeleton skeleton-text"></div>
                            <div class="skeleton skeleton-text" style="width: 50%;"></div>
                        </div>
                    </div>
                </div>
                <div class="skeleton-card">
                    <div class="skeleton skeleton-thumbnail"></div>
                    <div style="display: flex; gap: 12px; margin-top: 12px;">
                        <div class="skeleton skeleton-avatar"></div>
                        <div style="flex: 1;">
                            <div class="skeleton skeleton-text"></div>
                            <div class="skeleton skeleton-text" style="width: 50%;"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Video Grid -->
            <div class="video-grid" id="main-video-grid">
                <!-- Real videos will be injected here via JavaScript -->
            </div>

            <!-- Empty State if no videos -->
            <div id="empty-state" class="empty-state" style="display: none;">
                <i class="fas fa-video-slash"></i>
                <p>No videos found. Be the first to upload one!</p>
            </div>
        </main>
    </div>

    <script>
        async function loadVideos() {
            try {
                const res = await fetch('/api/videos');
                const videos = await res.json();

                const grid = document.getElementById('main-video-grid');
                const emptyState = document.getElementById('empty-state');
                const skeleton = document.getElementById('loading-shimmer');

                if (skeleton) skeleton.style.display = 'none';

                if (videos.length === 0) {
                    emptyState.style.display = 'block';
                    grid.style.display = 'none';
                    return;
                }

                emptyState.style.display = 'none';
                grid.style.display = 'grid';

                grid.innerHTML = videos.map(vid => `
                    <div class="video-card" onclick="playVideo('${vid.video_url}', '${vid.title}', '${vid.user_email}', ${vid.views}, '${vid.timestamp}')">
                        <div class="thumbnail-wrapper">
                            <video src="${vid.video_url}" muted onmouseover="this.play()" onmouseout="this.pause()" style="width: 100%; height: 100%; object-fit: cover;"></video>
                        </div>
                        <div class="video-info">
                            <div class="channel-avatar">
                                ${vid.user_email.charAt(0).toUpperCase()}
                            </div>
                            <div class="text-info">
                                <h3 class="video-title">${vid.title || 'Untitled Video'}</h3>
                                <p class="channel-name">${(vid.user_email || 'User').split('@')[0]} <i class="fas fa-check-circle"></i></p>
                                <div class="meta-data">
                                    <span>${vid.views || 0} views</span> • <span>${vid.timestamp ? new Date(vid.timestamp).toLocaleDateString() : 'Just now'}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                `).join('');

            } catch (e) {
                console.error("Failed to load videos", e);
            }
        }

        function playVideo(url, title, channel, views, timestamp) {
            // Enhanced YouTube-style Player Modal
            const playerOverlay = document.createElement('div');
            playerOverlay.id = 'video-modal';
            playerOverlay.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                background: rgba(0,0,0,0.9); z-index: 5000;
                display: flex; justify-content: center; overflow-y: auto; padding: 20px 0;
            `;

            // Format time
            const timeAgo = new Date(timestamp).toLocaleDateString();

            playerOverlay.innerHTML = `
                <div style="width: 90%; max-width: 1000px; position: relative; background: #0f0f0f; min-height: 100vh;">
                    <!-- Close Button -->
                    <button onclick="document.getElementById('video-modal').remove()" 
                            style="position: absolute; top: 10px; right: 10px; background: rgba(0,0,0,0.5); border: none; color: white; width: 40px; height: 40px; border-radius: 50%; font-size: 1.5rem; cursor: pointer; z-index: 10;">&times;</button>
                    
                    <!-- Video Player -->
                    <div style="width: 100%; background: black; aspect-ratio: 16/9;">
                        <video src="${url}" controls autoplay style="width: 100%; height: 100%;"></video>
                    </div>

                    <!-- Video Info -->
                    <div style="padding: 20px;">
                        <h1 style="font-size: 1.25rem; font-weight: 700; margin: 0 0 10px 0;">${title || 'Untitled Video'}</h1>
                        
                        <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
                            <!-- Channel Info -->
                            <div style="display: flex; align-items: center; gap: 12px;">
                                <div style="width: 40px; height: 40px; border-radius: 50%; background: #555; display: flex; align-items: center; justify-content: center; font-weight: bold; color: white;">
                                    ${channel.charAt(0).toUpperCase()}
                                </div>
                                <div>
                                    <div style="font-weight: 700; font-size: 1rem;">${channel.split('@')[0]} <i class="fas fa-check-circle" style="color: #aaa; font-size: 0.8rem;"></i></div>
                                    <div style="font-size: 0.75rem; color: #aaa;">1.2K subscribers</div>
                                </div>
                                <button onclick="this.innerText = this.innerText === 'Subscribe' ? 'Subscribed' : 'Subscribe'; this.style.background = this.innerText === 'Subscribed' ? '#333' : '#f00';" 
                                    style="background: #f00; color: white; border: none; padding: 10px 16px; border-radius: 18px; font-weight: 700; cursor: pointer; margin-left: 10px;">Subscribe</button>
                            </div>

                            <!-- Actions -->
                            <div style="display: flex; gap: 8px;">
                                <div style="background: #272727; border-radius: 18px; display: flex; overflow: hidden;">
                                    <button class="action-btn" onclick="this.style.color = '#fff'"><i class="fas fa-thumbs-up"></i> <span>245</span></button>
                                    <div style="width: 1px; background: #3f3f3f; margin: 6px 0;"></div>
                                    <button class="action-btn"><i class="fas fa-thumbs-down"></i></button>
                                </div>
                                <button class="action-btn secondary"><i class="fas fa-share"></i> Share</button>
                            </div>
                        </div>

                        <!-- Description Box -->
                        <div style="background: #272727; border-radius: 12px; padding: 12px; margin-top: 20px; font-size: 0.9rem;">
                            <div style="font-weight: 700; margin-bottom: 8px;">${views} views • ${timeAgo}</div>
                            <p style="color: #eee; margin: 0;">Watching ${title} on Vitox AI. Experience the future of video sharing.</p>
                        </div>

                        <!-- Comments Section (Mock) -->
                        <div style="margin-top: 24px;">
                            <h3 style="font-size: 1.1rem; margin-bottom: 20px;">Comments</h3>
                            <div style="display: flex; gap: 12px; margin-bottom: 20px;">
                                <div style="width: 40px; height: 40px; border-radius: 50%; background: #3ea6ff; display: flex; align-items: center; justify-content: center; color: black; font-weight: bold;">Y</div>
                                <input type="text" placeholder="Add a comment..." style="flex: 1; background: transparent; border: none; border-bottom: 1px solid #3f3f3f; color: white; padding: 8px; outline: none;">
                            </div>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(playerOverlay);
            document.body.style.overflow = 'hidden'; // Prevent background scrolling

            // Re-enable scrolling when closed
            const closeBtn = playerOverlay.querySelector('button');
            const originalRemove = playerOverlay.remove.bind(playerOverlay);
            playerOverlay.remove = function () {
                document.body.style.overflow = '';
                originalRemove();
            };
        }

        // Search Functionality
        document.querySelector('.search-btn').addEventListener('click', performSearch);
        document.querySelector('.search-box input').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') performSearch();
        });

        function performSearch() {
            const query = document.querySelector('.search-box input').value.toLowerCase();
            const cards = document.querySelectorAll('.video-card');
            let found = false;

            cards.forEach(card => {
                const title = card.querySelector('.video-title').innerText.toLowerCase();
                const channel = card.querySelector('.channel-name').innerText.toLowerCase();
                if (title.includes(query) || channel.includes(query)) {
                    card.style.display = 'flex'; // grid/flex
                    found = true;
                } else {
                    card.style.display = 'none';
                }
            });

            const emptyState = document.getElementById('empty-state');
            const grid = document.getElementById('main-video-grid');

            if (!found && query !== '') {
                // Show custom "No results" message if needed, or just let empty state handle it if grid is empty
                // For now, if grid is empty (all hidden), show empty state
                // But simplified:
            }
        }

        async function handleCredentialResponse(response) {
            const base64Url = response.credential.split('.')[1];
            const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
            const payload = JSON.parse(window.atob(base64));

            console.log("Syncing with Full Stack Backend...");

            // Sync with Python Backend
            try {
                const res = await fetch('/api/user', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        email: payload.email,
                        name: payload.name,
                        picture: payload.picture
                    })
                });

                const dbUser = await res.json();

                // Save complete backend user profile
                localStorage.setItem('vitox_user', JSON.stringify(dbUser));

                updateLoginUI(dbUser);
                alert(`Welcome back, ${dbUser.name}!`);
            } catch (error) {
                console.error("Backend Sync Failed:", error);
                // Fallback to local only if server is down
                localStorage.setItem('vitox_user', JSON.stringify(payload));
                updateLoginUI(payload);
            }
        }

        function updateLoginUI(user) {
            if (user) {
                console.log("Updating UI for:", user.name);
                const loginContainer = document.getElementById('login-container');
                const avatar = document.getElementById('user-avatar');

                if (loginContainer) loginContainer.style.display = 'none';

                if (avatar) {
                    avatar.textContent = user.name.charAt(0).toUpperCase();
                    // Remove Mavo property temporarily to prevent overwrite
                    avatar.removeAttribute('property');

                    if (user.picture) {
                        avatar.style.backgroundImage = `url(${user.picture})`;
                        avatar.style.backgroundSize = 'cover';
                        avatar.style.backgroundPosition = 'center';
                        avatar.style.color = 'transparent';
                    }

                    // Show Admin Button if authorized
                    if (user.email === 'junaidshah78634@gmail.com') {
                        const headerRight = document.querySelector('.header-right');
                        if (!document.getElementById('admin-link-btn')) {
                            const adminBtn = document.createElement('button');
                            adminBtn.id = 'admin-link-btn';
                            adminBtn.className = 'btn-text';
                            adminBtn.innerHTML = '<i class="fas fa-shield-halved"></i> Admin';
                            adminBtn.onclick = () => location.href = 'admin.html';
                            adminBtn.style.color = '#ff4d4d';
                            headerRight.insertBefore(adminBtn, headerRight.firstChild);
                        }
                    }
                }
            }
        }

        // Check if user is already logged in on page load
        window.addEventListener('load', () => {
            const savedUser = localStorage.getItem('vitox_user');
            if (savedUser) {
                updateLoginUI(JSON.parse(savedUser));
            }

            // Load real videos from DB
            loadVideos();

            // Category Chip Interaction
            const chips = document.querySelectorAll('.chip');
            chips.forEach(chip => {
                chip.onclick = () => {
                    chips.forEach(c => c.classList.remove('active'));
                    chip.classList.add('active');
                };
            });
        });

        function toggleUserMenu() {
            const menu = document.getElementById('user-menu');
            menu.style.display = menu.style.display === 'none' ? 'block' : 'none';
        }

        function logout() {
            localStorage.removeItem('vitox_user');
            location.reload();
        }
    </script>
</body>

</html>