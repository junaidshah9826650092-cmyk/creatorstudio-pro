<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vitox - Video Platform</title>
    <!-- Vitox V Favicon -->
    <link rel="icon"
        href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'><path fill='%23ff0055' d='M32 62 L4 12 L18 12 L32 40 L46 12 L60 12 Z'/></svg>">
    <meta name="description"
        content="Vitox is India's next-gen video platform. Upload, share, and discover amazing videos. Join the community of creators today.">
    <meta name="keywords" content="video platform, video sharing, indian youtube alternative, vitox, video">
    <link rel="stylesheet" href="style.css?v=20.0">
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script async custom-element="amp-auto-ads" src="https://cdn.ampproject.org/v0/amp-auto-ads-0.1.js"></script>
</head>

<body class="dark-theme">
    <amp-auto-ads type="adsense" data-ad-client="ca-pub-7142476355791158"></amp-auto-ads>

    <!-- Top Bar -->
    <header class="top-bar">
        <div class="header-left">
            <button class="icon-btn menu-btn" onclick="document.querySelector('.sidebar').classList.toggle('active')"><i
                    class="fas fa-bars"></i></button>
            <div class="logo">
                <!-- Vitox 'V' Logo -->
                <svg width="32" height="32" viewBox="0 0 64 64" style="margin-right: 8px;">
                    <defs>
                        <linearGradient id="vGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                            <stop offset="0%" style="stop-color:#ff0055;stop-opacity:1" />
                            <stop offset="100%" style="stop-color:#ff5500;stop-opacity:1" />
                        </linearGradient>
                    </defs>
                    <path fill="url(#vGradient)" d="M32 62 L4 12 L18 12 L32 40 L46 12 L60 12 Z" />
                </svg>
                <span style="font-family: 'Outfit', sans-serif; letter-spacing: -0.5px; font-weight: 700;">Vitox</span>
            </div>
        </div>

        <div class="header-center" id="search-bar-container">
            <button class="icon-btn mobile-back-btn" onclick="toggleMobileSearch()"
                style="display: none; margin-right: 8px;"><i class="fas fa-arrow-left"></i></button>
            <div class="search-container">
                <div class="search-box">
                    <input type="text" id="search-input" placeholder="Search">
                    <button class="search-btn" onclick="performSearch()"><i class="fas fa-search"></i></button>
                </div>
                <button class="icon-btn mic-btn" onclick="startVoiceSearch()"><i class="fas fa-microphone"></i></button>
            </div>
        </div>

        <div class="header-right">
            <button class="icon-btn mobile-search-trigger" onclick="toggleMobileSearch()"><i
                    class="fas fa-search"></i></button>
            <!-- Create Menu (YouTube Style but Custom) -->
            <div class="create-container">
                <button class="create-btn" id="create-btn" onclick="toggleCreateMenu()">
                    <i class="fas fa-plus"></i> <span>Create</span>
                </button>
                <div class="create-dropdown" id="create-dropdown">
                    <a href="upload.html?v=8.0"><i class="fas fa-upload"></i> Upload video</a>
                    <a href="#" onclick="alert('Go Live coming soon!')"><i class="fas fa-tower-broadcast"></i> Go
                        live</a>
                    <a href="#" onclick="alert('Posts coming soon!')"><i class="fas fa-pen-to-square"></i> Create
                        post</a>
                </div>
            </div>

            <button class="icon-btn" onclick="location.href='dashboard_overview.html'" title="Creator Studio">
                <i class="fas fa-clapperboard"></i>
            </button>
            <div id="login-container">
                <div id="g_id_onload"
                    data-client_id="392918089798-sqv6ro56e2lkdhu8jmh0j7mb1ka3lhbj.apps.googleusercontent.com"
                    data-context="signin" data-ux_mode="popup" data-callback="handleCredentialResponse"
                    data-auto_prompt="false">
                </div>
                <div class="g_id_signin" data-type="standard" data-shape="pill" data-theme="outline"
                    data-text="signin_with" data-size="medium" data-logo_alignment="left">
                </div>
            </div>
            <button class="icon-btn" onclick="alert('No new notifications')"><i class="fas fa-bell"></i></button>
            <div class="user-avatar" id="user-avatar" onclick="toggleUserMenu()" title="Account Options">?</div>

            <!-- Hidden User Menu -->
            <div id="user-menu" class="dropdown-menu">
                <div class="user-info-header" id="menu-user-info"
                    style="display:none; padding: 12px; border-bottom: 1px solid var(--border);">
                    <div id="menu-user-name" style="font-weight: 600;">User</div>
                </div>
                <a href="dashboard_overview.html"><i class="fas fa-user-circle"></i> View Channel</a>
                <a href="#" onclick="logout()"><i class="fas fa-sign-out-alt"></i> Logout</a>
            </div>
        </div>
    </header>

    <div class="main-layout">
        <!-- Sidebar -->
        <aside class="sidebar">
            <nav class="sidebar-nav">
                <!-- Main -->
                <a href="#" class="nav-item active" onclick="loadVideos(); return false;"><i class="fas fa-home"></i>
                    <span>Feed</span></a>
                <a href="#" class="nav-item" onclick="loadSnapsView(); return false;"><i class="fas fa-play-circle"></i>
                    <span>V-Snaps</span></a>
                <a href="#" class="nav-item" onclick="loadView('Squad'); return false;"><i
                        class="fas fa-layer-group"></i> <span>Squad</span></a>
                <hr>

                <!-- You Section -->
                <div class="nav-section-title"
                    style="padding: 8px 12px; font-weight: 600; font-size: 1rem; color: var(--text-primary); display: flex; align-items: center; gap: 6px;">
                    You <i class="fas fa-chevron-right" style="font-size: 0.8rem;"></i>
                </div>

                <a href="#" class="nav-item" onclick="loadView('Rewind'); return false;"><i class="fas fa-history"></i>
                    <span>Rewind</span></a>
                <a href="#" class="nav-item" onclick="loadView('Collections'); return false;"><i
                        class="fas fa-list"></i>
                    <span>Collections</span></a>
                <a href="#" class="nav-item" onclick="loadView('Bookmarks'); return false;"><i class="fas fa-clock"></i>
                    <span>Bookmarks</span></a>
                <a href="#" class="nav-item" onclick="loadLikedVideosView(); return false;"><i
                        class="fas fa-thumbs-up"></i> <span>Favorites</span></a>
                <a href="#" class="nav-item" onclick="loadView('Creator Hub'); return false;"><i
                        class="fas fa-video"></i> <span>Creator Hub</span></a>
                <a href="#" class="nav-item" onclick="loadView('Vault'); return false;"><i class="fas fa-download"></i>
                    <span>Vault</span></a>
                <hr>
                <a href="#" class="nav-item" onclick="showPagesModal(); return false;"><i
                        class="fas fa-info-circle"></i>
                    <span>About & Privacy</span></a>
            </nav>
        </aside>

        <!-- Content Area -->
        <main class="content">
            <!-- Categories -->
            <div class="categories-bar">
                <button class="chip active" onclick="filterByCategory('All')">All</button>
                <button class="chip" onclick="filterByCategory('Music')">Music</button>
                <button class="chip" onclick="filterByCategory('Gaming')">Gaming</button>
                <button class="chip" onclick="filterByCategory('Live')">Live</button>
                <button class="chip" onclick="filterByCategory('Tech')">Tech</button>
                <button class="chip" onclick="filterByCategory('News')">News</button>
                <button class="chip" onclick="filterByCategory('Comedy')">Comedy</button>
                <button class="chip" onclick="filterByCategory('Education')">Education</button>
            </div>

            <!-- Video Grid -->

            <!-- Video Grid -->
            <div class="video-grid" id="main-video-grid">
                <!-- Real videos will be injected here via JavaScript -->
            </div>

            <!-- Empty State if no videos -->
            <div id="empty-state" class="empty-state" style="display: none;">
                <i class="fas fa-video-slash"></i>
                <p>No videos found. Be the first to upload one!</p>
            </div>
        </main>
    </div>

    <div id="toast-container"></div>
    <script>
        let allVideos = []; // Global for search

        async function loadVideos() {
            try {
                const res = await fetch('/api/videos');
                allVideos = await res.json();
                renderVideos(allVideos);
            } catch (e) { console.error(e); }
        }

        function renderVideos(videosToRender) {
            const grid = document.getElementById('main-video-grid');
            const emptyState = document.getElementById('empty-state');

            if (!videosToRender || videosToRender.length === 0) {
                if (emptyState) emptyState.style.display = 'block';
                if (grid) grid.style.display = 'none';
                return;
            }

            if (emptyState) emptyState.style.display = 'none';
            if (grid) {
                // Reset Grid Styles
                grid.style.display = 'grid';
                grid.style.flexDirection = '';
                grid.style.alignItems = '';
                grid.style.gap = '';
                grid.style.padding = '';
                grid.style.height = '';
                grid.style.overflowY = '';
                grid.style.scrollSnapType = '';
                grid.style.justifyContent = 'start';

                grid.innerHTML = '';

                videosToRender.forEach((vid, index) => {
                    const card = document.createElement('div');
                    card.className = 'video-card';
                    card.style.animationDelay = `${index * 50}ms`;

                    card.onclick = () => playVideo(
                        vid.video_url,
                        vid.title || 'Untitled',
                        vid.user_email,
                        vid.views || 0,
                        vid.timestamp,
                        vid.description || '',
                        vid.id
                    );

                    card.innerHTML = `
                            <div class="thumbnail-wrapper">
                                <video src="${vid.video_url}" muted onmouseover="this.play()" onmouseout="this.pause()" style="width: 100%; height: 100%; object-fit: cover;"></video>
                            </div>
                            <div class="video-info">
                                <div class="channel-avatar">
                                    ${(vid.user_email || '?').charAt(0).toUpperCase()}
                                </div>
                                <div class="text-info">
                                    <h3 class="video-title">${(!vid.title || vid.title === 'undefined') ? 'Vitox Masterpiece' : vid.title}</h3>
                                    <p class="channel-name">${(!vid.user_email || vid.user_email === 'undefined') ? 'Official Creator' : vid.user_email.split('@')[0]} <i class="fas fa-check-circle"></i></p>
                                    <div class="meta-data">
                                        <span>${vid.views || 0} views</span> • <span>${vid.timestamp ? new Date(vid.timestamp).toLocaleDateString() : 'Just now'}</span>
                                    </div>
                                </div>
                            </div>
                        `;
                    grid.appendChild(card);
                });
            }

            // Update Sidebar Active State
            document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
            document.querySelector('.nav-item').classList.add('active'); // Home/Feed is index 0
        }

        async function loadSnapsView() {
            const grid = document.getElementById('main-video-grid');
            const emptyState = document.getElementById('empty-state');
            if (!grid) return;

            // Update UI Interface
            document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
            const snapLink = Array.from(document.querySelectorAll('.nav-item')).find(a => a.innerText.includes('V-Snaps'));
            if (snapLink) snapLink.classList.add('active');

            try {
                const res = await fetch('/api/videos');
                const vids = await res.json();

                // Shuffle for random feed
                vids.sort(() => Math.random() - 0.5);

                if (!vids || vids.length === 0) {
                    loadView('V-Snaps');
                    return;
                }

                if (emptyState) emptyState.style.display = 'none';

                // Transformation to Shorts Mode
                grid.style.display = 'block'; // Block to allow container inside
                grid.innerHTML = '<div class="snap-container" id="snap-scroller"></div>';
                const container = document.getElementById('snap-scroller');

                vids.forEach((vid, index) => {
                    const snap = document.createElement('div');
                    snap.className = 'snap-card';

                    // Ad Injection Logic (Every 5th video)
                    if (index > 0 && index % 5 === 0) {
                        const adSnap = document.createElement('div');
                        adSnap.className = 'snap-card';
                        adSnap.style.background = '#222';
                        adSnap.style.display = 'flex';
                        adSnap.style.alignItems = 'center';
                        adSnap.style.justifyContent = 'center';
                        adSnap.innerHTML = `
                            <div style="text-align: center; color: #aaa;">
                                <i class="fas fa-ad" style="font-size: 3rem; margin-bottom: 20px;"></i>
                                <p>Sponsored Content</p>
                                <div id="ad-slot-${index}"></div>
                            </div>
                        `;
                        container.appendChild(adSnap);
                        // Initialize ad dynamically if needed
                    }

                    snap.innerHTML = `
                        <video src="${vid.video_url}" class="snap-video" loop muted playsinline></video>
                        
                        <div class="snap-overlay">
                            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 12px; cursor: pointer;">
                                <div class="channel-avatar" style="border: 2px solid white;">
                                    ${(vid.user_email || '?').charAt(0).toUpperCase()}
                                </div>
                                <span style="font-weight: 700; font-size: 1rem; text-shadow: 0 1px 3px rgba(0,0,0,0.8);">@${vid.user_email.split('@')[0]}</span>
                                <button class="btn-primary" style="padding: 4px 12px; border-radius: 12px; font-size: 0.75rem; font-weight: 700; border: none; margin-left: auto;">Follow</button>
                            </div>
                            <h3 style="margin: 0; font-size: 1.1rem; font-weight: 500; line-height: 1.4; text-shadow: 0 1px 3px rgba(0,0,0,0.8);">${vid.title || 'Vitox Snap'}</h3>
                            <p style="margin: 6px 0 0 0; font-size: 0.9rem; opacity: 0.9;">${vid.description || '#Vitox #Shorts'}</p>
                        </div>

                        <div class="snap-actions">
                            <div class="action-item" onclick="toggleLike(${vid.id}, '${vid.user_email}')">
                                <i class="fas fa-heart"></i>
                                <span>${vid.likes || 0}</span>
                            </div>
                            <div class="action-item" onclick="alert('Comments coming soon!')">
                                <i class="fas fa-comment-dots"></i>
                                <span>${vid.comment_count || 0}</span>
                            </div>
                            <div class="action-item" onclick="alert('Share feature coming soon!')">
                                <i class="fas fa-share"></i>
                                <span>Share</span>
                            </div>
                             <div class="action-item" onclick="alert('Remix this Snap!')">
                                <i class="fas fa-record-vinyl fa-spin" style="animation-duration: 4s;"></i>
                            </div>
                        </div>
                    `;

                    const video = snap.querySelector('video');

                    // Click to Play/Pause
                    snap.onclick = (e) => {
                        if (e.target.closest('.action-item') || e.target.closest('button')) return;
                        if (video.paused) {
                            // Pause others
                            container.querySelectorAll('video').forEach(v => {
                                if (v !== video) {
                                    v.pause();
                                    v.currentTime = 0; // Reset for better UX
                                }
                            });
                            video.play();
                            video.muted = false; // Unmute on interaction
                        } else {
                            video.pause();
                        }
                    };

                    container.appendChild(snap);
                });

                // Intersection Observer for Auto-Play on Scroll
                const observer = new IntersectionObserver((entries) => {
                    entries.forEach(entry => {
                        const vid = entry.target.querySelector('video');
                        if (!vid) return;

                        if (entry.isIntersecting) {
                            // Pause all others first to save resources & mobile battery
                            container.querySelectorAll('video').forEach(v => {
                                if (v !== vid) v.pause();
                            });

                            vid.play().catch(e => console.log("Auto-play prevented (interaction needed)"));
                            vid.muted = false;
                        } else {
                            vid.pause();
                        }
                    });
                }, { threshold: 0.6 }); // 60% visibility triggers play

                document.querySelectorAll('.snap-card').forEach(card => observer.observe(card));

            } catch (e) {
                console.error("Snap Load Error:", e);
            }
        }

        async function loadLikedVideosView() {
            const grid = document.getElementById('main-video-grid');
            const emptyState = document.getElementById('empty-state');
            if (!grid) return;

            // Check Login
            const user = JSON.parse(localStorage.getItem('vitox_user'));
            if (!user) return loadView('Liked Videos'); // Default blocking view if not logged in

            // Fetch Likes
            try {
                const res = await fetch(`/api/user/liked-videos/${user.email}`);
                const likedVideos = await res.json();

                if (emptyState) emptyState.style.display = 'none';
                grid.style.display = 'block'; // Block for custom layout

                if (likedVideos.length === 0) {
                    loadView('Liked Videos'); // Show empty state
                    return;
                }

                const firstVideo = likedVideos[0];

                grid.innerHTML = `
                    <div class="liked-layout" style="display: flex; gap: 24px; color: white; height: 85vh;">
                        <!-- Left Hero -->
                        <div class="liked-hero" style="
                            width: 360px; 
                            background: linear-gradient(180deg, rgba(50,50,50,0.8), rgba(15,15,15,1)); 
                            border-radius: 16px; 
                            padding: 24px; 
                            display: flex; 
                            flex-direction: column; 
                            justify-content: flex-end; 
                            position: relative; 
                            overflow: hidden;
                            flex-shrink: 0;
                        ">
                            <!-- Blurry Backdrop -->
                            <div style="
                                position: absolute; top: 0; left: 0; right: 0; bottom: 0; 
                                background-image: url('${firstVideo.video_url}#t=5'); 
                                background-size: cover; 
                                filter: blur(30px) brightness(0.6); 
                                z-index: 0;
                            "></div>
                            
                            <div style="position: relative; z-index: 2;">
                                <img src="${firstVideo.video_url}#t=5" style="width: 100%; aspect-ratio: 16/9; border-radius: 12px; object-fit: cover; margin-bottom: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.3);">
                                <h1 style="font-size: 1.8rem; margin: 0 0 10px 0;">Liked videos</h1>
                                <p style="margin: 0; font-weight: 500;">${user.name}</p>
                                <p style="color: #aaa; font-size: 0.9rem; margin-top: 4px;">${likedVideos.length} videos • No views</p>
                                
                                <div style="display: flex; gap: 10px; margin-top: 24px;">
                                    <button style="border-radius: 50%; width: 40px; height: 40px; border: none; background: rgba(255,255,255,0.1); color: white; cursor: pointer;"><i class="fas fa-download"></i></button>
                                    <button style="border-radius: 50%; width: 40px; height: 40px; border: none; background: rgba(255,255,255,0.1); color: white; cursor: pointer;"><i class="fas fa-ellipsis-v"></i></button>
                                </div>
                                <button style="margin-top: 20px; padding: 10px 24px; background: white; color: black; border: none; border-radius: 20px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 8px;">
                                    <i class="fas fa-play"></i> Play all
                                </button>
                            </div>
                        </div>

                        <!-- Right List -->
                        <div class="liked-list" style="flex: 1; overflow-y: auto;">
                            ${likedVideos.map((vid, idx) => `
                                <div onclick="playVideo('${vid.video_url}', '${vid.title}', '${vid.user_email}', ${vid.views}, '${vid.timestamp}', '', ${vid.id})" 
                                    style="display: flex; gap: 12px; padding: 12px; border-radius: 12px; cursor: pointer; transition: background 0.2s;"
                                    onmouseover="this.style.background='rgba(255,255,255,0.1)'" 
                                    onmouseout="this.style.background='transparent'">
                                    
                                    <span style="color: #aaa; width: 20px; display: flex; align-items: center; justify-content: center;">${idx + 1}</span>
                                    
                                    <div style="width: 160px; height: 90px; border-radius: 8px; overflow: hidden; flex-shrink: 0; position: relative;">
                                        <video src="${vid.video_url}" style="width: 100%; height: 100%; object-fit: cover;"></video>
                                    </div>
                                    
                                    <div style="flex: 1;">
                                        <h4 style="margin: 0 0 4px 0; font-size: 1rem;">${vid.title || 'Untitled Video'}</h4>
                                        <p style="margin: 0; font-size: 0.85rem; color: #aaa;">${vid.user_email} • ${vid.views || 0} views</p>
                                    </div>

                                    <button style="background: none; border: none; color: white; opacity: 0; align-self: center;" class="more-btn"><i class="fas fa-ellipsis-v"></i></button>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;

            } catch (e) {
                console.error(e);
                loadView('Liked Videos');
            }
        }

        function loadView(viewName) {
            const grid = document.getElementById('main-video-grid');
            const emptyState = document.getElementById('empty-state');

            // Clear Grid
            if (grid) grid.innerHTML = '';

            // Show Custom Message
            if (emptyState) {
                emptyState.style.display = 'block';
                emptyState.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: var(--text-secondary);">
                        <i class="fas fa-tools" style="font-size: 3rem; margin-bottom: 20px;"></i>
                        <h2 style="color: var(--text-primary); margin-bottom: 10px;">${viewName}</h2>
                        <p>This feature is currently under development.</p>
                        <button onclick="loadVideos()" style="margin-top: 20px; padding: 10px 24px; background: var(--accent); border: none; color: white; border-radius: 4px; cursor: pointer; font-weight: 600;">Back to Home</button>
                    </div>
                `;
            }
        }

        function performSearch() {
            const query = document.getElementById('search-input').value.toLowerCase();
            if (!query) return renderVideos(allVideos);

            const filtered = allVideos.filter(vid =>
                (vid.title && vid.title.toLowerCase().includes(query)) ||
                (vid.description && vid.description.toLowerCase().includes(query))
            );
            renderVideos(filtered);
        }

        document.getElementById('search-input').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') performSearch();
        });

        function startVoiceSearch() {
            if (!('webkitSpeechRecognition' in window)) {
                showToast("Voice search not supported.");
                return;
            }
            const recognition = new webkitSpeechRecognition();
            recognition.lang = 'en-US';
            recognition.start();

            showToast("Listening...");
            recognition.onresult = (event) => {
                const transcript = event.results[0][0].transcript;
                document.getElementById('search-input').value = transcript;
                performSearch();
            };
            recognition.onerror = () => showToast("Voice input failed.");
        }

        function showToast(msg) {
            const container = document.getElementById('toast-container');
            if (!container) return alert(msg);
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.innerText = msg;
            toast.style.cssText = "background: #333; color: white; padding: 12px 24px; border-radius: 4px; margin-top: 10px;";
            container.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        async function playVideo(url, title, channel, initialViews, timestamp, description = "", videoId) {
            console.log("Playing Video ID:", videoId, "Title:", title);
            const user = JSON.parse(localStorage.getItem('vitox_user'));

            // Scrub 'undefined' strings that might leak from storage/API
            const scrub = (val, fallback) => (!val || val === 'undefined' || val === 'null' ? fallback : val);

            const safeTitle = scrub(title, 'Vitox Exclusive');
            const safeChannel = scrub(channel, 'Official Creator');
            const safeDesc = scrub(description, `Exploring the depth of ${safeTitle} on Vitox.`);
            const safeId = videoId;
            const isSelf = user && (user.email === safeChannel || user.email.toLowerCase() === safeChannel.toLowerCase());

            // Increment View Immediately (Only if not own video)
            if (!isSelf && user) {
                fetch('/api/video/view', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        video_id: safeId,
                        email: user.email  // ✅ UNIQUE VIEW TRACKING
                    })
                }).catch(e => console.error("View increment failed:", e));
            }

            const playerOverlay = document.createElement('div');
            playerOverlay.id = 'video-modal';
            playerOverlay.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                background: rgba(0,0,0,0.9); z-index: 5000;
                display: flex; justify-content: center; overflow-y: auto; padding: 20px 0;
            `;

            const timeAgo = timestamp ? new Date(timestamp).toLocaleDateString() : 'Just now';
            const displayDesc = safeDesc;

            playerOverlay.innerHTML = `
                <div id="modal-container" style="width: 95%; max-width: 1400px; position: relative; background: rgba(10,10,10,0.85); min-height: 90vh; border-radius: 24px; border: 1px solid rgba(255,255,255,0.08); backdrop-filter: blur(40px); display: flex; flex-direction: row; overflow: hidden; animation: scale-in 0.5s cubic-bezier(0.165, 0.84, 0.44, 1); box-shadow: 0 50px 100px rgba(0,0,0,0.8);">
                    
                    <style>
                        @media (max-width: 1100px) {
                            #modal-container { flex-direction: column !important; width: 100% !important; border-radius: 0 !important; height: 100vh !important; }
                            #side-panel { width: 100% !important; border-left: none !important; border-top: 1px solid rgba(255,255,255,0.1) !important; }
                        }
                    </style>
                    
                    <!-- Close Button -->
                    <button onclick="document.getElementById('video-modal').remove()" 
                            style="position: absolute; top: 15px; right: 15px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); color: white; width: 40px; height: 40px; border-radius: 50%; font-size: 1.2rem; cursor: pointer; z-index: 100; transition: all 0.3s;">&times;</button>
                    
                    <!-- Left: Main Video & Info -->
                    <div style="flex: 1; min-width: 0; padding: 25px; overflow-y: auto;">
                        <div style="width: 100%; aspect-ratio: 16/9; background: #000; border-radius: 20px; overflow: hidden; box-shadow: 0 10px 40px rgba(0,0,0,0.5); border: 1px solid rgba(255,255,255,0.05);">
                            <video src="${url}" controls autoplay style="width: 100%; height: 100%; object-fit: contain;"></video>
                        </div>

                        <div style="margin-top: 24px;">
                            <h1 style="font-size: 1.25rem; font-weight: 700; margin: 0 0 12px 0; line-height: 1.4; color: #fff;">${safeTitle}</h1>
                            
                            <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px;">
                                <div style="display: flex; align-items: center; gap: 14px;">
                                    <div style="width: 40px; height: 40px; border-radius: 50%; background: #333; display: flex; align-items: center; justify-content: center; font-weight: 600; color: white; border: 1px solid rgba(255,255,255,0.1); font-size: 1.1rem;">
                                        ${safeChannel.charAt(0).toUpperCase()}
                                    </div>
                                    <div>
                                        <div style="font-weight: 600; font-size: 1rem; display: flex; align-items: center; gap: 4px;">
                                            ${safeChannel.split('@')[0]} <i class="fas fa-check-circle" style="color: #aaa; font-size: 0.85rem;"></i>
                                        </div>
                                        <div style="font-size: 0.8rem; color: #aaa;" id="sub-count">1.2M Squad members</div>
                                    </div>
                                    ${isSelf ? '' : `
                                    <button id="sub-btn" onclick="toggleSubscribe('${safeChannel}', ${safeId})" 
                                        style="background: #fff; color: #000; border: none; padding: 10px 20px; border-radius: 20px; font-weight: 600; cursor: pointer; margin-left: 10px; transition: all 0.2s; font-size: 0.9rem;">
                                        Join Squad
                                    </button>
                                    `}
                                </div>

                                <div style="display: flex; gap: 10px;">
                                    <div style="background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.08); border-radius: 30px; display: flex; overflow: hidden; backdrop-filter: blur(10px);">
                                        <button class="action-btn" id="like-btn" onclick="toggleLike(${safeId}, '${safeChannel}')" style="padding: 10px 18px; color: #fff; background: transparent; border: none; cursor: pointer; transition: all 0.2s;"><i class="fas fa-thumbs-up" style="margin-right: 8px;"></i> <span id="like-count">0</span></button>
                                        <div style="width: 1px; background: rgba(255,255,255,0.1); margin: 8px 0;"></div>
                                        <button class="action-btn" style="padding: 10px 18px; color: #fff; background: transparent; border: none; cursor: pointer; transition: all 0.2s;"><i class="fas fa-thumbs-down"></i></button>
                                    </div>
                                    <button class="action-btn secondary" style="background: rgba(255,255,255,0.1); border: none; color: #fff; padding: 10px 20px; border-radius: 20px; font-weight: 600; cursor: pointer; transition: 0.2s; display: flex; align-items: center; gap: 8px; font-size: 0.9rem;">
                                        <i class="fas fa-share"></i> Share
                                    </button>
                                </div>
                            </div>

                                <div style="background: rgba(255,255,255,0.04); border: 1px solid rgba(255,255,255,0.05); border-radius: 16px; padding: 16px; margin-top: 24px; font-size: 0.95rem;">
                                    <div style="font-weight: 800; margin-bottom: 10px; color: #fff;"><span id="view-count">${initialViews}</span> views • Published on ${timeAgo}</div>
                                    <p style="color: #ddd; margin: 0; white-space: pre-wrap; line-height: 1.6;">${displayDesc}</p>
                                </div>

                                <!-- Comments Section -->
                                <div style="margin-top: 32px;">
                                    <h3 style="font-size: 1.1rem; font-weight: 800; margin-bottom: 20px;"><span id="comment-total">0</span> Comments</h3>
                                    
                                    <div style="display: flex; gap: 15px; margin-bottom: 30px;">
                                        <div style="width: 36px; height: 36px; border-radius: 50%; background: #333; flex-shrink: 0; display: flex; align-items: center; justify-content: center; font-weight: 600; color: white; border: 1px solid rgba(255,255,255,0.1);">
                                            ${user ? user.name.charAt(0).toUpperCase() : '?'}
                                        </div>
                                        <div style="flex: 1;">
                                            <input type="text" id="comment-input" placeholder="Add a comment..." 
                                                style="width: 100%; background: transparent; border: none; border-bottom: 1px solid rgba(255,255,255,0.2); color: white; padding: 8px 0; font-size: 0.95rem; outline: none; transition: border-bottom 0.3s;">
                                            <div id="comment-actions" style="display: none; justify-content: flex-end; gap: 12px; margin-top: 10px;">
                                                <button onclick="document.getElementById('comment-input').value=''; document.getElementById('comment-actions').style.display='none';" 
                                                    style="background:transparent; border:none; color:#aaa; font-weight:600; cursor:pointer;">Cancel</button>
                                                <button onclick="submitComment(${videoId})" id="submit-comment-btn" 
                                                    style="background: #3ea6ff; border:none; color:#000; padding: 10px 24px; border-radius: 20px; font-weight:600; cursor:pointer; opacity:0.5; transition: 0.2s;" disabled>Comment</button>
                                            </div>
                                        </div>
                                    </div>

                                    <div id="comments-box" style="display: flex; flex-direction: column; gap: 24px;">
                                        <!-- Comments dynamic -->
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Right: Recommendations Section -->
                        <div id="side-panel" style="width: 400px; border-left: 1px solid rgba(255,255,255,0.08); background: rgba(0,0,0,0.2); display: flex; flex-direction: column; padding: 25px;">
                            <div style="display: flex; gap: 8px; overflow-x: auto; margin-bottom: 20px; padding-bottom: 10px;" class="pill-filters">
                                <span class="pill active">All</span>
                                <span class="pill">Related</span>
                                <span class="pill">Recently uploaded</span>
                            </div>
                            <style>
                                .pill { background: rgba(255,255,255,0.05); padding: 8px 16px; border-radius: 8px; font-size: 0.85rem; font-weight: 600; cursor: pointer; white-space: nowrap; transition: 0.2s; }
                                .pill.active { background: #fff; color: #000; }
                                .pill:hover:not(.active) { background: rgba(255,255,255,0.1); }
                            </style>
                            <div id="related-videos" style="flex: 1; overflow-y: auto; display: flex; flex-direction: column; gap: 15px;">
                                <!-- Dynamically loaded -->
                            </div>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(playerOverlay);
            document.body.style.overflow = 'hidden';

            // Add simple logic to fill recommendations for visual flair
            const relatedGrid = document.getElementById('related-videos');
            fetch('/api/videos')
                .then(r => r.json())
                .then(vids => {
                    relatedGrid.innerHTML = '';
                    vids.filter(v => v.id != videoId).slice(0, 10).forEach(v => {
                        const item = document.createElement('div');
                        item.style.cssText = `
                            display: flex; gap: 12px; cursor: pointer; transition: all 0.3s;
                            padding: 8px; border-radius: 12px;
                        `;
                        item.innerHTML = `
                            <div style="width: 140px; height: 80px; flex-shrink: 0; border-radius: 8px; overflow: hidden; background: #222; border: 1px solid rgba(255,255,255,0.05);">
                                <video src="${v.video_url}" muted style="width: 100%; height: 100%; object-fit: cover;"></video>
                            </div>
                            <div style="flex: 1; min-width: 0;">
                                <div style="font-weight: 700; font-size: 0.9rem; line-height: 1.2; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; color: #fff;">${v.title}</div>
                                <div style="font-size: 0.75rem; color: #aaa; margin-top: 4px;">${v.user_email.split('@')[0]}</div>
                                <div style="font-size: 0.75rem; color: #888;">${v.views} views</div>
                            </div>
                        `;
                        item.onmouseover = () => {
                            item.style.background = 'rgba(255,255,255,0.05)';
                            item.querySelector('video').play();
                        };
                        item.onmouseout = () => {
                            item.style.background = 'transparent';
                            item.querySelector('video').pause();
                        };
                        item.onclick = () => {
                            document.getElementById('video-modal').remove();
                            playVideo(v.video_url, v.title, v.user_email, v.views, v.timestamp, v.description, v.id);
                        };
                        relatedGrid.appendChild(item);
                    });
                });
            // Setup Comment Input Logic
            const commentInput = document.getElementById('comment-input');
            const commentActions = document.getElementById('comment-actions');
            const submitBtn = document.getElementById('submit-comment-btn');

            commentInput.onfocus = () => commentActions.style.display = 'flex';
            commentInput.oninput = () => {
                submitBtn.disabled = !commentInput.value.trim();
                submitBtn.style.opacity = commentInput.value.trim() ? '1' : '0.5';
            };

            // Load Real Engagement Stats
            loadEngagementStats(safeId, safeChannel);
            loadComments(safeId);

            const originalRemove = playerOverlay.remove.bind(playerOverlay);
            playerOverlay.remove = function () {
                document.body.style.overflow = '';
                originalRemove();
                loadVideos(); // Refresh home grid views
            };
        }

        async function loadEngagementStats(videoId, channelEmail) {
            const user = JSON.parse(localStorage.getItem('vitox_user'));
            try {
                const res = await fetch(`/api/video/stats/${videoId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email: user ? user.email : '' })
                });
                const stats = await res.json();

                document.getElementById('view-count').innerText = stats.views.toLocaleString();
                document.getElementById('like-count').innerText = stats.likes.toLocaleString();
                document.getElementById('sub-count').innerText = `${stats.subscribers} Squad members`;
                document.getElementById('comment-total').innerText = stats.comment_count.toLocaleString();

                const likeBtn = document.getElementById('like-btn');
                if (stats.liked) likeBtn.style.color = '#ff003c';

                const subBtn = document.getElementById('sub-btn');
                if (subBtn) {
                    subBtn.innerHTML = stats.subbed ? 'In Squad' : 'Join Squad';
                    subBtn.style.background = stats.subbed ? 'rgba(255,255,255,0.1)' : '#fff';
                    subBtn.style.color = stats.subbed ? '#fff' : '#000';
                    subBtn.style.border = stats.subbed ? '1px solid rgba(255,255,255,0.1)' : 'none';
                }
            } catch (e) { console.error(e); }
        }

        async function loadComments(videoId) {
            try {
                const res = await fetch(`/api/video/comments/${videoId}`);
                const comments = await res.json();
                const box = document.getElementById('comments-box');
                box.innerHTML = '';

                comments.forEach(c => {
                    const el = document.createElement('div');
                    el.style.display = 'flex';
                    el.style.gap = '15px';
                    el.style.animation = 'fade-up 0.5s cubic-bezier(0.165, 0.84, 0.44, 1) forwards';
                    el.style.opacity = '0';
                    el.innerHTML = `
                        <div style="width: 40px; height: 40px; border-radius: 50%; background: #333; display: flex; items-center justify-content: center; font-weight: 800; font-size: 0.9rem;">
                            ${c.user_email.charAt(0).toUpperCase()}
                        </div>
                        <div>
                            <div style="font-size: 0.85rem; margin-bottom: 4px;">
                                <span style="font-weight: 800;">@${c.user_email.split('@')[0]}</span>
                                <span style="color: #aaa; margin-left: 8px;">${new Date(c.timestamp).toLocaleDateString()}</span>
                            </div>
                            <div style="font-size: 0.95rem; line-height: 1.4; color: #eee;">${c.content}</div>
                            <div style="display: flex; gap: 16px; margin-top: 8px; color: #aaa; font-size: 0.8rem;">
                                <span><i class="far fa-thumbs-up"></i></span>
                                <span><i class="far fa-thumbs-down"></i></span>
                                <span style="font-weight: 700; color: #fff; cursor: pointer;">REPLY</span>
                            </div>
                        </div>
                    `;
                    box.appendChild(el);
                });
            } catch (e) { console.error(e); }
        }

        async function submitComment(videoId) {
            const user = JSON.parse(localStorage.getItem('vitox_user'));
            const input = document.getElementById('comment-input');
            const content = input.value.trim();
            if (!user) { alert("Login to comment!"); return; }
            if (!content) return;

            try {
                await fetch('/api/video/comment', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ video_id: videoId, email: user.email, content: content })
                });
                input.value = '';
                document.getElementById('comment-actions').style.display = 'none';
                loadComments(videoId);
                // Increment visual total
                const total = document.getElementById('comment-total');
                total.innerText = (parseInt(total.innerText.replace(/,/g, '')) + 1).toLocaleString();
            } catch (e) { console.error(e); }
        }

        // Toast Engine
        function showToast(msg) {
            let container = document.getElementById('toast-container');
            if (!container) {
                container = document.createElement('div');
                container.id = 'toast-container';
                document.body.appendChild(container);
            }
            const t = document.createElement('div');
            t.className = 'toast';
            t.innerText = msg;
            container.appendChild(t);
            setTimeout(() => t.remove(), 3000);
        }

        async function toggleLike(videoId, channelEmail) {
            const user = JSON.parse(localStorage.getItem('vitox_user'));
            if (!user) { showToast("Please login to like!"); return; }

            const btn = document.getElementById('like-btn');
            btn.classList.add('pulse-active');
            setTimeout(() => btn.classList.remove('pulse-active'), 300);

            try {
                const res = await fetch('/api/video/like', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ video_id: videoId, email: user.email })
                });
                const data = await res.json();
                showToast(data.status === 'liked' ? "Video Liked!" : "Like Removed");
                loadEngagementStats(videoId, channelEmail);
            } catch (e) { console.error(e); }
        }

        async function toggleSubscribe(channelEmail, videoId) {
            const user = JSON.parse(localStorage.getItem('vitox_user'));
            if (!user) { showToast("Please login to join the Squad!"); return; }

            const btn = document.getElementById('sub-btn');
            btn.classList.add('pulse-active');
            setTimeout(() => btn.classList.remove('pulse-active'), 300);

            try {
                const res = await fetch('/api/channel/subscribe', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ subscriber: user.email, channel: channelEmail })
                });
                const data = await res.json();
                showToast(data.status === 'subscribed' ? "Added to Squad!" : "Left the Squad");
                loadEngagementStats(videoId, channelEmail);
            } catch (e) { console.error(e); }
        }

        // Logic for Category Filtering
        function filterByCategory(cat) {
            const cards = document.querySelectorAll('.video-card');
            const chips = document.querySelectorAll('.chip');
            chips.forEach(c => c.classList.remove('active'));
            if (event) event.target.classList.add('active');

            if (cat === 'All') {
                cards.forEach(c => c.style.display = 'block');
                return;
            }

            cards.forEach(card => {
                const title = card.querySelector('.video-title').innerText.toLowerCase();
                const fits = title.includes(cat.toLowerCase());
                card.style.display = fits ? 'block' : 'none';
            });
        }

        // Mobile Search Toggle
        function toggleMobileSearch() {
            const searchBar = document.getElementById('search-bar-container');
            const backBtn = document.querySelector('.mobile-back-btn');

            searchBar.classList.toggle('mobile-active');

            if (searchBar.classList.contains('mobile-active')) {
                backBtn.style.display = 'flex';
                document.getElementById('search-input').focus();
            } else {
                backBtn.style.display = 'none';
            }
        }

        // Mobile Search Toggle Logic is handled by toggleMobileSearch above


        async function handleCredentialResponse(response) {
            const base64Url = response.credential.split('.')[1];
            const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
            const payload = JSON.parse(window.atob(base64));

            console.log("Syncing with Full Stack Backend...");

            // Sync with Python Backend
            try {
                const res = await fetch('/api/user', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        email: payload.email,
                        name: payload.name,
                        picture: payload.picture
                    })
                });

                const dbUser = await res.json();

                // Save complete backend user profile
                localStorage.setItem('vitox_user', JSON.stringify(dbUser));

                updateLoginUI(dbUser);
                alert(`Welcome back, ${dbUser.name}!`);
            } catch (error) {
                console.error("Backend Sync Failed:", error);
                // Fallback to local only if server is down
                localStorage.setItem('vitox_user', JSON.stringify(payload));
                updateLoginUI(payload);
            }
        }

        function updateLoginUI(user) {
            if (user) {
                console.log("Updating UI for:", user.name);
                const loginContainer = document.getElementById('login-container');
                const avatar = document.getElementById('user-avatar');

                if (loginContainer) loginContainer.style.display = 'none';

                if (avatar) {
                    avatar.textContent = user.name.charAt(0).toUpperCase();
                    // Remove Mavo property temporarily to prevent overwrite
                    avatar.removeAttribute('property');

                    if (user.picture) {
                        avatar.style.backgroundImage = `url(${user.picture})`;
                        avatar.style.backgroundSize = 'cover';
                        avatar.style.backgroundPosition = 'center';
                        avatar.style.color = 'transparent';
                    }

                    // Show Admin Button if authorized
                    if (user.email === 'junaidshah78634@gmail.com') {
                        const headerRight = document.querySelector('.header-right');
                        if (!document.getElementById('admin-link-btn')) {
                            const adminBtn = document.createElement('button');
                            adminBtn.id = 'admin-link-btn';
                            adminBtn.className = 'btn-text';
                            adminBtn.innerHTML = '<i class="fas fa-shield-halved"></i> Admin';
                            adminBtn.onclick = () => location.href = 'admin.html';
                            adminBtn.style.color = '#ff4d4d';
                            headerRight.insertBefore(adminBtn, headerRight.firstChild);
                        }
                    }
                }
            }
        }

        // Check if user is already logged in on page load
        window.addEventListener('load', () => {
            const savedUser = localStorage.getItem('vitox_user');
            if (savedUser) {
                updateLoginUI(JSON.parse(savedUser));
            }

            // Load real videos from DB
            loadVideos();

            // Category Chip Interaction
            const chips = document.querySelectorAll('.chip');
            chips.forEach(chip => {
                chip.onclick = () => {
                    chips.forEach(c => c.classList.remove('active'));
                    chip.classList.add('active');
                };
            });
        });

        function toggleUserMenu() {
            const menu = document.getElementById('user-menu');
            const createMenu = document.getElementById('create-dropdown');
            if (createMenu) createMenu.style.display = 'none';
            menu.style.display = menu.style.display === 'block' ? 'none' : 'block';
        }

        function toggleCreateMenu() {
            const createMenu = document.getElementById('create-dropdown');
            const userMenu = document.getElementById('user-menu');
            if (userMenu) userMenu.style.display = 'none';
            createMenu.style.display = createMenu.style.display === 'block' ? 'none' : 'block';
        }

        // Close menus on outside click
        window.addEventListener('click', (e) => {
            const userMenu = document.getElementById('user-menu');
            const createMenu = document.getElementById('create-dropdown');

            if (userMenu && !e.target.closest('.user-avatar') && !e.target.closest('#user-menu')) {
                userMenu.style.display = 'none';
            }
            if (createMenu && !e.target.closest('.create-container')) {
                createMenu.style.display = 'none';
            }
        });

        function logout() {
            localStorage.removeItem('vitox_user');
            location.reload();
        }

        // Privacy & Terms Modal
        function showPagesModal() {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; right: 0; bottom: 0;
                background: rgba(0,0,0,0.8); z-index: 5000;
                display: flex; align-items: center; justify-content: center;
                backdrop-filter: blur(5px);
            `;

            modal.innerHTML = `
                <div style="background: #1e1e1e; width: 90%; max-width: 600px; max-height: 80vh; border-radius: 16px; overflow-y: auto; padding: 24px; position: relative; border: 1px solid rgba(255,255,255,0.1);">
                    <button onclick="this.closest('div').parentNode.remove()" style="position: absolute; top: 16px; right: 16px; background: none; border: none; color: white; font-size: 1.5rem;"><i class="fas fa-times"></i></button>
                    
                    <h2 style="margin-top: 0; display: flex; align-items: center; gap: 10px;">
                        <i class="fas fa-shield-halved" style="color: #ff0055;"></i> Privacy & Terms
                    </h2>
                    
                    <div style="margin-top: 20px; line-height: 1.6; color: #ccc; font-size: 0.95rem;">
                        <h3 style="color: white; margin-bottom: 8px;">1. Privacy Policy</h3>
                        <p>At Vitox, we prioritize your data privacy. We collect minimal data (email, name, picture) solely for authentication via Google. We do not sell your personal data to third parties.</p>
                        
                        <h3 style="color: white; margin: 20px 0 8px;">2. Content Policy</h3>
                        <p>Users are responsible for the content they upload. <strong>Strictly prohibited:</strong> Nudity, hate speech, violence, and copyright infringement.</p>
                        
                        <h3 style="color: white; margin: 20px 0 8px;">3. Monetization (1050 Rule)</h3>
                        <p>Creators are eligible for monetization after reaching 1,000 subscribers and 50,000 views. Revenue is shared 70/30 (Creator/Platform).</p>

                        <h3 style="color: white; margin: 20px 0 8px;">4. User Data & Deletion</h3>
                        <p>You can request full data deletion by contacting <a href="mailto:support@vitox.ai" style="color: #ff0055;">support@vitox.ai</a> or using the 'Delete Account' option in settings.</p>
                        
                        <div style="margin-top: 30px; padding: 16px; background: rgba(255,255,255,0.05); border-radius: 8px; font-size: 0.85rem;">
                            <strong>Contact Us:</strong><br>
                            Vitox Media Pvt Ltd.<br>
                            Email: contact@vitox.ai
                        </div>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);
        }
    </script>
</body>

</html>