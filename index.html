<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vitox | The Next-Gen Indian Video Platform for Creators</title>
    <!-- SEO Meta Tags -->
    <meta name="description" content="Vitox is India's rising video platform where small creators get real visibility. Join the Vitox Squad, upload unique content, and monetize your passion.">
    <meta name="keywords" content="Vitox, Indian video platform, YouTube alternative India, Creator monetization, Video sharing India, Social media for creators">
    <meta name="author" content="Junaid Shah">
    <link rel="canonical" href="https://creatorstudio.pro/" />

    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://creatorstudio.pro/">
    <meta property="og:title" content="Vitox | The Next-Gen Indian Video Platform for Creators">
    <meta property="og:description" content="Small creators, big visibility. Join Vitox today and start your journey as a verified Indian creator.">
    <meta property="og:image" content="https://creatorstudio.pro/assets/branding_banner.jpg">

    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:url" content="https://creatorstudio.pro/">
    <meta property="twitter:title" content="Vitox | The Next-Gen Indian Video Platform">
    <meta property="twitter:description" content="Small creators, big visibility. Join Vitox today!">
    <meta property="twitter:image" content="https://creatorstudio.pro/assets/branding_banner.jpg">

    <!-- Vitox V Favicon -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'><path fill='%23ff0055' d='M32 62 L4 12 L18 12 L32 40 L46 12 L60 12 Z'/></svg>">
    
    <!-- External Libraries -->
    <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">
    <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
    <link rel="stylesheet" href="style.css?v=20.0">
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-7142476355791158" crossorigin="anonymous"></script>
    <!-- Google Analytics GA4 -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-3TK6X8XJ2D"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-3TK6X8XJ2D');
    </script>
    <!-- Video.js and Google IMA SDK -->
    <link href="https://vjs.zencdn.net/8.10.0/video-js.css" rel="stylesheet" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/videojs-ima/2.1.0/videojs.ima.css" rel="stylesheet" />
    <script src="https://vjs.zencdn.net/8.10.0/video.min.js"></script>
    <script src="https://imasdk.googleapis.com/js/sdkloader/ima3.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/videojs-contrib-ads/7.0.0/videojs-contrib-ads.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/videojs-ima/2.1.0/videojs.ima.min.js"></script>
    <!-- Razorpay Checkout -->
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
</head>

<body class="dark-theme">
    <!-- Global Platform AdSense (Revenue for Vitox Owner) -->
    <!-- Note: Creators use their own IDs for video-specific ads via the Link AdSense feature -->

    <!-- Top Bar -->
    <header class="top-bar">
        <div class="header-left">
            <button class="icon-btn menu-btn" onclick="document.querySelector('.sidebar').classList.toggle('active')"><i
                    class="fas fa-bars"></i></button>
            <div class="logo">
                <!-- Vitox 'V' Logo -->
                <svg width="32" height="32" viewBox="0 0 64 64" style="margin-right: 8px;">
                    <defs>
                        <linearGradient id="vGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                            <stop offset="0%" style="stop-color:#ff0055;stop-opacity:1" />
                            <stop offset="100%" style="stop-color:#ff5500;stop-opacity:1" />
                        </linearGradient>
                    </defs>
                    <path fill="url(#vGradient)" d="M32 62 L4 12 L18 12 L32 40 L46 12 L60 12 Z" />
                </svg>
                <span class="logo-text">Vitox</span>
                <div id="streak-indicator" style="display: none; align-items: center; gap: 4px; background: rgba(255,165,0,0.1); padding: 4px 10px; border-radius: 20px; border: 1px solid rgba(255,165,0,0.3); margin-left: 12px; height: 26px;">
                    <i class="fas fa-fire" style="color: #ffa500; font-size: 0.8rem;"></i>
                    <span id="streak-count" style="color: #ffa500; font-size: 0.8rem; font-weight: 800;">1 Day Streak</span>
                </div>
            </div>
        </div>

        <div class="header-center" id="search-bar-container">
            <button class="icon-btn mobile-back-btn" onclick="toggleMobileSearch()"
                style="display: none; margin-right: 8px;"><i class="fas fa-arrow-left"></i></button>
            <div class="search-container">
                <div class="search-box">
                    <input type="text" id="search-input" placeholder="Search">
                    <button class="search-btn" id="ai-search-btn" onclick="performAISearch()" title="Smart AI Search" style="background: transparent; border-left: 1px solid #333; border-radius: 0; margin-left: -40px; color: #ff0055; width: 40px; height: 36px; display: flex; align-items: center; justify-content: center; z-index: 5; border:none;">
                        <i class="fas fa-sparkles"></i>
                    </button>
                    <button class="search-btn" onclick="performSearch()" style="margin-left: 0;"><i class="fas fa-search"></i></button>
                </div>
                <button class="icon-btn mic-btn" onclick="startVoiceSearch()"><i class="fas fa-microphone"></i></button>
            </div>
        </div>

        <div class="header-right">
            <button class="icon-btn mobile-search-trigger" onclick="toggleMobileSearch()"><i
                    class="fas fa-search"></i></button>
            <!-- Create Menu -->
            <div class="create-container">
                <button class="create-btn" id="create-btn" onclick="toggleCreateMenu()">
                    <i class="fas fa-plus"></i> <span>Create</span>
                </button>
                <div class="create-dropdown" id="create-dropdown">
                    <a href="upload.html?v=8.0"><i class="fas fa-upload"></i> Upload video</a>
                    <a href="#" onclick="openGoLiveModal(); return false;"><i class="fas fa-tower-broadcast"></i> Vitox Broadcast</a>
                    <a href="#"
                        onclick="document.getElementById('create-post-modal').style.display='flex'; toggleCreateMenu(); return false;"><i
                            class="fas fa-pen-to-square"></i> Create post</a>
                </div>
            </div>

            <button class="icon-btn" onclick="location.href='dashboard_overview.html'" title="Creator Studio">
                <i class="fas fa-clapperboard"></i>
            </button>
            <div id="login-container">
                <div id="g_id_onload"
                    data-client_id="392918089798-sqv6ro56e2lkdhu8jmh0j7mb1ka3lhbj.apps.googleusercontent.com"
                    data-context="signin" data-ux_mode="popup" data-callback="handleCredentialResponse"
                    data-auto_prompt="false">
                </div>
                <div class="g_id_signin" data-type="standard" data-shape="pill" data-theme="outline"
                    data-text="signin_with" data-size="medium" data-logo_alignment="left">
                </div>
            </div>
            <button class="icon-btn" onclick="toggleNotifications()" title="Notifications"><i
                    class="fas fa-bell"></i></button>
            <div class="user-avatar" id="user-avatar" onclick="toggleUserMenu()" title="Account Options">?</div>

            <!-- Hidden User Menu -->
            <div id="user-menu" class="dropdown-menu">
                <div class="user-info-header" id="menu-user-info"
                    style="display:none; padding: 12px; border-bottom: 1px solid var(--border);">
                    <div id="menu-user-name" style="font-weight: 600;">User</div>
                </div>
                <a href="dashboard_overview.html"><i class="fas fa-user-circle"></i> View Channel</a>
                <a href="#" onclick="logout()"><i class="fas fa-sign-out-alt"></i> Logout</a>
            </div>
            </div>
        </div>
    </header>

    <!-- Push Notification Toast -->
    <div id="push-notif-bar" style="display:none; position:fixed; bottom:24px; left:50%; transform:translateX(-50%); background:#1a1a1a; border:1px solid rgba(255,0,85,0.4); border-radius:20px; padding:16px 24px; z-index:200001; box-shadow:0 10px 40px rgba(0,0,0,0.5); display:none; align-items:center; gap:16px; min-width:320px; max-width:480px;">
        <div style="width:40px; height:40px; background:#ff0055; border-radius:50%; display:flex; align-items:center; justify-content:center; flex-shrink:0;">
            <i class="fas fa-bell" style="color:white;"></i>
        </div>
        <div style="flex:1;">
            <div id="push-notif-title" style="font-weight:800; color:white; font-size:0.9rem;">New on Vitox</div>
            <div id="push-notif-body" style="color:#888; font-size:0.8rem; margin-top:2px;">Check out what's trending!</div>
        </div>
        <button onclick="document.getElementById('push-notif-bar').style.display='none'" style="background:none;border:none;color:#555;font-size:1.2rem;cursor:pointer;">&times;</button>
    </div>

    <div class="main-layout">
        <!-- Sidebar -->
        <aside class="sidebar">
            <nav class="sidebar-nav">
                <!-- Main -->
                <a href="#" class="nav-item active" onclick="loadVideos(); return false;"><i class="fas fa-home"></i>
                    <span>Feed</span></a>
                <a href="#" class="nav-item" onclick="filterByCategory('Live'); return false;"><i
                        class="fas fa-tower-broadcast" style="color:#ff0055;"></i>
                    <span>Pulse</span></a>
                <a href="#" class="nav-item" onclick="loadSnapsView(); return false;"><i class="fas fa-play-circle"></i>
                    <span>V-Snaps</span></a>
                <a href="#" class="nav-item" onclick="loadView('Squad'); return false;"><i
                        class="fas fa-layer-group"></i> <span>Squad</span></a>
                <a href="#" class="nav-item" onclick="showPricing(); return false;" style="background: linear-gradient(45deg, #121212, #252525); border: 1px solid #ffd700; margin: 12px 8px; border-radius: 12px; padding: 12px 16px; display: flex; align-items: center; gap: 12px;">
                    <i class="fas fa-gem" style="color: #ffd700;"></i> <span style="color: #ffd700; font-weight: 700;">Join Premium</span></a>
                <div style="height: 8px;"></div>
                <hr>
                <a href="#" class="nav-item" onclick="loadView('Trending'); return false;">
                    <i class="fas fa-fire" style="color: #ff5500;"></i>
                    <span>Trending</span>
                </a>
                <a href="#" class="nav-item" onclick="loadLeaderboardView(); return false;">
                    <i class="fas fa-trophy" style="color: #ffd700;"></i>
                    <span>Leaderboard</span>
                </a>
                <a href="#" class="nav-item" onclick="loadForYouView(); return false;">
                    <i class="fas fa-wand-magic-sparkles" style="color: #7000ff;"></i>
                    <span>For You</span>
                </a>
                <hr>
                <a href="rules.html" class="nav-item">
                    <i class="fas fa-book-open" style="color: #ff0055;"></i>
                    <span style="font-weight: 600;">Vitox Rule Book</span>
                </a>

                <!-- You Section -->
                <div class="nav-section-title"
                    style="padding: 8px 12px; font-weight: 600; font-size: 1rem; color: var(--text-primary); display: flex; align-items: center; gap: 6px;">
                    You <i class="fas fa-chevron-right" style="font-size: 0.8rem;"></i>
                </div>

                <a href="#" class="nav-item" onclick="loadView('Rewind'); return false;"><i class="fas fa-history"></i>
                    <span>Rewind</span></a>
                <a href="#" class="nav-item" onclick="loadView('Collections'); return false;"><i
                        class="fas fa-list"></i>
                    <span>Collections</span></a>
                <a href="#" class="nav-item" onclick="loadView('Bookmarks'); return false;"><i class="fas fa-clock"></i>
                    <span>Bookmarks</span></a>
                <a href="#" class="nav-item" onclick="loadLikedVideosView(); return false;"><i
                        class="fas fa-thumbs-up"></i> <span>Favorites</span></a>
                <a href="#" class="nav-item" onclick="loadView('Broadcast Studio'); return false;"><i
                        class="fas fa-video"></i> <span>Creator Hub</span></a>
                <a href="#" class="nav-item" onclick="loadView('Vault'); return false;"><i class="fas fa-download"></i>
                    <span>Vault</span></a>
                <hr>

                <!-- AI Studio Section -->
                <div class="nav-section-title"
                    style="padding: 8px 12px; font-weight: 600; font-size: 1rem; color: var(--text-primary); display: flex; align-items: center; gap: 6px;">
                    AI Studio <i class="fas fa-wand-sparkles" style="font-size: 0.8rem; color: #ff0055;"></i>
                </div>
                <a href="#" class="nav-item" onclick="loadView('AI Logo Generator'); return false;"><i class="fas fa-compass-drafting"></i> <span>AI Logo Gen</span></a>
                <a href="#" class="nav-item" onclick="loadView('AI Thumbnail Generator'); return false;"><i class="fas fa-image"></i> <span>Thumbnail Gen</span></a>
                <a href="#" class="nav-item" onclick="loadView('AI Image Generator'); return false;"><i class="fas fa-palette"></i> <span>Text to Image</span></a>
                <a href="#" class="nav-item" onclick="loadView('AI Video Generator'); return false;"><i class="fas fa-film"></i> <span>V-Gen (Video)</span></a>
                <hr>
                <a href="#" class="nav-item" onclick="openAdminChat(); return false;" style="color: #ffd700;">
                    <i class="fas fa-crown"></i> <span>Official Support</span></a>
                <a href="#" class="nav-item" onclick="document.getElementById('bug-report-modal').style.display='flex'; return false;" style="color: #ff5500;">
                    <i class="fas fa-bug"></i> <span>Report Bug</span></a>
                <div id="admin-sidebar-link" style="display:none;">
                    <a href="#" class="nav-item" onclick="loadView('Admin Panel'); return false;"
                        style="color: #ff4d4d; border: 1px solid rgba(255,77,77,0.2); margin-top: 5px; background: rgba(255,77,77,0.05);">
                        <i class="fas fa-shield-halved"></i> <span>Admin Panel</span></a>
                </div>
                <hr>
                <div style="padding: 16px 24px; font-size: 0.8rem; line-height: 1.4; color: #aaa; display: flex; flex-direction: column; gap: 12px;">
                    <div style="display: flex; flex-wrap: wrap; gap: 6px 12px;">
                        <a href="about.html" style="color: #aaa; text-decoration: none; font-weight: 600;" onmouseover="this.style.color='white'" onmouseout="this.style.color='#aaa'">About</a>
                        <a href="#" style="color: #aaa; text-decoration: none; font-weight: 600;" onmouseover="this.style.color='white'" onmouseout="this.style.color='#aaa'">Press</a>
                        <a href="#" style="color: #aaa; text-decoration: none; font-weight: 600;" onmouseover="this.style.color='white'" onmouseout="this.style.color='#aaa'">Copyright</a>
                        <a href="contact.html" style="color: #aaa; text-decoration: none; font-weight: 600;" onmouseover="this.style.color='white'" onmouseout="this.style.color='#aaa'">Contact us</a>
                        <a href="#" style="color: #aaa; text-decoration: none; font-weight: 600;" onmouseover="this.style.color='white'" onmouseout="this.style.color='#aaa'">Creators</a>
                        <a href="#" style="color: #aaa; text-decoration: none; font-weight: 600;" onmouseover="this.style.color='white'" onmouseout="this.style.color='#aaa'">Advertise</a>
                        <a href="#" style="color: #aaa; text-decoration: none; font-weight: 600;" onmouseover="this.style.color='white'" onmouseout="this.style.color='#aaa'">Developers</a>
                    </div>
                    <div style="display: flex; flex-wrap: wrap; gap: 6px 12px;">
                        <a href="terms.html" style="color: #aaa; text-decoration: none; font-weight: 600;" onmouseover="this.style.color='white'" onmouseout="this.style.color='#aaa'">Terms</a>
                        <a href="privacy.html" style="color: #aaa; text-decoration: none; font-weight: 600;" onmouseover="this.style.color='white'" onmouseout="this.style.color='#aaa'">Privacy</a>
                        <a href="#" style="color: #aaa; text-decoration: none; font-weight: 600;" onmouseover="this.style.color='white'" onmouseout="this.style.color='#aaa'">Policy & Safety</a>
                        <a href="#" style="color: #aaa; text-decoration: none; font-weight: 600;" onmouseover="this.style.color='white'" onmouseout="this.style.color='#aaa'">How Vitox works</a>
                        <a href="#" style="color: #aaa; text-decoration: none; font-weight: 600;" onmouseover="this.style.color='white'" onmouseout="this.style.color='#aaa'">Test new features</a>
                    </div>
                    <div style="color: #717171; font-weight: 400; font-size: 0.75rem; margin-top: 4px;">Â© 2026 Vitox LLC</div>
                </div>
            </nav>
        </aside>

        <!-- Content Area -->
        <main class="content">
            <!-- Categories -->
            <div class="categories-bar">
                <button class="chip active" onclick="filterByCategory('All')">All</button>
                <button class="chip" onclick="filterByCategory('Drama')" style="color: #ff0055; font-weight: bold; border-color: rgba(255,0,85,0.5);"><i class="fas fa-fire"></i> Spicy Drama</button>
                <button class="chip" onclick="filterByCategory('Music')">Music</button>
                <button class="chip" onclick="filterByCategory('AI')">AI Studio</button>
                <button class="chip" onclick="filterByCategory('Gaming')">Gaming</button>
                <button class="chip" onclick="filterByCategory('Live')">Pulse</button>
                <button class="chip" onclick="filterByCategory('Tech')">Tech</button>
                <button class="chip" onclick="filterByCategory('News')">News</button>
                <button class="chip" onclick="filterByCategory('Comedy')">Comedy</button>
                <button class="chip" onclick="filterByCategory('Education')">Education</button>
            </div>

            <!-- Hook: Gamification, FOMO, Progress Tracking -->
            <div id="retention-hooks-container" style="display: none; animation: scale-in 0.5s cubic-bezier(0.165, 0.84, 0.44, 1); margin-bottom: 24px;">
                <!-- FOMO Banner (Only visible for 24 hours/to specific users) -->
                <div id="fomo-banner" style="background: linear-gradient(90deg, #ff0055, #ff5500); padding: 14px 20px; border-radius: 16px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 4px 15px rgba(255,0,85,0.3); margin-bottom: 16px; cursor: pointer;" onclick="const chip = document.querySelector('.chip[onclick*=\'Drama\']') || document.querySelector('.chip:nth-child(2)'); if(chip) chip.click();">
                    <div style="color: white; font-weight: 800; display: flex; align-items: center; gap: 10px;">
                        <i class="fas fa-fire fa-lg"></i>
                        <span>Trending Drama: Top 5 Clips of the Day</span>
                    </div>
                    <div style="background: rgba(0,0,0,0.3); padding: 6px 14px; border-radius: 20px; font-size: 0.8rem; font-weight: 800; color: white;">Expires in 24h</div>
                </div>

                <!-- Progress/Continue Hook -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                    <!-- Continue Watching -->
                    <div id="continue-watching-card" style="background: #151515; padding: 16px; border-radius: 16px; border: 1px solid rgba(255,255,255,0.05); display: none; cursor: pointer; transition: 0.2s;" onmouseover="this.style.background='#1a1a1a'" onmouseout="this.style.background='#151515'">
                        <h4 style="margin: 0 0 12px 0; font-size: 0.85rem; color: #888; text-transform: uppercase; font-weight: 800;"><i class="fas fa-history" style="color: #ff0055;"></i> Continue where you left off</h4>
                        <div style="display: flex; gap: 12px; align-items: center;">
                            <div style="width: 100px; height: 56px; background: #000; border-radius: 8px; overflow: hidden; position: relative; border: 1px solid rgba(255,255,255,0.1);">
                                <img id="cw-img" src="" style="width: 100%; height: 100%; object-fit: cover;">
                                <div style="position: absolute; bottom: 0; left: 0; height: 3px; background: #ff0055; width: 60%;"></div>
                            </div>
                            <div style="flex: 1; overflow: hidden;">
                                <div id="cw-title" style="font-weight: 700; font-size: 0.95rem; margin-bottom: 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">Video Title</div>
                                <div id="cw-channel" style="color: #666; font-size: 0.8rem;">Channel Name</div>
                            </div>
                        </div>
                    </div>

                    <!-- Gamification Badge -->
                    <div id="gamification-badge" style="background: #151515; padding: 16px; border-radius: 16px; border: 1px solid rgba(255,255,255,0.05); display: flex; align-items: center; gap: 16px;">
                        <div style="width: 56px; height: 56px; background: rgba(255,215,0,0.1); border-radius: 50%; display: flex; align-items: center; justify-content: center; border: 2px solid #ffd700; box-shadow: 0 0 15px rgba(255,215,0,0.2);">
                            <i id="badge-icon" class="fas fa-star" style="color: #ffd700; font-size: 1.5rem;"></i>
                        </div>
                        <div style="flex: 1;">
                            <div id="badge-level" style="font-weight: 800; font-size: 1rem; color: #ffd700;">Novice</div>
                            <div style="color: #aaa; font-size: 0.85rem; margin-top: 4px;">Watch videos to unlock perks!</div>
                            <div style="margin-top: 8px; width: 100%; height: 6px; background: #222; border-radius: 3px; overflow: hidden;">
                                <div id="badge-progress" style="height: 100%; width: 0%; background: #ffd700; border-radius: 3px; transition: 0.4s;"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ðŸ”¥ Trending Section -->
            <div id="trending-strip" style="margin-bottom: 28px;">
                <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:14px;">
                    <h2 style="font-size:1.1rem; font-weight:800; display:flex; align-items:center; gap:8px; margin:0;">
                        <span style="background:linear-gradient(45deg,#ff5500,#ff0055); -webkit-background-clip:text; -webkit-text-fill-color:transparent;"><i class="fas fa-fire"></i> Trending Now</span>
                    </h2>
                    <button onclick="loadView('Trending')" style="font-size:0.8rem; color:#ff0055; background:none; border:none; cursor:pointer; font-weight:700;">See all &rarr;</button>
                </div>
                <div id="trending-chips" style="display:flex; gap:10px; flex-wrap:wrap;"></div>
            </div>

            <!-- âœ¨ For You Section -->
            <div id="for-you-row" style="margin-bottom:28px; display:none;">
                <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:14px;">
                    <h2 style="font-size:1.1rem; font-weight:800; display:flex; align-items:center; gap:8px; margin:0;">
                        <span style="background:linear-gradient(45deg,#7000ff,#ff0055); -webkit-background-clip:text; -webkit-text-fill-color:transparent;"><i class="fas fa-wand-magic-sparkles"></i> Recommended For You</span>
                    </h2>
                    <span style="font-size:0.75rem; color:#555;">Based on your watch history</span>
                </div>
                <div id="for-you-grid" style="display:grid; grid-template-columns:repeat(auto-fill,minmax(200px,1fr)); gap:12px;"></div>
            </div>

            <div class="video-grid" id="main-video-grid">
                <!-- Real videos will be injected here via JavaScript -->
            </div>

            <!-- Empty State if no videos -->
            <div id="empty-state" class="empty-state" style="display: none;">
                <i class="fas fa-video-slash"></i>
                <p>No videos found. Be the first to upload one!</p>
            </div>
        </main>
        <!-- Collab Chat Drawer - Full Featured -->
        <div id="collab-chat-drawer"
            style="position: fixed; top: 0; right: -100%; width: 420px; max-width: 100%; height: 100vh; background: #0d0d0d; z-index: 10001; box-shadow: -20px 0 60px rgba(0,0,0,0.9); transition: right 0.5s cubic-bezier(0.165, 0.84, 0.44, 1); display: flex; flex-direction: column; border-left: 1px solid rgba(255,255,255,0.08);">
            
            <!-- Header -->
            <div style="padding: 0 20px; height: 72px; border-bottom: 1px solid rgba(255,255,255,0.07); display: flex; align-items: center; gap: 14px; background: #111; flex-shrink:0;">
                <button onclick="closeCollabChat()" style="background:none;border:none;color:#666;font-size:1.2rem;cursor:pointer;padding:4px;">
                    <i class="fas fa-arrow-left"></i>
                </button>
                <div id="collab-avatar" style="width:44px;height:44px;background:linear-gradient(135deg,#ff0055,#7000ff);border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:800;font-size:1.1rem;color:white;flex-shrink:0;">?</div>
                <div style="flex:1;">
                    <div id="collab-chat-target" style="font-weight:800;font-size:1rem;">Creator</div>
                    <div id="collab-online-status" style="font-size:0.75rem;color:#00cc66;display:flex;align-items:center;gap:5px;">
                        <span style="width:6px;height:6px;background:#00cc66;border-radius:50%;display:inline-block;"></span> online
                    </div>
                </div>
                <!-- Collab Deal Proposal Button -->
                <button onclick="sendCollabProposal()" style="background:rgba(255,0,85,0.1);border:1px solid rgba(255,0,85,0.3);color:#ff0055;padding:8px 14px;border-radius:20px;cursor:pointer;font-size:0.78rem;font-weight:700;white-space:nowrap;">
                    <i class="fas fa-handshake"></i> Propose Deal
                </button>
            </div>

            <!-- Quick Collab Templates -->
            <div id="collab-templates" style="padding: 12px 16px; border-bottom: 1px solid rgba(255,255,255,0.05); display:flex; gap:8px; overflow-x:auto; flex-shrink:0;">
                <button onclick="insertTemplate('Hey! I love your content. Interested in a collab?')" style="background:#1a1a1a;border:1px solid rgba(255,255,255,0.08);color:#aaa;padding:6px 12px;border-radius:20px;cursor:pointer;font-size:0.74rem;white-space:nowrap;">👋 Say Hi</button>
                <button onclick="insertTemplate('I want to do a collaboration video with you. Let me know your rates!')" style="background:#1a1a1a;border:1px solid rgba(255,255,255,0.08);color:#aaa;padding:6px 12px;border-radius:20px;cursor:pointer;font-size:0.74rem;white-space:nowrap;">🎬 Collab Ask</button>
                <button onclick="insertTemplate('I am interested in sponsoring your channel. What are your sponsorship rates per video?')" style="background:#1a1a1a;border:1px solid rgba(255,255,255,0.08);color:#aaa;padding:6px 12px;border-radius:20px;cursor:pointer;font-size:0.74rem;white-space:nowrap;">💼 Sponsorship</button>
                <button onclick="insertTemplate('Would you be open to a brand deal? I represent [Brand Name].')" style="background:#1a1a1a;border:1px solid rgba(255,255,255,0.08);color:#aaa;padding:6px 12px;border-radius:20px;cursor:pointer;font-size:0.74rem;white-space:nowrap;">🏷️ Brand Deal</button>
            </div>

            <!-- Messages -->
            <div id="collab-messages-content"
                style="flex:1; overflow-y: auto; padding: 20px 16px; display: flex; flex-direction: column; gap: 12px; background: #0d0d0d;">
                <!-- Empty state -->
                <div id="collab-empty" style="text-align:center;margin:auto;">
                    <div style="font-size:3rem;margin-bottom:12px;">🤝</div>
                    <div style="font-weight:800;color:#333;margin-bottom:6px;">Start a Collab Conversation</div>
                    <div style="color:#444;font-size:0.85rem;">Use the quick replies above to break the ice!</div>
                </div>
            </div>

            <!-- Typing indicator -->
            <div id="collab-typing" style="padding:6px 20px;color:#666;font-size:0.75rem;flex-shrink:0;display:none;">
                <i class="fas fa-ellipsis"></i> typing...
            </div>

            <!-- Input Area -->
            <div style="padding: 16px; border-top: 1px solid rgba(255,255,255,0.07); background: #111; flex-shrink:0;">
                <!-- Emoji Quick Bar -->
                <div style="display:flex;gap:8px;margin-bottom:10px;">
                    <span onclick="appendEmoji('🔥')" style="cursor:pointer;font-size:1.2rem;" title="Fire">🔥</span>
                    <span onclick="appendEmoji('💯')" style="cursor:pointer;font-size:1.2rem;">💯</span>
                    <span onclick="appendEmoji('🚀')" style="cursor:pointer;font-size:1.2rem;">🚀</span>
                    <span onclick="appendEmoji('🤝')" style="cursor:pointer;font-size:1.2rem;">🤝</span>
                    <span onclick="appendEmoji('💰')" style="cursor:pointer;font-size:1.2rem;">💰</span>
                    <span onclick="appendEmoji('🎬')" style="cursor:pointer;font-size:1.2rem;">🎬</span>
                    <span onclick="appendEmoji('❤️')" style="cursor:pointer;font-size:1.2rem;">❤️</span>
                    <span onclick="appendEmoji('👑')" style="cursor:pointer;font-size:1.2rem;">👑</span>
                </div>
                <div style="display: flex; gap: 10px; align-items:flex-end;">
                    <textarea id="collab-chat-input" placeholder="Type your message..." rows="1"
                        style="flex:1; background: #1a1a1a; border: 1px solid rgba(255,255,255,0.1); border-radius: 20px; padding: 12px 18px; color: white; outline: none; font-family: inherit; font-size:0.9rem; resize:none; max-height:100px; line-height:1.4;"
                        onkeydown="if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();document.getElementById('collab-chat-send').click();}"
                        oninput="this.style.height='auto';this.style.height=this.scrollHeight+'px';"></textarea>
                    <button id="collab-chat-send"
                        style="background: linear-gradient(135deg,#ff0055,#7000ff); color: white; border: none; width: 46px; height:46px; border-radius: 50%; cursor: pointer; flex-shrink:0; font-size:1rem; transition:0.2s;"
                        onmouseenter="this.style.transform='scale(1.1)'" onmouseleave="this.style.transform='scale(1)'">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- Admin Support Chat Drawer (Alag UI) -->
        <div id="admin-chat-drawer"
            style="position: fixed; top: 0; right: -100%; width: 500px; max-width: 100%; height: 100vh; background: #050505; z-index: 10002; box-shadow: -20px 0 60px rgba(0,0,0,1); transition: right 0.6s cubic-bezier(0.19, 1, 0.22, 1); display: flex; flex-direction: column; border-left: 2px solid #ffd700;">
            <div
                style="padding: 25px; border-bottom: 1px solid rgba(255,215,0,0.2); display: flex; justify-content: space-between; align-items: center; background: linear-gradient(135deg, #111, #000);">
                <div style="display: flex; align-items: center; gap: 15px;">
                    <div
                        style="width: 45px; height: 45px; background: #ffd700; border-radius: 12px; display: flex; align-items: center; justify-content: center; color: black; font-size: 1.2rem; filter: drop-shadow(0 0 10px rgba(255,215,0,0.3));">
                        <i class="fas fa-crown"></i>
                    </div>
                    <div>
                        <h3 style="margin:0; font-weight: 900; color: #ffd700; letter-spacing: 1px;">OFFICIAL SUPPORT
                        </h3>
                        <div id="admin-chat-target" style="font-size: 0.75rem; color: #aaa; text-transform: uppercase;">
                            Direct Line to Admin</div>
                    </div>
                </div>
                <button onclick="closeAdminChat()"
                    style="background:none; border:none; color:white; font-size: 1.5rem; cursor:pointer; opacity: 0.6;">&times;</button>
            </div>
            <div id="admin-messages-content"
                style="flex:1; overflow-y: auto; padding: 25px; display: flex; flex-direction: column; gap: 20px;">
                <!-- Official Messages load here -->
            </div>
            <div style="padding: 25px; border-top: 1px solid rgba(255,215,0,0.1); background: #0a0a0a;">
                <div
                    style="display: flex; gap: 12px; background: #111; padding: 5px; border-radius: 16px; border: 1px solid rgba(255,255,255,0.05);">
                    <input type="text" id="admin-chat-input" placeholder="Type official message..."
                        style="flex:1; background: transparent; border: none; padding: 12px 18px; color: white; outline: none; font-size: 0.95rem;">
                    <button id="admin-chat-send"
                        style="background: #ffd700; color: black; border: none; width: 50px; border-radius: 12px; cursor: pointer; font-weight: 900;">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- Bug Report Modal -->
        <div id="bug-report-modal" style="display:none; position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 200005; align-items: center; justify-content: center; backdrop-filter: blur(8px);">
            <div style="background: #0f0f0f; border: 1px solid rgba(255,85,0,0.3); border-radius: 24px; padding: 32px; width: 90%; max-width: 500px; box-shadow: 0 20px 60px rgba(0,0,0,0.8);">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                    <h2 style="margin:0; font-weight: 800; display:flex; align-items:center; gap:12px;"><i class="fas fa-bug" style="color: #ff5500;"></i> Report a Bug</h2>
                    <button onclick="document.getElementById('bug-report-modal').style.display='none'" style="background:none; border:none; color: #888; font-size: 1.5rem; cursor:pointer;">&times;</button>
                </div>
                <p style="color:#aaa; margin-bottom: 24px; font-size: 0.95rem;">Found a glitch? Let us know so we can squash it!</p>
                <input type="text" id="bug-title" placeholder="Bug Title (e.g., Video won't play)" style="width: 100%; padding: 14px 18px; margin-bottom: 16px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; color: white; font-family: inherit;">
                <textarea id="bug-desc" placeholder="Describe the issue in detail. What were you doing? What happened?" rows="4" style="width: 100%; padding: 14px 18px; margin-bottom: 16px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; color: white; font-family: inherit; resize: vertical;"></textarea>
                
                <div style="margin-bottom: 24px; background: rgba(255,255,255,0.02); padding: 12px; border-radius: 12px; border: 1px dashed rgba(255,255,255,0.1);">
                    <label style="color: #aaa; font-size: 0.9rem; margin-bottom: 8px; display: block;">Screenshot (optional)</label>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <input type="file" id="bug-img-upload" accept="image/*" style="display: none;" onchange="uploadBugScreenshot(this)">
                        <button onclick="document.getElementById('bug-img-upload').click()" style="background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); color: white; padding: 10px 16px; border-radius: 8px; cursor: pointer; font-size: 0.9rem; transition: 0.2s;" onmouseover="this.style.background='rgba(255,255,255,0.1)'" onmouseout="this.style.background='rgba(255,255,255,0.05)'">
                            <i class="fas fa-upload"></i> Upload Image
                        </button>
                        <span id="bug-upload-status" style="font-size: 0.85rem; color: #888;"></span>
                        <input type="hidden" id="bug-img-url" value="">
                    </div>
                </div>

                <button onclick="submitBugReport()" style="width: 100%; padding: 16px; background: linear-gradient(135deg, #ff5500, #ff0055); color: white; border: none; border-radius: 12px; font-weight: 800; font-size: 1.1rem; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px;">
                    <i class="fas fa-paper-plane"></i> Submit Report
                </button>
            </div>
        </div>

        <!-- Notification Drawer -->
        <div id="notification-drawer"
            style="position: fixed; top: 0; right: -100%; width: 400px; max-width: 100%; height: 100vh; background: rgba(10,10,10,0.95); z-index: 10005; box-shadow: -20px 0 60px rgba(0,0,0,1); transition: right 0.6s cubic-bezier(0.19, 1, 0.22, 1); display: flex; flex-direction: column; backdrop-filter: blur(20px); border-left: 1px solid rgba(255,255,255,0.05);">
            <div
                style="padding: 25px; border-bottom: 1px solid rgba(255,255,255,0.05); display: flex; justify-content: space-between; align-items: center;">
                <h3 style="margin:0; font-weight: 800; letter-spacing: -0.5px;">Notifications</h3>
                <button onclick="toggleNotifications()"
                    style="background:none; border:none; color:white; font-size: 1.5rem; cursor:pointer; opacity: 0.6;">&times;</button>
            </div>
            <div id="notification-content"
                style="flex:1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 15px;">
                <!-- System Welcome Notification -->
                <div
                    style="background: rgba(255,0,85,0.05); border: 1px solid rgba(255,0,85,0.1); padding: 16px; border-radius: 16px; display: flex; gap: 12px;">
                    <div
                        style="width: 40px; height: 40px; background: #ff0055; border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                        <i class="fas fa-bolt" style="color: white; font-size: 1rem;"></i>
                    </div>
                    <div>
                        <div style="font-weight: 700; font-size: 0.95rem; margin-bottom: 4px;">System Update: Community
                            V1 Live!</div>
                        <div style="font-size: 0.85rem; color: #aaa; line-height: 1.4;">You can now post updates to your
                            Squad and check the unified feed in the Squad tab.</div>
                        <div style="font-size: 0.75rem; color: #ff0055; margin-top: 8px; font-weight: 700;">NEW FEATURE
                        </div>
                    </div>
                </div>

                <!-- AdSense Monetization Notification -->
                <div
                    style="background: rgba(0,255,136,0.05); border: 1px solid rgba(0,255,136,0.1); padding: 16px; border-radius: 16px; display: flex; gap: 12px;">
                    <div
                        style="width: 40px; height: 40px; background: #00ff88; border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                        <i class="fas fa-dollar-sign" style="color: black; font-size: 1.2rem; font-weight: 900;"></i>
                    </div>
                    <div>
                        <div style="font-weight: 700; font-size: 0.95rem; margin-bottom: 4px; color: #00ff88;">Monetization Unlocked!</div>
                        <div style="font-size: 0.85rem; color: #aaa; line-height: 1.4;">Congratulations! You are now eligible to earn money. Link your Google AdSense account to start earning from your videos.</div>
                        <button onclick="showAdSenseModal()" style="margin-top: 12px; background: #00ff88; color: black; border: none; padding: 6px 16px; border-radius: 8px; font-weight: 700; cursor: pointer; font-size: 0.8rem; box-shadow: 0 4px 15px rgba(0,255,136,0.2); transition: transform 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                            Link AdSense
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Snap Comments Drawer -->
        <div id="snap-comment-backdrop" onclick="closeSnapComments()"
            style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 9999; display: none; backdrop-filter: blur(4px);">
        </div>
        <div id="snap-comment-drawer"
            style="position: fixed; top: 0; right: -100%; width: 450px; max-width: 100%; height: 100vh; background: #0f0f0f; z-index: 10000; box-shadow: -10px 0 40px rgba(0,0,0,0.8); transition: right 0.4s cubic-bezier(0.165, 0.84, 0.44, 1); display: flex; flex-direction: column;">
            <div
                style="padding: 20px; border-bottom: 1px solid rgba(255,255,255,0.08); display: flex; justify-content: space-between; align-items: center;">
                <h3 style="margin:0; font-weight: 800; font-size: 1.2rem;">Comments</h3>
                <button onclick="closeSnapComments()"
                    style="background:none; border:none; color:white; font-size: 1.8rem; cursor:pointer; padding: 0 10px;">&times;</button>
            </div>
            <div id="snap-comments-content" style="flex:1; overflow-y: auto; padding: 20px;">
                <!-- Comments load here -->
            </div>
            <div style="padding: 20px; border-top: 1px solid rgba(255,255,255,0.08); background: #0f0f0f;">
                <div style="display: flex; gap: 12px; align-items: center;">
                    <input type="text" id="snap-comment-input" placeholder="Add a comment..."
                        style="flex:1; background: #1a1a1a; border: 1px solid rgba(255,255,255,0.1); border-radius: 24px; padding: 12px 20px; color: white; outline: none; font-size: 0.95rem;">
                    <button id="snap-comment-submit"
                        style="background: #ff0055; color: white; border: none; width: 44px; height: 44px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: 0.2s;">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- Custom Modals (Under Development Fix) -->
        <div id="create-post-modal"
            style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 20000; backdrop-filter: blur(8px); align-items: center; justify-content: center; padding: 20px;">
            <div
                style="background: #111; width: 500px; max-width: 100%; border-radius: 24px; border: 1px solid rgba(255,255,255,0.1); padding: 32px; box-shadow: 0 20px 50px rgba(0,0,0,0.5);">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                    <h2 style="font-weight: 800; margin: 0;">Create Community Post</h2>
                    <button onclick="document.getElementById('create-post-modal').style.display='none'"
                        style="background: none; border: none; color: white; font-size: 1.5rem; cursor: pointer;">&times;</button>
                </div>
                <textarea id="post-content" placeholder="What's on your mind?"
                    style="width: 100%; height: 150px; background: #1a1a1a; border: 1px solid rgba(255,255,255,0.1); border-radius: 16px; padding: 16px; color: white; font-size: 1rem; outline: none; margin-bottom: 20px; resize: none;"></textarea>
                <input type="text" id="post-image" placeholder="Image URL (optional)"
                    style="width: 100%; background: #1a1a1a; border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; padding: 12px; color: white; outline: none; margin-bottom: 24px;">
                <button onclick="submitPost()"
                    style="width: 100%; padding: 14px; background: #ff0055; color: white; border: none; border-radius: 14px; font-weight: 800; cursor: pointer;">Post
                    to Squad</button>
            </div>
        </div>

        <div id="go-live-modal"
            style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 20000; backdrop-filter: blur(15px); align-items: center; justify-content: center; padding: 20px;">
            <div
                style="background: #0a0a0a; width: 700px; max-width: 100%; border-radius: 24px; border: 1px solid rgba(255,0,85,0.3); padding: 32px; box-shadow: 0 20px 80px rgba(0,0,0,0.8); display: flex; flex-direction: column; max-height: 90vh; overflow-y: auto;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <div
                            style="width: 12px; height: 12px; background: #ff0055; border-radius: 50%; box-shadow: 0 0 15px #ff0055; animation: pulse 1s infinite;">
                        </div>
                        <h2 style="font-weight: 800; margin: 0; letter-spacing: -0.5px; text-transform: uppercase;">
                            Broadcast Control Room</h2>
                    </div>
                    <button onclick="document.getElementById('go-live-modal').style.display='none'; stopLiveMedia();"
                        style="background: none; border: none; color: white; font-size: 1.5rem; cursor: pointer; opacity: 0.5;">&times;</button>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px; margin-bottom: 24px;">
                    <!-- Left: Preview & Details -->
                    <div>
                        <div
                            style="position: relative; width: 100%; aspect-ratio: 16/9; background: #000; border-radius: 12px; margin-bottom: 20px; overflow: hidden; border: 1px solid rgba(255,255,255,0.1);">
                            <video id="live-preview" autoplay muted playsinline
                                style="width: 100%; height: 100%; object-fit: cover;"></video>
                            <div
                                style="position: absolute; top: 12px; left: 12px; background: rgba(255,0,85,0.8); padding: 4px 10px; border-radius: 4px; font-size: 0.7rem; font-weight: 800;">
                                BROWSER PREVIEW</div>
                        </div>
                        <input type="text" id="stream-title-input" placeholder="Stream Title"
                            style="width: 100%; background: #1a1a1a; border: 1px solid #333; border-radius: 10px; padding: 12px; color: white; outline: none; margin-bottom: 12px;">
                        <input type="text" id="stream-thumb-input" placeholder="Custom Thumbnail URL"
                            style="width: 100%; background: #1a1a1a; border: 1px solid #333; border-radius: 10px 10px 0 0; padding: 12px; color: white; outline: none; border-bottom: none;">
                        <div
                            style="background: #222; padding: 10px; border-radius: 0 0 10px 10px; border: 1px solid #333; display: flex; align-items: center; gap: 10px;">
                            <label for="live-thumb-file"
                                style="background: #444; padding: 8px 12px; border-radius: 6px; font-size: 0.8rem; cursor: pointer; font-weight: 700;">
                                <i class="fas fa-file-upload"></i> UPLOAD IMAGE
                            </label>
                            <input type="file" id="live-thumb-file" hidden accept="image/*"
                                onchange="uploadLiveThumbnail(this)">
                            <div id="thumb-upload-status" style="font-size: 0.75rem; color: #888;">From device</div>
                        </div>
                    </div>

                    <!-- Right: Config & OBS -->
                    <div style="display: flex; flex-direction: column; gap: 15px;">
                        <div
                            style="background: rgba(255,255,255,0.03); padding: 15px; border-radius: 12px; border: 1px solid #222;">
                            <label
                                style="font-size: 0.75rem; color: #888; font-weight: 700; margin-bottom: 8px; display: block;">BROADCAST
                                SOURCE</label>
                            <select id="stream-source" onchange="switchSource(this.value)"
                                style="width: 100%; background: #111; border: 1px solid #333; color: white; padding: 10px; border-radius: 8px;">
                                <option value="camera">Webcam & Mic</option>
                                <option value="screen">Share Screen</option>
                                <option value="obs">External (OBS Studio)</option>
                            </select>
                        </div>

                        <div id="obs-config"
                            style="display:none; background: #111; padding: 15px; border-radius: 12px; border: 1px solid #ff005533;">
                            <h4 style="margin: 0 0 10px 0; font-size: 0.85rem; color: #ff0055;"><i
                                    class="fas fa-tower-broadcast"></i> OBS SETUP</h4>
                            <div style="margin-bottom: 10px;">
                                <label style="font-size: 0.7rem; color: #666;">SERVER URL</label>
                                <div style="display: flex; gap: 8px; margin-top: 4px;">
                                    <input type="text" readonly value="rtmp://vitox-live.junaid.tv/live"
                                        style="flex:1; background: #000; border: none; font-size: 0.75rem; color: #aaa; padding: 8px; border-radius: 4px;">
                                    <button
                                        onclick="navigator.clipboard.writeText('rtmp://vitox-live.junaid.tv/live'); showToast('Copied!')"
                                        style="background: #222; border: none; color: white; padding: 0 10px; border-radius: 4px;"><i
                                            class="fas fa-copy"></i></button>
                                </div>
                            </div>
                            <div>
                                <label style="font-size: 0.7rem; color: #666;">STREAM KEY</label>
                                <div style="display: flex; gap: 8px; margin-top: 4px;">
                                    <input type="text" id="obs-stream-key" readonly value="vt_live_****"
                                        style="flex:1; background: #000; border: none; font-size: 0.75rem; color: #aaa; padding: 8px; border-radius: 4px;">
                                    <button
                                        onclick="document.getElementById('obs-stream-key').value='vt_live_' + Math.random().toString(36).substring(7); showToast('Generated Key!')"
                                        style="background: #222; border: none; color: white; padding: 0 10px; border-radius: 4px;"><i
                                            class="fas fa-sync"></i></button>
                                </div>
                            </div>
                            <p style="font-size: 0.65rem; color: #555; margin-top: 10px;">Note: Real-time RTMP ingest
                                requires Virtual Camera in OBS for this beta version.</p>
                        </div>

                        <div
                            style="background: rgba(255,255,255,0.03); padding: 15px; border-radius: 12px; border: 1px solid #222;">
                            <label
                                style="font-size: 0.75rem; color: #888; font-weight: 700; margin-bottom: 8px; display: block;">CATEGORY</label>
                            <select id="stream-category"
                                style="width: 100%; background: #111; border: 1px solid #333; color: white; padding: 10px; border-radius: 8px;">
                                <option>Gaming</option>
                                <option>Music</option>
                                <option>Tech</option>
                                <option>Social</option>
                            </select>
                        </div>
                    </div>
                </div>

                <button onclick="startStreamingSession()"
                    style="width: 100%; padding: 18px; background: #ff0055; color: white; border: none; border-radius: 12px; font-weight: 800; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px; transition: 0.3s; font-size: 1.1rem; box-shadow: 0 10px 40px rgba(255,0,85,0.3);">
                    <i class="fas fa-tower-broadcast"></i> START BROADCAST
                </button>
            </div>
        </div>

        <div id="toast-container"></div>
        <script>
            AOS.init({
                duration: 800,
                once: true,
                easing: 'ease-out-cubic'
            });

            let allVideos = []; // Global for search

            async function loadVideos() {
                try {
                    const urlParams = new URLSearchParams(window.location.search);
                    const sharedVidId = urlParams.get('v');

                    // Fetch ALL videos (including live)
                    const res = await fetch(sharedVidId ? '/api/videos' : '/api/videos');
                    allVideos = await res.json();

                    // Render videos OR live streams (filter out shorts for main grid unless searching)
                    renderVideos(allVideos.filter(v => v.type === 'video' || v.type === 'live' || !v.type));

                    // Auto-play if shared via URL (?v=ID or URL)
                    if (sharedVidId) {
                        const vid = allVideos.find(v =>
                            String(v.id) === String(sharedVidId) ||
                            String(v.video_url) === String(sharedVidId)
                        );

                        if (vid) {
                            if (vid.type === 'short') {
                                loadView('V-Snaps'); // Auto-switch to Snaps view
                            } else {
                                playVideo(vid.video_url, vid.title, vid.user_email, vid.views, vid.timestamp, vid.description, vid.id, vid.type);
                            }
                        } else if (sharedVidId.startsWith('http')) {
                            // LAST RESORT: Try to play it as a direct URL
                            playVideo(sharedVidId, "Shared Discovery", "Vitox Guest", 0, "Shared", "Linked directly via URL.", "direct-url", "video");
                        }
                    }
                } catch (e) { console.error(e); }
            }

            function renderVideos(videosToRender, isSimulatedDrama = false) {
                if (typeof initRetentionHooks === 'function') initRetentionHooks();
                const grid = document.getElementById('main-video-grid');
                const emptyState = document.getElementById('empty-state');

                if (!videosToRender || videosToRender.length === 0) {
                    if (emptyState) {
                        emptyState.style.display = 'block';
                        emptyState.innerHTML = `
                            <div style="text-align: center; padding: 60px 20px; color: var(--text-secondary);">
                                <i class="fas fa-video-slash" style="font-size: 3.5rem; margin-bottom: 24px; color: #333;"></i>
                                <h2 style="color: var(--text-primary); margin-bottom: 12px; font-weight: 800;">No videos found</h2>
                                <p style="font-size: 1.1rem; max-width: 400px; margin: 0 auto 30px;">Be the first one to share something amazing with the Vitox Squad!</p>
                                <button onclick="location.href='upload.html'" style="padding: 12px 30px; background: var(--accent); border: none; color: white; border-radius: 12px; cursor: pointer; font-weight: 700; font-size: 1rem; box-shadow: 0 4px 15px rgba(255,0,85,0.3);">Upload Now</button>
                            </div>
                        `;
                    }
                    if (grid) grid.style.display = 'none';
                    return;
                }

                if (emptyState) emptyState.style.display = 'none';

                // Reset Layout for Feed
                const sidebar = document.querySelector('.sidebar');
                const catBar = document.querySelector('.categories-bar');
                const content = document.querySelector('.content');
                const topBar = document.querySelector('.top-bar');
                if (sidebar) sidebar.style.display = 'block';
                if (catBar) catBar.style.display = 'flex';
                if (topBar) topBar.style.display = 'flex';
                if (content) {
                    content.style.marginLeft = '240px';
                    content.style.padding = '12px 24px';
                    content.style.paddingTop = '12px';
                }

                if (grid) {
                    // Reset Grid Styles
                    grid.style.display = 'grid';
                    grid.style.flexDirection = '';
                    grid.style.alignItems = '';
                    grid.style.gap = '';
                    grid.style.padding = '';
                    grid.style.height = '';
                    grid.style.overflowY = '';
                    grid.style.scrollSnapType = '';
                    grid.style.justifyContent = 'start';

                    grid.innerHTML = '';

                    videosToRender.forEach((vid, index) => {
                        const card = document.createElement('div');
                        card.className = 'video-card';
                        card.setAttribute('data-aos', 'fade-up');
                        card.setAttribute('data-aos-delay', index * 50);

                        card.onclick = () => playVideo(
                            vid.video_url,
                            vid.title || 'Untitled',
                            vid.user_email,
                            vid.views || 0,
                            vid.timestamp,
                            vid.description || '',
                            vid.id,
                            vid.type || 'video'
                        );

                        // Bug fix: Only treat as LIVE if type is explicitly 'live'
                        const isLive = (vid.type === 'live');

                        // Smart Thumbnail Logic: Use thumbnail_url if exists, otherwise generate from Cloudinary video URL
                        let thumbSrc = (vid.thumbnail_url && vid.thumbnail_url !== 'null' && vid.thumbnail_url !== 'undefined' && vid.thumbnail_url !== '')
                            ? vid.thumbnail_url
                            : (vid.video_url && vid.video_url.includes('cloudinary.com')
                                ? vid.video_url.replace('/video/upload/', '/video/upload/c_fill,h_270,w_480,so_auto/').replace(/\.[^/.]+$/, ".jpg")
                                : `https://dummyimage.com/480x270/111/ff0055.png&text=${encodeURIComponent(vid.title || 'Vitox')}`);

                        card.innerHTML = `
                            <div class="thumbnail-wrapper" style="position:relative; overflow:hidden; border-radius:12px; aspect-ratio:16/9; background:#111;">
                                <img src="${thumbSrc}"
                                    alt="${vid.title || 'Video thumbnail'}"
                                    loading="lazy"
                                    style="width:100%; height:100%; object-fit:cover; display:block;"
                                    onerror="this.src='https://dummyimage.com/480x270/111/ff0055.png&text=Vitox'"
                                />
                                ${isLive ? '<div style="position:absolute; top:8px; left:8px; background:#ff0000; color:white; padding:3px 10px; font-size:0.72rem; font-weight:800; border-radius:4px; display:flex; align-items:center; gap:5px;"><span style=\'width:7px;height:7px;background:white;border-radius:50%;display:inline-block;\' ></span>LIVE</div>' : ''}
                                <div class="play-overlay" style="position:absolute;inset:0;display:flex;align-items:center;justify-content:center;opacity:0;transition:opacity 0.2s;background:rgba(0,0,0,0.3);">
                                    <div style="width:50px;height:50px;background:rgba(255,255,255,0.9);border-radius:50%;display:flex;align-items:center;justify-content:center;">
                                        <i class="fas fa-play" style="color:#111;font-size:1.2rem;margin-left:4px;"></i>
                                    </div>
                                </div>
                            </div>
                            <div class="video-info">
                                <div class="channel-avatar">
                                    ${(vid.user_email || '?').charAt(0).toUpperCase()}
                                </div>
                                <div class="text-info">
                                    <h3 class="video-title">${(!vid.title || vid.title === 'undefined') ? 'Vitox Video' : vid.title}</h3>
                                    <p class="channel-name">${(!vid.user_email || vid.user_email === 'undefined') ? 'Official Creator' : vid.user_email.split('@')[0]} <i class="fas fa-check-circle"></i></p>
                                    <div class="meta-data">
                                        <span>${isLive ? '<span style="color:#ff0055;">ðŸ”´ Live now</span>' : (vid.views || 0) + ' views'}</span> â€¢ <span>${vid.timestamp ? new Date(vid.timestamp).toLocaleDateString() : 'Just now'}</span>
                                    </div>
                                </div>
                            </div>
                        `;

                        // Hover play overlay effect
                        const wrapper = card.querySelector('.thumbnail-wrapper');
                        const overlay = card.querySelector('.play-overlay');
                        if (wrapper && overlay) {
                            wrapper.addEventListener('mouseenter', () => overlay.style.opacity = '1');
                            wrapper.addEventListener('mouseleave', () => overlay.style.opacity = '0');
                        }

                        grid.appendChild(card);
                    });
                }

                // Update Sidebar Active State
                document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
                document.querySelector('.nav-item').classList.add('active'); // Home/Feed is index 0
            }

            async function loadSnapsView() {
                const grid = document.getElementById('main-video-grid');
                const emptyState = document.getElementById('empty-state');
                if (!grid) return;

                // Update UI Interface
                document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
                const snapLink = Array.from(document.querySelectorAll('.nav-item')).find(a => a.innerText.includes('V-Snaps'));
                if (snapLink) snapLink.classList.add('active');

                try {
                    // Fetch only SHORTS (V-Snaps)
                    const res = await fetch('/api/videos?type=short');
                    const vids = await res.json();

                    // Shuffle for random feed
                    vids.sort(() => Math.random() - 0.5);

                    if (!vids || vids.length === 0) {
                        loadView('V-Snaps');
                        return;
                    }

                    if (emptyState) emptyState.style.display = 'none';

                    // Transformation to Shorts Mode
                    grid.style.display = 'block'; // Block to allow container inside
                    grid.innerHTML = '<div class="snap-container" id="snap-scroller"></div>';
                    const container = document.getElementById('snap-scroller');

                    vids.forEach((vid, index) => {
                        const snap = document.createElement('div');
                        snap.className = 'snap-card';

                        // Ad Injection Logic (Every 5th video)
                        if (index > 0 && index % 5 === 0) {
                            const adSnap = document.createElement('div');
                            adSnap.className = 'snap-card';
                            adSnap.style.background = '#222';
                            adSnap.style.display = 'flex';
                            adSnap.style.alignItems = 'center';
                            adSnap.style.justifyContent = 'center';
                            adSnap.innerHTML = `
                            <div style="text-align: center; color: #aaa;">
                                <i class="fas fa-ad" style="font-size: 3rem; margin-bottom: 20px;"></i>
                                <p>Sponsored Content</p>
                                <div id="ad-slot-${index}"></div>
                            </div>
                        `;
                            container.appendChild(adSnap);
                            // Initialize ad dynamically if needed
                        }

                        snap.innerHTML = `
                        <video src="${vid.video_url}" class="snap-video" loop muted playsinline></video>
                        
                        <div class="snap-overlay">
                            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 12px; cursor: pointer;">
                                <div class="channel-avatar" style="border: 2px solid white;">
                                    ${(vid.user_email || '?').charAt(0).toUpperCase()}
                                </div>
                                <span style="font-weight: 700; font-size: 1rem; text-shadow: 0 1px 3px rgba(0,0,0,0.8);">@${vid.user_email.split('@')[0]}</span>
                                <button class="snap-follow-btn" id="snap-sub-btn-${vid.id}" style="margin-left: auto;" onclick="toggleSubscribe('${vid.user_email}', '${vid.id}')">Squad</button>
                            </div>
                            <h3 style="margin: 0; font-size: 1.1rem; font-weight: 500; line-height: 1.4; text-shadow: 0 1px 3px rgba(0,0,0,0.8);">${vid.title || 'Vitox Snap'}</h3>
                            <p style="margin: 6px 0 0 0; font-size: 0.9rem; opacity: 0.9;">${vid.description || '#Vitox #Snaps'}</p>
                        </div>

                        <div class="snap-actions">
                            <div class="action-item" onclick="toggleLike('${vid.id}', '${vid.user_email}')">
                                <i class="fas fa-heart" id="snap-like-icon-${vid.id}"></i>
                                <span id="snap-like-count-${vid.id}">${vid.likes || 0}</span>
                            </div>
                            <div class="action-item" onclick="openSnapComments('${vid.id}')">
                                <i class="fas fa-comment-dots"></i>
                                <span id="snap-comm-count-${vid.id}">${vid.comment_count || 0}</span>
                            </div>
                            <div class="action-item" onclick="shareVideo('${vid.id}')">
                                <i class="fas fa-share"></i>
                                <span>Share</span>
                            </div>
                             <div class="action-item" onclick="showToast('Vitox Audio: ' + (document.querySelector('h3').innerText))">
                                <i class="fas fa-record-vinyl fa-spin" style="animation-duration: 4s;"></i>
                            </div>
                        </div>
                    `;

                        const video = snap.querySelector('video');

                        // Click to Play/Pause
                        snap.onclick = (e) => {
                            if (e.target.closest('.action-item') || e.target.closest('button')) return;
                            if (video.paused) {
                                // Pause others
                                container.querySelectorAll('video').forEach(v => {
                                    if (v !== video) {
                                        v.pause();
                                        v.currentTime = 0; // Reset for better UX
                                    }
                                });
                                video.play();
                                video.muted = false; // Unmute on interaction
                            } else {
                                video.pause();
                            }
                        };

                        container.appendChild(snap);
                    });

                    // Intersection Observer for Auto-Play on Scroll
                    const observer = new IntersectionObserver((entries) => {
                        entries.forEach(entry => {
                            const vid = entry.target.querySelector('video');
                            if (!vid) return;

                            if (entry.isIntersecting) {
                                // Pause all others first to save resources & mobile battery
                                container.querySelectorAll('video').forEach(v => {
                                    if (v !== vid) v.pause();
                                });

                                vid.play().catch(e => console.log("Auto-play prevented (interaction needed)"));
                                vid.muted = false;
                            } else {
                                vid.pause();
                            }
                        });
                    }, { threshold: 0.6 }); // 60% visibility triggers play

                    document.querySelectorAll('.snap-card').forEach(card => observer.observe(card));

                } catch (e) {
                    console.error("Snap Load Error:", e);
                }
            }

            async function loadLikedVideosView() {
                const grid = document.getElementById('main-video-grid');
                const emptyState = document.getElementById('empty-state');
                if (!grid) return;

                // Check Login
                const user = JSON.parse(localStorage.getItem('vitox_user'));
                if (!user) return loadView('Liked Videos'); // Default blocking view if not logged in

                // Fetch Likes
                try {
                    const res = await fetch(`/api/user/liked-videos/${user.email}`);
                    const likedVideos = await res.json();

                    if (emptyState) emptyState.style.display = 'none';
                    grid.style.display = 'block'; // Block for custom layout

                    if (likedVideos.length === 0) {
                        loadView('Liked Videos'); // Show empty state
                        return;
                    }

                    const firstVideo = likedVideos[0];

                    grid.innerHTML = `
                    <div class="liked-layout" style="display: flex; gap: 24px; color: white; height: 85vh;">
                        <!-- Left Hero -->
                        <div class="liked-hero" style="
                            width: 360px; 
                            background: linear-gradient(180deg, rgba(50,50,50,0.8), rgba(15,15,15,1)); 
                            border-radius: 16px; 
                            padding: 24px; 
                            display: flex; 
                            flex-direction: column; 
                            justify-content: flex-end; 
                            position: relative; 
                            overflow: hidden;
                            flex-shrink: 0;
                        ">
                            <!-- Blurry Backdrop -->
                            <div style="
                                position: absolute; top: 0; left: 0; right: 0; bottom: 0; 
                                background-image: url('${firstVideo.video_url}#t=5'); 
                                background-size: cover; 
                                filter: blur(30px) brightness(0.6); 
                                z-index: 0;
                            "></div>
                            
                            <div style="position: relative; z-index: 2;">
                                <img src="${firstVideo.video_url}#t=5" style="width: 100%; aspect-ratio: 16/9; border-radius: 12px; object-fit: cover; margin-bottom: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.3);">
                                <h1 style="font-size: 1.8rem; margin: 0 0 10px 0;">Liked videos</h1>
                                <p style="margin: 0; font-weight: 500;">${user.name}</p>
                                <p style="color: #aaa; font-size: 0.9rem; margin-top: 4px;">${likedVideos.length} videos â€¢ No views</p>
                                
                                <div style="display: flex; gap: 10px; margin-top: 24px;">
                                    <button style="border-radius: 50%; width: 40px; height: 40px; border: none; background: rgba(255,255,255,0.1); color: white; cursor: pointer;"><i class="fas fa-download"></i></button>
                                    <button style="border-radius: 50%; width: 40px; height: 40px; border: none; background: rgba(255,255,255,0.1); color: white; cursor: pointer;"><i class="fas fa-ellipsis-v"></i></button>
                                </div>
                                <button style="margin-top: 20px; padding: 10px 24px; background: white; color: black; border: none; border-radius: 20px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 8px;">
                                    <i class="fas fa-play"></i> Play all
                                </button>
                            </div>
                        </div>

                        <!-- Right List -->
                        <div class="liked-list" style="flex: 1; overflow-y: auto;">
                            ${likedVideos.map((vid, idx) => `
                                <div onclick="playVideo('${vid.video_url}', '${vid.title}', '${vid.user_email}', ${vid.views}, '${vid.timestamp}', '', ${vid.id})" 
                                    style="display: flex; gap: 12px; padding: 12px; border-radius: 12px; cursor: pointer; transition: background 0.2s;"
                                    onmouseover="this.style.background='rgba(255,255,255,0.1)'" 
                                    onmouseout="this.style.background='transparent'">
                                    
                                    <span style="color: #aaa; width: 20px; display: flex; align-items: center; justify-content: center;">${idx + 1}</span>
                                    
                                    <div style="width: 160px; height: 90px; border-radius: 8px; overflow: hidden; flex-shrink: 0; position: relative;">
                                        <video src="${vid.video_url}" style="width: 100%; height: 100%; object-fit: cover;"></video>
                                    </div>
                                    
                                    <div style="flex: 1;">
                                        <h4 style="margin: 0 0 4px 0; font-size: 1rem;">${vid.title || 'Untitled Video'}</h4>
                                        <p style="margin: 0; font-size: 0.85rem; color: #aaa;">${vid.user_email} â€¢ ${vid.views || 0} views</p>
                                    </div>

                                    <button style="background: none; border: none; color: white; opacity: 0; align-self: center;" class="more-btn"><i class="fas fa-ellipsis-v"></i></button>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;

                } catch (e) {
                    console.error(e);
                    loadView('Liked Videos');
                }
            }

            function loadView(viewName, data = {}) {
                // Update active state in sidebar
                document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
                const links = Array.from(document.querySelectorAll('.nav-item'));
                const link = links.find(a => {
                    const text = a.innerText.trim().toLowerCase();
                    return text === viewName.toLowerCase() || 
                           (viewName === 'V-Snaps' && text.includes('v-snaps')) ||
                           (viewName === 'Squad' && text === 'squad') ||
                           (viewName === 'Feed' && text === 'feed') ||
                           (viewName === 'Live Stream' && text === 'pulse');
                });
                if (link) link.classList.add('active');

                const grid = document.getElementById('main-video-grid');
                const emptyState = document.getElementById('empty-state');
                const sidebar = document.querySelector('.sidebar');
                const catBar = document.querySelector('.categories-bar');
                const content = document.querySelector('.content');
                const topBar = document.querySelector('.top-bar');

                if (grid) {
                    grid.innerHTML = '';
                    grid.style.display = 'block';
                }
                if (emptyState) emptyState.style.display = 'none';

                if (viewName === 'Feed') {
                    loadVideos();
                    return;
                }

                // Default show common UI elements
                if (sidebar) sidebar.style.display = 'block';
                if (catBar) catBar.style.display = 'flex';
                if (topBar) topBar.style.display = 'flex';
                if (content) {
                    content.style.marginLeft = '240px';
                    content.style.padding = '12px 24px';
                }

                if (viewName === 'Squad') {
                    loadCommunityFeed();
                    return;
                }

                if (viewName === 'Live Stream') {
                    if (emptyState) emptyState.style.display = 'none';

                    // Full screen dashboard mode (Hide main UI)
                    if (sidebar) sidebar.style.display = 'none';
                    if (catBar) catBar.style.display = 'none';
                    if (topBar) topBar.style.display = 'none';
                    if (content) {
                        content.style.marginLeft = '0';
                        content.style.padding = '0';
                    }

                    grid.innerHTML = `
                    <div style="display: flex; flex-direction: column; height: 100vh; background: #000; color: white; position: relative; overflow: hidden;">

                        
                        <!-- YouTube-style Broadcast Header -->
                        <div style="background: rgba(15,15,15,0.95); padding: 12px 24px; display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid rgba(255,255,255,0.1); z-index: 100; backdrop-filter: blur(10px);">
                            <div style="display: flex; align-items: center; gap: 20px;">
                                <div style="display: flex; align-items: center; gap: 8px; background: #ff0000; padding: 4px 12px; border-radius: 4px; font-weight: 800; font-size: 0.8rem; box-shadow: 0 0 15px rgba(255,0,0,0.3);">
                                    <div style="width: 8px; height: 8px; background: white; border-radius: 50%; animation: pulse-red 1s infinite;"></div>
                                    RADIATING
                                </div>
                                <div id="stream-duration" style="font-family: monospace; font-size: 1.1rem; color: #fff; font-weight: 600;">00:00:00</div>
                                <div style="display: flex; gap: 16px; color: #aaa; font-size: 0.9rem;">
                                    <span><i class="fas fa-eye"></i> <span id="view-count-header">0</span></span>
                                    <span><i class="fas fa-thumbs-up"></i> <span id="like-count-header">0</span></span>
                                </div>
                            </div>
                            <div style="display: flex; align-items: center; gap: 15px;">
                                <div style="text-align: right; margin-right: 15px;">
                                    <div style="font-size: 0.75rem; color: #00ff88; font-weight: 800;"><i class="fas fa-signal"></i> EXCELLENT</div>
                                    <div style="font-size: 0.65rem; color: #666;">Connection Strength</div>
                                </div>
                                <button onclick="stopStreaming()" style="background: #ff0000; color: white; border: none; padding: 10px 24px; border-radius: 4px; font-weight: 800; cursor: pointer; text-transform: uppercase; letter-spacing: 0.5px; transition: all 0.3s; box-shadow: 0 4px 15px rgba(255,0,0,0.2);" onmouseover="this.style.background='#cc0000'" onmouseout="this.style.background='#ff0000'">
                                    End Stream
                                </button>
                            </div>
                        </div>

                        <!-- Main Content Area -->
                        <div style="display: flex; flex: 1; min-height: 0; overflow: hidden;">
                            <!-- Left: Video & Controls -->
                            <div style="flex: 1; display: flex; flex-direction: column; background: #000; border-right: 1px solid rgba(255,255,255,0.05);">
                                <div style="position: relative; flex: 1; display: flex; align-items: center; justify-content: center;">
                                    <video id="stream-video" autoplay playsinline muted style="width: 100%; height: 100%; object-fit: contain;"></video>
                                    
                                    <!-- PRO ALERT OVERLAY -->
                                    <div id="alert-container" style="position: absolute; top: 30px; left: 50%; transform: translateX(-50%); z-index: 100; pointer-events: none; width: 90%; text-align: center;"></div>
                                    
                                    <!-- COUNTDOWN OVERLAY -->
                                    <div id="live-countdown-overlay" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 200; display: flex; flex-direction: column; align-items: center; justify-content: center;">
                                        <div style="width: 120px; height: 120px; border: 4px solid #ff0055; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-bottom: 20px; box-shadow: 0 0 30px rgba(255,0,85,0.4);">
                                            <span id="countdown-timer" style="font-size: 3.5rem; font-weight: 900; color: #ff0055;">10</span>
                                        </div>
                                        <h2 style="font-weight: 700; color: white; margin: 0;">Initializing Studio Pulse...</h2>
                                    </div>

                                    <!-- Bottom Control Bar -->
                                    <div style="position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); display: flex; gap: 15px; background: rgba(0,0,0,0.7); padding: 10px 25px; border-radius: 50px; border: 1px solid rgba(255,255,255,0.1); backdrop-filter: blur(10px);">
                                        <button class="icon-btn" style="color: #00ff88;"><i class="fas fa-microphone"></i></button>
                                        <button class="icon-btn" style="color: #00ff88;"><i class="fas fa-video"></i></button>
                                        <button id="record-btn" onclick="toggleRecording()" style="background: transparent; color: #fff; border: none; font-size: 1.2rem; cursor: pointer;"><i class="fas fa-circle" style="color:#ff0000;"></i></button>
                                        <button class="icon-btn"><i class="fas fa-share-alt"></i></button>
                                    </div>

                                    <!-- Watermark -->
                                    <div style="position: absolute; bottom: 30px; right: 30px; opacity: 0.3; font-weight: 800; font-size: 0.8rem;">
                                        VITOX BROADCASTER
                                    </div>
                                    
                                    <!-- Hearts -->
                                    <div id="hearts-container" style="position: absolute; bottom: 0; right: 80px; width: 100px; height: 100%; pointer-events: none;"></div>
                                </div>
                            </div>

                            <!-- Right: Chat & Activities -->
                            <div style="width: 400px; background: #0a0a0a; display: flex; flex-direction: column;">
                                <div style="padding: 18px 24px; border-bottom: 1px solid rgba(255,255,255,0.05); display: flex; justify-content: space-between; align-items: center;">
                                    <span style="font-weight: 800; letter-spacing: 0.5px; color: #eee;">PULSE CHAT</span>
                                    <span style="font-size: 0.75rem; color: #666;">Top Messages</span>
                                </div>
                                <div id="live-chat-content" style="flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 12px; font-size: 0.9rem;">
                                    <!-- Chat Messages -->
                                </div>
                                <div style="padding: 15px 20px; border-top: 1px solid rgba(255,255,255,0.05); background: #111;">
                                    <div style="display: flex; gap: 10px;">
                                        <input type="text" id="live-chat-input" placeholder="Say something..." style="flex: 1; background: #1a1a1a; border: 1px solid #333; border-radius: 8px; padding: 12px; color: white; outline: none;">
                                        <button onclick="sendLiveChatMsg()" style="background: #ff0000; border: none; color: white; width: 45px; border-radius: 8px; cursor: pointer;">
                                            <i class="fas fa-paper-plane"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <style>
                        @keyframes alert-slide-in { 0% { opacity: 0; transform: translateY(-40px) scale(0.85); } 100% { opacity: 1; transform: translateY(0) scale(1); } }
                        @keyframes alert-slide-out { 0% { opacity: 1; } 100% { opacity: 0; transform: translateY(-20px); } }
                        @keyframes float-heart { 0% { transform: translateY(0) scale(1); opacity: 1; } 100% { transform: translateY(-220px) scale(1.3); opacity: 0; } }
                        @keyframes bar-rise { from { height: 20%; } to { height: 95%; } }
                        @keyframes pulse-red { 0% { opacity: 1; } 50% { opacity: 0.3; } 100% { opacity: 1; } }
                        #live-chat-content::-webkit-scrollbar { width: 4px; }
                        #live-chat-content::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 4px; }
                    </style>
                    `;

                    const video = document.getElementById('stream-video');
                    if (video && liveStream) {
                        video.srcObject = liveStream;
                    }

                    runLiveCountdown();
                    return;
                }


                if (viewName === 'Creator Hub') {
                    const user = JSON.parse(localStorage.getItem('vitox_user'));
                    if (emptyState) emptyState.style.display = 'none';

                    grid.innerHTML = `
                    < div style = "padding: 40px; color: white; width: 100%;" >
                        <h1 style="font-size: 2.5rem; font-weight: 800; margin-bottom: 30px;">Broadcast Studio</h1>
                        
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 24px;">
                            <!-- Analytics Card -->
                            <div style="background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); padding: 30px; border-radius: 20px;">
                                <i class="fas fa-chart-line" style="font-size: 2rem; color: #ff0055; margin-bottom: 20px;"></i>
                                <h3 style="margin: 0 0 10px 0;">Analytics</h3>
                                <p style="color: #aaa; margin-bottom: 20px;">Track your growth and view detailed performance of your videos.</p>
                                <button onclick="location.href='dashboard_overview.html'" style="padding: 10px 20px; background: white; color: black; border: none; border-radius: 8px; font-weight: 700; cursor: pointer;">Go to Dashboard</button>
                            </div>

                            <!-- Brand Collab Card -->
                            <div style="background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); padding: 30px; border-radius: 20px;">
                                <i class="fas fa-handshake" style="font-size: 2rem; color: #00ff88; margin-bottom: 20px;"></i>
                                <h3 style="margin: 0 0 10px 0;">Brand Collaboration</h3>
                                <p style="color: #aaa; margin-bottom: 20px;">Work with top brands and creators. Reach 100k Squad to unlock Elite deals.</p>
                                ${user && user.status === 'pending_brand' ?
                            '<button disabled style="padding: 10px 20px; background: #333; color: #888; border: none; border-radius: 8px; font-weight: 700;">Application Pending</button>' :
                            (user && user.is_verified_brand ?
                                '<span style="color: #00ff88; font-weight: 800;"><i class="fas fa-check-circle"></i> Verified Brand</span>' :
                                '<button onclick="applyForBrand()" style="padding: 10px 20px; background: #ff0055; color: white; border: none; border-radius: 8px; font-weight: 700; cursor: pointer;">Apply for Brand Verification</button>'
                            )
                        }
                            </div>

                            <!-- Community Post Card -->
                            <div style="background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); padding: 30px; border-radius: 20px;">
                                <i class="fas fa-pen-to-square" style="font-size: 2rem; color: #ffd700; margin-bottom: 20px;"></i>
                                <h3 style="margin: 0 0 10px 0;">Community Feed</h3>
                                <p style="color: #aaa; margin-bottom: 20px;">Engage with your fans. Post updates, images, and announcements.</p>
                                <button onclick="document.getElementById('create-post-modal').style.display='flex'" style="padding: 10px 20px; background: #ffd700; color: black; border: none; border-radius: 8px; font-weight: 700; cursor: pointer;">Create Post</button>
                            </div>

                            <!-- Go Live Card -->
                            <div style="background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); padding: 30px; border-radius: 20px;">
                                <i class="fas fa-tower-broadcast" style="font-size: 2rem; color: #ff0055; margin-bottom: 20px;"></i>
                                <h3 style="margin: 0 0 10px 0;">Radiate Now</h3>
                                <p style="color: #aaa; margin-bottom: 20px;">Stream live to your Squad. Real-time interaction with your viewers.</p>
                                <button onclick="openGoLiveModal()" style="padding: 10px 20px; background: #ff0055; color: white; border: none; border-radius: 8px; font-weight: 700; cursor: pointer;">Launch Broadcast</button>
                            </div>

                            <!-- NEW: AI Logo Maker Card -->
                            <div id="logo-maker-card" style="background: linear-gradient(135deg, rgba(255,0,85,0.1), rgba(255,85,0,0.1)); border: 1px solid rgba(255,0,85,0.2); padding: 30px; border-radius: 20px; grid-column: span 2;">
                                <div style="display: flex; gap: 30px; align-items: center;">
                                    <div id="ai-logo-preview" style="width: 120px; height: 120px; border-radius: 50%; background: #111; border: 2px dashed #333; display: flex; align-items: center; justify-content: center; overflow: hidden; flex-shrink: 0;">
                                        <i class="fas fa-robot" style="font-size: 2rem; color: #333;"></i>
                                    </div>
                                    <div style="flex: 1;">
                                        <h3 style="margin: 0 0 10px 0; display: flex; align-items: center; gap: 10px;">
                                            AI Logo Maker <span style="font-size: 0.7rem; background: #ff0055; padding: 2px 8px; border-radius: 20px;">NEW</span>
                                        </h3>
                                        <p style="color: #aaa; margin-bottom: 15px;">Generate a professional channel logo with AI. Type your style below.</p>
                                        <div style="display: flex; gap: 10px;">
                                            <input type="text" id="logo-prompt" placeholder="e.g. Minimalist gaming phoenix, Red & Black" style="flex: 1; background: rgba(255,255,255,0.05); border: 1px solid #333; border-radius: 8px; padding: 10px; color: white; outline: none;">
                                            <button onclick="generateAILogo()" style="background: #ff0055; color: white; border: none; padding: 10px 20px; border-radius: 8px; font-weight: 700; cursor: pointer;">Generate</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div >
                    `;
                    return;
                }

                if (viewName.startsWith('AI ')) {
                    if (emptyState) emptyState.style.display = 'none';
                    const toolIcon = viewName.includes('Logo') ? 'fas fa-compass-drafting' : 
                                   viewName.includes('Thumbnail') ? 'fas fa-image' : 
                                   viewName.includes('Image') ? 'fas fa-palette' : 'fas fa-film';
                    
                    grid.innerHTML = `
                    <div style="padding: 40px; color: white; width: 100%; max-width: 900px; margin: 0 auto;">
                        <div style="display: flex; align-items: center; gap: 20px; margin-bottom: 40px;">
                            <div style="width: 80px; height: 80px; background: rgba(255,0,85,0.1); border-radius: 20px; display: flex; align-items: center; justify-content: center; border: 1px solid rgba(255,0,85,0.2);">
                                <i class="${toolIcon}" style="font-size: 2.5rem; color: #ff0055;"></i>
                            </div>
                            <div>
                                <h1 style="font-size: 2.2rem; font-weight: 800; margin: 0;">${viewName}</h1>
                                <p style="color: #aaa; margin-top: 5px;">Powered by Vitox AI - Professional Creator Edition</p>
                            </div>
                        </div>

                        <div style="background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.08); padding: 40px; border-radius: 24px; box-shadow: 0 20px 50px rgba(0,0,0,0.3);">
                            <div id="ai-tool-preview" style="width: 100%; aspect-ratio: 16/9; background: #000; border-radius: 16px; margin-bottom: 30px; display: flex; align-items: center; justify-content: center; border: 1px dashed #333; position: relative; overflow: hidden;">
                                <div id="ai-tool-placeholder" style="text-align: center; color: #444;">
                                    <i class="fas fa-robot" style="font-size: 4rem; margin-bottom: 20px;"></i>
                                    <h3>Ready to Generate</h3>
                                    <p>Your AI-generated asset will appear here.</p>
                                </div>
                                <div id="ai-loading-overlay" style="display:none; position: absolute; inset: 0; background: rgba(0,0,0,0.8); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 10;">
                                    <div class="loader-v"></div>
                                    <h3 style="margin-top: 20px; color: #ff0055;">Vitox AI is thinking...</h3>
                                    <p style="color: #888;">Generating your masterpiece</p>
                                </div>
                            </div>

                            <label style="display: block; font-weight: 600; margin-bottom: 12px; color: #eee;">Describe your vision</label>
                            <div style="display: flex; gap: 15px;">
                                <textarea id="tool-prompt" placeholder="e.g. A futuristic neon gaming setup with a cyberpunk vibe..." style="flex: 1; background: rgba(255,255,255,0.05); border: 1px solid #333; border-radius: 12px; padding: 15px; color: white; outline: none; font-family: 'Outfit', sans-serif; height: 60px; resize: none;"></textarea>
                                <button onclick="runVitoxTool('${viewName}')" id="tool-gen-btn" style="background: #ff0055; color: white; border: none; padding: 0 30px; border-radius: 12px; font-weight: 800; cursor: pointer; transition: 0.3s; box-shadow: 0 10px 20px rgba(255,0,85,0.2);">
                                    GENERATE
                                </button>
                            </div>
                            
                            <div style="margin-top: 30px; padding-top: 20px; border-top: 1px solid rgba(255,255,255,0.05); display: flex; justify-content: space-between; align-items: center;">
                                <div style="display: flex; gap: 20px;">
                                    <span style="font-size: 0.85rem; color: #888;"><i class="fas fa-bolt" style="color: #ffd700;"></i> High Priority</span>
                                    <span style="font-size: 0.85rem; color: #888;"><i class="fas fa-shield-alt" style="color: #00ff88;"></i> Commercial Rights Included</span>
                                </div>
                                <div style="font-size: 0.85rem; color: #ff0055; font-weight: 700;">PRO FEATURE</div>
                            </div>
                        </div>
                    </div>
                    `;
                    return;
                }

                if (viewName === 'Admin Panel') {
                    loadAdminPanel();
                    return;
                }

                // Show Custom Message for other views
                if (emptyState) {
                    const isPersonalView = ['Rewind', 'Bookmarks', 'Collections', 'Vault'].includes(viewName);
                    
                    if (isPersonalView) {
                        renderPersonalView(viewName);
                    } else {
                        emptyState.style.display = 'block';
                        emptyState.innerHTML = `
                        <div style="text-align: center; padding: 40px; color: var(--text-secondary);">
                            <i class="fas fa-tools" style="font-size: 3rem; margin-bottom: 20px;"></i>
                            <h2 style="color: var(--text-primary); margin-bottom: 10px;">${viewName}</h2>
                            <p>This feature is currently under development.</p>
                            <button onclick="loadVideos()" style="margin-top: 20px; padding: 10px 24px; background: var(--accent); border: none; color: white; border-radius: 4px; cursor: pointer; font-weight: 600;">Back to Home</button>
                        </div>
                        `;
                    }
                }
            }

            function renderPersonalView(viewName) {
                const grid = document.getElementById('main-video-grid');
                const emptyState = document.getElementById('empty-state');
                if (emptyState) emptyState.style.display = 'none';
                
                let items = [];
                let icon = '';
                let color = '';
                
                if (viewName === 'Rewind') {
                    items = JSON.parse(localStorage.getItem('vitox_history') || '[]');
                    icon = 'fas fa-history';
                    color = '#ff0055';
                } else if (viewName === 'Bookmarks') {
                    items = JSON.parse(localStorage.getItem('vitox_bookmarks') || '[]');
                    icon = 'fas fa-clock';
                    color = '#00ff88';
                } else if (viewName === 'Vault') {
                    items = JSON.parse(localStorage.getItem('vitox_vault') || '[]');
                    icon = 'fas fa-download';
                    color = '#0088ff';
                } else if (viewName === 'Collections') {
                    items = []; // Future playlist support
                    icon = 'fas fa-list';
                    color = '#ffd700';
                } else {
                    items = [];
                    icon = 'fas fa-folder';
                }

                if (items.length === 0) {
                    grid.innerHTML = `
                        <div style="text-align: center; padding: 100px 0; color: #666; width: 100%;">
                            <i class="${icon}" style="font-size: 4rem; margin-bottom: 20px; color: ${color}; opacity: 0.3;"></i>
                            <h2 style="color: white; margin-bottom: 10px;">No ${viewName} yet</h2>
                            <p>Videos you watch or save will appear here.</p>
                            <button onclick="loadVideos()" style="margin-top: 20px; padding: 10px 24px; background: transparent; border: 1px solid #444; color: white; border-radius: 30px; cursor: pointer;">Discover Content</button>
                        </div>
                    `;
                    return;
                }

                grid.innerHTML = `
                    <div style="padding: 24px; width: 100%;">
                        <h1 style="font-size: 2rem; font-weight: 800; color: white; margin-bottom: 30px; display: flex; align-items: center; gap: 15px;">
                            <i class="${icon}" style="color: ${color}"></i> ${viewName}
                        </h1>
                        <div class="video-grid">
                            ${items.map(v => `
                                <div class="video-card" onclick="playVideo('${v.url}', '${v.title.replace(/'/g, "\\'")}', '${v.user_email}', ${v.views || 0}, '${v.timestamp}', '', '${v.id}')">
                                    <div class="video-thumb-container">
                                        <video src="${v.url}" muted></video>
                                    </div>
                                    <div class="video-info">
                                        <h3 class="video-title">${v.title}</h3>
                                        <div class="video-meta">${v.user_email}</div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }

            function toggleBookmark(id, url, title, user_email) {
                let bookmarks = JSON.parse(localStorage.getItem('vitox_bookmarks') || '[]');
                const isBookmarked = bookmarks.some(b => b.id === id);
                
                if (isBookmarked) {
                    bookmarks = bookmarks.filter(b => b.id !== id);
                    showToast("Removed from Bookmarks");
                } else {
                    bookmarks.push({ id, url, title, user_email, timestamp: new Date().toISOString() });
                    showToast("Saved to Bookmarks");
                }
                
                localStorage.setItem('vitox_bookmarks', JSON.stringify(bookmarks));
                const btn = document.getElementById('bookmark-btn');
                if (btn) btn.innerHTML = isBookmarked ? '<i class="fas fa-clock"></i> Save' : '<i class="fas fa-check" style="color: #00ff88;"></i> Saved';
            }

            function performSearch() {
                const query = document.getElementById('search-input').value.toLowerCase();
                if (!query) return renderVideos(allVideos);

                const filtered = allVideos.filter(vid =>
                    (vid.title && vid.title.toLowerCase().includes(query)) ||
                    (vid.description && vid.description.toLowerCase().includes(query)) ||
                    (vid.category && vid.category.toLowerCase() === query)
                );
                
                if (filtered.length === 0 && query.length > 3) {
                    // Auto Smart Search Fallback
                    performAISearch(true);
                } else {
                    renderVideos(filtered);
                }
            }

            async function performAISearch(isFallback = false) {
                const query = document.getElementById('search-input').value;
                if(!query) return;

                const aiBtn = document.getElementById('ai-search-btn');
                aiBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
                if(isFallback) showToast("AI is finding the best match...");

                try {
                    const res = await fetch('/api/search/ai', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ query })
                    });
                    const data = await res.json();
                    
                    // Smart Filter: search for any of the keywords AI suggested
                    const keywords = data.interpreted.toLowerCase().split(' ');
                    const filtered = allVideos.filter(vid => {
                        const content = (vid.title + ' ' + (vid.description || '') + ' ' + (vid.category || '')).toLowerCase();
                        return keywords.some(k => k.length > 2 && content.includes(k));
                    });
                    
                    if (filtered.length > 0) {
                        renderVideos(filtered);
                        showToast(`Smart AI Match: Found ${filtered.length} results`);
                    } else {
                        renderVideos([]);
                    }
                } catch (e) {
                    console.error("AI Search Failed", e);
                } finally {
                    aiBtn.innerHTML = '<i class="fas fa-sparkles"></i>';
                }
            }

            document.getElementById('search-input').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') performSearch();
            });

            let voiceRecognition = null;
            function stopVoiceSearch() {
                const modal = document.getElementById('voice-search-modal');
                if (modal) modal.style.display = 'none';
                if (voiceRecognition) {
                    try { voiceRecognition.stop(); } catch(e){}
                }
            }

            function startVoiceSearch() {
                if (!('webkitSpeechRecognition' in window)) {
                    showToast("Voice search not supported in this browser.", "error");
                    return;
                }
                
                let modal = document.getElementById('voice-search-modal');
                if (!modal) {
                    modal = document.createElement('div');
                    modal.id = 'voice-search-modal';
                    modal.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.6);z-index:999999;display:flex;align-items:flex-start;justify-content:center;';
                    modal.innerHTML = `
                        <div style="background: white; width: 600px; max-width: 95vw; margin-top: 50px; position: relative; display: flex; flex-direction: column; box-shadow: 0 4px 20px rgba(0,0,0,0.15); font-family: 'Roboto', sans-serif;">
                            <button onclick="stopVoiceSearch()" style="position: absolute; right: 15px; top: 15px; background: transparent; border: none; font-size: 1.5rem; color: #333; cursor: pointer; padding: 10px; z-index: 10;"><i class="fas fa-times"></i></button>
                            <div style="padding: 30px 40px; font-size: 1.5rem; color: #000; flex: 1; min-height: 250px; display: flex; align-items: flex-start;" id="voice-search-text">Listening...</div>
                            <div style="display: flex; justify-content: center; align-items: center; padding-bottom: 60px; position: relative;">
                                <div style="position: relative; width: 140px; height: 140px; display: flex; align-items: center; justify-content: center;">
                                    <div style="position: absolute; display: flex; align-items: center; justify-content: center; gap: 4px; z-index: 1;">
                                        <div class="eq-bar" style="animation-delay: 0.1s;"></div>
                                        <div class="eq-bar" style="animation-delay: 0.3s; height: 60px;"></div>
                                        <div class="eq-bar" style="animation-delay: 0.0s; height: 80px;"></div>
                                        <div class="eq-bar" style="animation-delay: 0.4s; height: 95px;"></div>
                                        <div class="eq-bar" style="animation-delay: 0.2s; height: 80px;"></div>
                                        <div class="eq-bar" style="animation-delay: 0.5s; height: 60px;"></div>
                                        <div class="eq-bar" style="animation-delay: 0.1s;"></div>
                                    </div>
                                    <button onclick="stopVoiceSearch()" style="width: 68px; height: 68px; border-radius: 50%; background: #e60023; border: none; color: white; font-size: 2rem; cursor: pointer; box-shadow: 0 5px 15px rgba(230,0,35,0.4); z-index: 2; display: flex; align-items: center; justify-content: center; transition: 0.2s;">
                                        <i class="fas fa-microphone"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        <style>
                            .eq-bar { width: 6px; height: 40px; background: rgba(255,0,85,0.15); border-radius: 6px; animation: eq-bounce 0.8s infinite alternate ease-in-out; }
                            @keyframes eq-bounce { 0% { transform: scaleY(0.5); opacity: 0.5; } 100% { transform: scaleY(1.5); opacity: 1; background: rgba(255,0,85,0.4); } }
                        </style>
                    `;
                    document.body.appendChild(modal);
                }
                modal.style.display = 'flex';
                document.getElementById('voice-search-text').innerText = 'Listening...';

                if(voiceRecognition) {
                    try { voiceRecognition.stop(); } catch(e){}
                }
                
                voiceRecognition = new webkitSpeechRecognition();
                voiceRecognition.lang = 'en-US'; // Would be dynamically set in a real app
                voiceRecognition.continuous = false;
                voiceRecognition.interimResults = true;
                
                let finalTranscriptStr = '';

                voiceRecognition.onresult = (event) => {
                    let interimTranscript = '';
                    for (let i = event.resultIndex; i < event.results.length; ++i) {
                        if (event.results[i].isFinal) {
                            finalTranscriptStr += event.results[i][0].transcript;
                        } else {
                            interimTranscript += event.results[i][0].transcript;
                        }
                    }
                    
                    document.getElementById('voice-search-text').innerText = interimTranscript || finalTranscriptStr || 'Listening...';

                    if (event.results[0].isFinal) {
                        setTimeout(() => {
                            if(finalTranscriptStr) {
                                document.getElementById('search-input').value = finalTranscriptStr;
                                stopVoiceSearch();
                                performSearch();
                            }
                        }, 600);
                    }
                };
                
                voiceRecognition.onerror = (event) => {
                    document.getElementById('voice-search-text').innerText = "Didn't hear that. Try again.";
                    setTimeout(() => stopVoiceSearch(), 2500);
                };
                
                voiceRecognition.onend = () => {
                   if (!finalTranscriptStr) {
                       setTimeout(() => stopVoiceSearch(), 1000);
                   }
                };
                
                try { voiceRecognition.start(); } catch(e) { console.error("Could not start recognition", e); }
            }

            async function translateDescription(videoId, lang) {
                const descEl = document.getElementById('video-desc-text');
                const originalText = descEl ? descEl.innerText : "";
                if(!descEl) return;
                
                descEl.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Translating...';
                
                try {
                    const res = await fetch('/api/ai/translate', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ text: originalText, lang: lang })
                    });
                    const data = await res.json();
                    descEl.innerText = data.translated;
                } catch (e) {
                    descEl.innerText = originalText;
                    showToast("Translation failed");
                }
            }

            async function generateAILogo() {
                const prompt = document.getElementById('logo-prompt').value;
                const preview = document.getElementById('ai-logo-preview');
                if(!prompt) return alert("Please describe your logo style!");
                
                preview.innerHTML = '<i class="fas fa-spinner fa-spin" style="font-size: 2rem; color: #ff0055;"></i>';
                
                try {
                    const res = await fetch('/api/ai/generate-image', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ prompt: prompt, type: 'logo' })
                    });
                    const data = await res.json();
                    preview.innerHTML = `<img src="${data.url}" style="width:100%; height:100%; object-fit:cover; border-radius: 50%;">`;
                    showToast("Logo Generated! Right click to save.");
                } catch (e) {
                    preview.innerHTML = '<i class="fas fa-robot" style="font-size: 2rem;"></i>';
                    showToast("Logo generation failed");
                }
            }

            function showToast(msg) {
                const container = document.getElementById('toast-container');
                if (!container) return alert(msg);
                const toast = document.createElement('div');
                toast.className = 'toast';
                toast.innerText = msg;
                toast.style.cssText = "background: #333; color: white; padding: 12px 24px; border-radius: 4px; margin-top: 10px;";
                container.appendChild(toast);
                setTimeout(() => toast.remove(), 3000);
            }

            async function playVideo(url, title, user_email, views, timestamp, description, videoId, type = 'video') {
                // Update: Handle Live Stream Type
                const isLive = type === 'live' || url === 'live-placeholder';
                const safeTitle = title || 'Untitled';
                const safeChannel = user_email || 'guest@vitox';
                const safeId = videoId || 'temp';
                const initialViews = views || 0;
                const safeDesc = description || '';

                // AI Feature: Available for all videos now
                const isAIRequest = true; // Always show AI assistance for a premium experience

                if (isLive) {
                    // Use a placeholder public stream for the simulation if it's the specific placeholder flag
                    if (url === 'live-placeholder') url = 'https://res.cloudinary.com/demo/video/upload/sp_auto/dog.mp4'; // Placeholder stock video
                }

                // NEW: Save to History
                let history = JSON.parse(localStorage.getItem('vitox_history') || '[]');
                const historyItem = { id: safeId, url, title: safeTitle, user_email: safeChannel, views: initialViews, timestamp: new Date().toISOString() };
                history = [historyItem, ...history.filter(h => h.id !== safeId)].slice(0, 50);
                localStorage.setItem('vitox_history', JSON.stringify(history));

                // Increment View Logic
                if (typeof incrementWatchCount === 'function') incrementWatchCount();
                const user = JSON.parse(localStorage.getItem('vitox_user'));
                const isSelf = user && user.email === safeChannel;

                if (safeId !== 'direct-url' && user) {
                    fetch('/api/video/view', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            video_id: safeId,
                            email: user.email
                        })
                    }).catch(e => console.error("View increment failed:", e));
                }

                const playerOverlay = document.createElement('div');
                playerOverlay.id = 'video-modal';
                playerOverlay.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                background: rgba(0, 0, 0, 0.9); z-index: 5000;
                display: flex; justify-content: center; overflow-y: auto; padding: 20px 0;
                `;

                const timeAgo = timestamp ? new Date(timestamp).toLocaleDateString() : 'Just now';
                const displayDesc = safeDesc;

                playerOverlay.innerHTML = `
                    <div id="modal-container" style="width: 95%; max-width: 1400px; position: relative; background: rgba(10,10,10,0.85); min-height: 90vh; border-radius: 24px; border: 1px solid rgba(255,255,255,0.08); backdrop-filter: blur(40px); display: flex; flex-direction: row; overflow: hidden; animation: scale-in 0.5s cubic-bezier(0.165, 0.84, 0.44, 1); box-shadow: 0 50px 100px rgba(0,0,0,0.8);">
                    
                    <style>
                        @media (max-width: 1100px) {
                            #modal-container { flex-direction: column !important; width: 100% !important; border-radius: 0 !important; height: 100vh !important; }
                            #side-panel { width: 100% !important; border-left: none !important; border-top: 1px solid rgba(255,255,255,0.1) !important; }
                        }
                    </style>
                    
                    <!-- Close Button -->
                    <button onclick="document.getElementById('video-modal').remove()" 
                            style="position: absolute; top: 15px; right: 15px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); color: white; width: 40px; height: 40px; border-radius: 50%; font-size: 1.2rem; cursor: pointer; z-index: 100; transition: all 0.3s;">&times;</button>
                    
                    <!-- Left: Main Video & Info -->
                    <div style="flex: 1; min-width: 0; padding: 25px; overflow-y: auto;">
                        <!-- AI Assistant Button if AI keywords present -->
                        ${isAIRequest ? `
                            <div style="margin-bottom: 20px; background: linear-gradient(90deg, #111, #222); padding: 15px; border-radius: 12px; border: 1px solid rgba(255,0,85,0.3); display: flex; align-items: center; justify-content: space-between;">
                                <div style="display: flex; align-items: center; gap: 10px;">
                                    <i class="fas fa-robot" style="color: #ff0055; font-size: 1.5rem;"></i>
                                    <div>
                                        <div style="font-weight: 700;">Ask Vitox AI</div>
                                        <div style="font-size: 0.8rem; color: #aaa;">Get summaries, code explanations, or insights about this video.</div>
                                    </div>
                                </div>
                                <button onclick="askVitoxAI()" style="background: #ff0055; color: white; border: none; padding: 8px 16px; border-radius: 8px; font-weight: 700; cursor: pointer;">ASK AI</button>
                            </div>
                        ` : ''}
                        <!-- Ad Transparency Label -->
                        <div id="ad-info-box" style="margin-bottom: 12px; font-size: 0.7rem; font-weight: 700; opacity: 0.6; display: flex; align-items: center; gap: 6px; text-transform: uppercase; letter-spacing: 0.5px;">
                        </div>

                        <div style="width: 100%; aspect-ratio: 16/9; background: #000; border-radius: 20px; overflow: hidden; box-shadow: 0 10px 40px rgba(0,0,0,0.5); border: 1px solid rgba(255,255,255,0.05); position: relative;" id="video-container">
                            ${isLive ? '<div style="position: absolute; top: 20px; left: 20px; background: #ff0055; color: white; padding: 5px 12px; font-weight: 800; border-radius: 4px; z-index: 10; font-size: 0.8rem;">LIVE</div>' : ''}
                            <video id="content_video" class="video-js vjs-default-skin vjs-big-play-centered" controls preload="auto" style="width: 100%; height: 100%; object-fit: contain;">
                                <source src="${url}" type="video/mp4">
                            </video>
                        </div>

                        <div style="margin-top: 24px;">
                            <h1 style="font-size: 1.25rem; font-weight: 700; margin: 0 0 12px 0; line-height: 1.4; color: #fff;">${safeTitle}</h1>
                            
                            <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px;">
                                <div style="display: flex; align-items: center; gap: 14px;">
                                    <div style="width: 40px; height: 40px; border-radius: 50%; background: #333; display: flex; align-items: center; justify-content: center; font-weight: 600; color: white; border: 1px solid rgba(255,255,255,0.1); font-size: 1.1rem;">
                                        ${safeChannel.charAt(0).toUpperCase()}
                                    </div>
                                    <div>
                                        <div style="font-weight: 600; font-size: 1rem; display: flex; align-items: center; gap: 4px;">
                                            ${safeChannel.split('@')[0]} <i class="fas fa-check-circle" style="color: #aaa; font-size: 0.85rem;"></i>
                                        </div>
                                        <div style="font-size: 0.8rem; color: #aaa;" id="sub-count">0 Squad members</div>
                                    </div>
                                    ${isSelf ? '' : `
                                    <div style="display: flex; gap: 8px;">
                                        <button id="sub-btn" onclick="toggleSubscribe('${safeChannel}', '${safeId}')" 
                                            style="background: #fff; color: #000; border: none; padding: 10px 20px; border-radius: 20px; font-weight: 600; cursor: pointer; transition: all 0.2s; font-size: 0.9rem;">
                                            Join Squad
                                        </button>
                                        ${user ? `
                                            <button onclick="openCollabChat('${safeChannel}')" 
                                                style="background: #ff0055; color: #fff; border: none; padding: 10px 20px; border-radius: 20px; font-weight: 800; cursor: pointer; transition: 0.2s; font-size: 0.9rem; display: flex; align-items: center; gap: 8px;">
                                                <i class="fas fa-handshake"></i> Collab
                                            </button>
                                        ` : ''}
                                    </div>
                                    `}
                                </div>

                                <div style="display: flex; gap: 10px;">
                                    <div style="background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.08); border-radius: 30px; display: flex; overflow: hidden; backdrop-filter: blur(10px);">
                                        <button class="action-btn" id="like-btn" onclick="toggleLike('${safeId}', '${safeChannel}')" style="padding: 10px 18px; color: #fff; background: transparent; border: none; cursor: pointer; transition: all 0.2s;"><i class="fas fa-thumbs-up" style="margin-right: 8px;"></i> <span id="like-count">0</span></button>
                                        <div style="width: 1px; background: rgba(255,255,255,0.1); margin: 8px 0;"></div>
                                        <button class="action-btn" style="padding: 10px 18px; color: #fff; background: transparent; border: none; cursor: pointer; transition: all 0.2s;"><i class="fas fa-thumbs-down"></i></button>
                                    </div>
                                    <button class="action-btn secondary" onclick="shareVideo('${safeId}')" style="background: rgba(255,255,255,0.1); border: none; color: #fff; padding: 10px 20px; border-radius: 20px; font-weight: 600; cursor: pointer; transition: 0.2s; display: flex; align-items: center; gap: 8px; font-size: 0.9rem;">
                                        <i class="fas fa-share"></i> Share
                                    </button>
                                    <button class="action-btn secondary" id="bookmark-btn" onclick="toggleBookmark('${safeId}', '${url}', '${safeTitle}', '${safeChannel}')" style="background: rgba(255,255,255,0.1); border: none; color: #fff; padding: 10px 20px; border-radius: 20px; font-weight: 600; cursor: pointer; transition: 0.2s; display: flex; align-items: center; gap: 8px; font-size: 0.9rem;">
                                        <i class="fas fa-clock"></i> Save
                                    </button>
                                </div>
                            </div>

                                <div style="background: rgba(255,255,255,0.04); border: 1px solid rgba(255,255,255,0.05); border-radius: 16px; padding: 16px; margin-top: 24px; font-size: 0.95rem;">
                                    <div style="font-weight: 800; margin-bottom: 10px; color: #fff; display: flex; justify-content: space-between; align-items: center;">
                                        <span><span id="view-count">${initialViews}</span> views â€¢ Published on ${timeAgo}</span>
                                        <div style="display: flex; gap: 8px;">
                                            <button onclick="translateDescription('${safeId}', 'Hindi')" style="font-size: 0.7rem; background: rgba(255,0,85,0.1); color: #ff0055; border: 1px solid rgba(255,0,85,0.2); padding: 4px 8px; border-radius: 4px; cursor: pointer;">Hindi</button>
                                            <button onclick="translateDescription('${safeId}', 'English')" style="font-size: 0.7rem; background: rgba(255,255,255,0.05); color: #fff; border: 1px solid #333; padding: 4px 8px; border-radius: 4px; cursor: pointer;">EN</button>
                                        </div>
                                    </div>
                                    <p id="video-desc-text" style="color: #ddd; margin: 0; white-space: pre-wrap; line-height: 1.6;">${displayDesc}</p>
                                </div>

                                <!-- Comments Section -->
                                <div style="margin-top: 32px;">
                                    <h3 style="font-size: 1.1rem; font-weight: 800; margin-bottom: 20px;"><span id="comment-total">0</span> Comments</h3>
                                    
                                    <div style="display: flex; gap: 15px; margin-bottom: 30px;">
                                        <div style="width: 36px; height: 36px; border-radius: 50%; background: #333; flex-shrink: 0; display: flex; align-items: center; justify-content: center; font-weight: 600; color: white; border: 1px solid rgba(255,255,255,0.1);">
                                            ${user ? user.name.charAt(0).toUpperCase() : '?'}
                                        </div>
                                        <div style="flex: 1;">
                                            <input type="text" id="comment-input" placeholder="Add a comment..." 
                                                style="width: 100%; background: transparent; border: none; border-bottom: 1px solid rgba(255,255,255,0.2); color: white; padding: 8px 0; font-size: 0.95rem; outline: none; transition: border-bottom 0.3s;">
                                            <div id="comment-actions" style="display: none; justify-content: flex-end; gap: 12px; margin-top: 10px;">
                                                <button onclick="document.getElementById('comment-input').value=''; document.getElementById('comment-actions').style.display='none';" 
                                                    style="background:transparent; border:none; color:#aaa; font-weight:600; cursor:pointer;">Cancel</button>
                                                <button onclick="submitComment('${videoId}')" id="submit-comment-btn" 
                                                    style="background: #3ea6ff; border:none; color:#000; padding: 10px 24px; border-radius: 20px; font-weight:600; cursor:pointer; opacity:0.5; transition: 0.2s;" disabled>Comment</button>
                                            </div>
                                        </div>
                                    </div>

                                    <div id="comments-box" style="display: flex; flex-direction: column; gap: 24px;">
                                        <!-- Comments dynamic -->
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!--Right: Recommendations Section-- >
                    <div id="side-panel" style="width: 400px; border-left: 1px solid rgba(255,255,255,0.08); background: rgba(0,0,0,0.2); display: flex; flex-direction: column; padding: 25px;">
                        <div style="display: flex; gap: 8px; overflow-x: auto; margin-bottom: 20px; padding-bottom: 10px;" class="pill-filters">
                            <span class="pill active">All</span>
                            <span class="pill">Related</span>
                            <span class="pill">Recently uploaded</span>
                        </div>
                        <style>
                            .pill {background: rgba(255,255,255,0.05); padding: 8px 16px; border-radius: 8px; font-size: 0.85rem; font-weight: 600; cursor: pointer; white-space: nowrap; transition: 0.2s; }
                            .pill.active {background: #fff; color: #000; }
                            .pill:hover:not(.active) {background: rgba(255,255,255,0.1); }
                        </style>
                        <div id="related-videos" style="flex: 1; overflow-y: auto; display: flex; flex-direction: column; gap: 15px;">
                            <!-- Dynamically loaded -->
                        </div>
                    </div>
                    </div >
                </div >
                    `;
                document.body.appendChild(playerOverlay);
                document.body.style.overflow = 'hidden';

                // Initialize Video.js and IMA
                let player = videojs('content_video');
                let options = {
                    id: 'content_video',
                    adTagUrl: 'https://pubads.g.doubleclick.net/gampad/ads?iu=/21775744923/external/single_ad_samples&sz=640x480&cust_params=sample_ct%3Dlinear&ciu_szs=300x250%2C728x90&gdfp_req=1&output=vast&unviewed_position_start=1&env=vp&impl=s&correlator='
                };
                player.ima(options);

                // Auto-play the content after ad or if ad fails
                player.ready(() => {
                    player.play();
                });

                // Add simple logic to fill recommendations for visual flair
                const relatedGrid = document.getElementById('related-videos');
                fetch('/api/videos')
                    .then(r => r.json())
                    .then(vids => {
                        relatedGrid.innerHTML = '';
                        // Filter out current video
                        vids.filter(v => v.id != videoId).slice(0, 10).forEach(v => {
                            const item = document.createElement('div');
                            item.style.cssText = `
                display: flex; gap: 12px; cursor: pointer; transition: all 0.3s;
                padding: 8px; border - radius: 12px;
                `;
                            item.innerHTML = `
                    <div style = "width: 140px; height: 80px; flex-shrink: 0; border-radius: 8px; overflow: hidden; background: #222; border: 1px solid rgba(255,255,255,0.05); position: relative;" >
                        <video src="${v.type === 'live' ? 'https://res.cloudinary.com/demo/video/upload/sp_auto/dog.mp4' : v.video_url}" muted style="width: 100%; height: 100%; object-fit: cover;"></video>
                        ${v.type === 'live' ? '<div style="position: absolute; bottom: 4px; right: 4px; background: #ff0055; color: white; padding: 2px 6px; font-size: 0.6rem; font-weight: 800; border-radius: 4px;">LIVE</div>' : ''}
                            </div>
                    <div style="flex: 1; min-width: 0;">
                        <div style="font-weight: 700; font-size: 0.9rem; line-height: 1.2; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; color: #fff;">${v.title}</div>
                        <div style="font-size: 0.75rem; color: #aaa; margin-top: 4px;">${v.user_email.split('@')[0]}</div>
                        <div style="font-size: 0.75rem; color: #888;">${v.type === 'live' ? '<span style="color:#ff0055;">Live</span>' : (v.views + ' views')}</div>
                    </div>
                `;
                            item.onmouseover = () => {
                                item.style.background = 'rgba(255,255,255,0.05)';
                                if (v.type !== 'live') item.querySelector('video').play(); // Don't autoplay live placeholder
                            };
                            item.onmouseout = () => {
                                item.style.background = 'transparent';
                                if (v.type !== 'live') item.querySelector('video').pause();
                            };
                            item.onclick = () => {
                                document.getElementById('video-modal').remove();
                                playVideo(v.video_url, v.title, v.user_email, v.views, v.timestamp, v.description, v.id, v.type || 'video');
                            };
                            relatedGrid.appendChild(item);
                        });
                    });
                // Setup Comment Input Logic
                const commentInput = document.getElementById('comment-input');
                const commentActions = document.getElementById('comment-actions');
                const submitBtn = document.getElementById('submit-comment-btn');

                commentInput.onfocus = () => commentActions.style.display = 'flex';
                commentInput.oninput = () => {
                    submitBtn.disabled = !commentInput.value.trim();
                    submitBtn.style.opacity = commentInput.value.trim() ? '1' : '0.5';
                };

                // Load Real Engagement Stats
                loadEngagementStats(safeId, safeChannel);
                loadComments(safeId);

                const originalRemove = playerOverlay.remove.bind(playerOverlay);
                playerOverlay.remove = function () {
                    if (player) {
                        player.dispose();
                    }
                    document.body.style.overflow = '';
                    originalRemove();
                    loadVideos(); // Refresh home grid views
                };
            }

            async function loadEngagementStats(videoId, channelEmail) {
                const user = JSON.parse(localStorage.getItem('vitox_user'));
                try {
                    const res = await fetch(`/api/video/stats/${videoId}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            email: user ? user.email : '',
                            channel_email: channelEmail
                        })
                    });
                    const stats = await res.json();

                    const likeCountEl = document.getElementById('like-count');
                    if (likeCountEl) likeCountEl.innerText = stats.likes.toLocaleString();

                    const subCountEl = document.getElementById('sub-count');
                    if (subCountEl) subCountEl.innerText = `${stats.subscribers} Squad members`;

                    const commCountEl = document.getElementById('comment-total');
                    if (commCountEl) commCountEl.innerText = stats.comment_count.toLocaleString();

                    const likeBtn = document.getElementById('like-btn');
                    if (likeBtn) likeBtn.style.color = stats.liked ? '#ff003c' : '#fff';

                    // Sync Snap UI if it exists
                    const snapLikeCount = document.getElementById(`snap-like-count-${videoId}`);
                    if (snapLikeCount) snapLikeCount.innerText = stats.likes;
                    const snapLikeIcon = document.getElementById(`snap-like-icon-${videoId}`);
                    if (snapLikeIcon) snapLikeIcon.style.color = stats.liked ? '#ff003c' : '#fff';
 
                    const subBtn = document.getElementById('sub-btn');
                    if (subBtn) {
                        subBtn.innerHTML = stats.subbed ? 'In Squad' : 'Join Squad';
                        subBtn.style.background = stats.subbed ? 'rgba(255,255,255,0.1)' : '#fff';
                        subBtn.style.color = stats.subbed ? '#fff' : '#000';
                        subBtn.style.border = stats.subbed ? '1px solid rgba(255,255,255,0.1)' : 'none';
                    }

                    // Dynamically Show Correct AdSense ID (Technical IDs hidden for users)
                    const adInfoBox = document.getElementById('ad-info-box');
                    if (adInfoBox) {
                        if (stats.creator_adsense) {
                            adInfoBox.innerHTML = `<i class="fas fa-certificate" style="color:#00ff88;"></i> Verified Creator Content`;
                            adInfoBox.style.color = '#00ff88';
                        } else {
                            adInfoBox.innerHTML = `<i class="fas fa-ad" style="color:#ff0055;"></i> Sponsored`;
                            adInfoBox.style.color = '#ff0055';
                        }
                    }
                } catch (e) {
                    // Silently fail engagement stats sync
                }
            }

            async function loadComments(videoId) {
                try {
                    const res = await fetch(`/api/video/comments/${videoId}`);
                    const comments = await res.json();
                    const box = document.getElementById('comments-box');
                    if (!box) return;
                    box.innerHTML = '';

                    if (comments.length === 0) {
                        box.innerHTML = '<div style="color: #888; text-align: center; padding: 20px;">No comments yet.</div>';
                        return;
                    }

                    comments.forEach(c => {
                        const el = document.createElement('div');
                        el.style.display = 'flex';
                        el.style.gap = '15px';
                        el.style.animation = 'fade-up 0.5s cubic-bezier(0.165, 0.84, 0.44, 1) forwards';
                        el.style.opacity = '0';
                        el.innerHTML = `
                    <div style="width: 40px; height: 40px; border-radius: 50%; background: #333; display: flex; align-items: center; justify-content: center; font-weight: 800; font-size: 0.9rem;">
                        ${c.user_email.charAt(0).toUpperCase()}
                    </div>
                    <div>
                        <div style="font-size: 0.85rem; margin-bottom: 4px;">
                            <span style="font-weight: 800;">@${c.user_email.split('@')[0]}</span>
                            <span style="color: #aaa; margin-left: 8px;">${new Date(c.timestamp).toLocaleDateString()}</span>
                        </div>
                        <div style="font-size: 0.95rem; line-height: 1.4; color: #eee;">${c.content}</div>
                        <div style="display: flex; gap: 16px; margin-top: 8px; color: #aaa; font-size: 0.8rem;">
                            <span><i class="far fa-thumbs-up"></i></span>
                            <span><i class="far fa-thumbs-down"></i></span>
                            <span style="font-weight: 700; color: #fff; cursor: pointer;">REPLY</span>
                        </div>
                    </div>
                `;
                        box.appendChild(el);
                    });
                } catch (e) { console.error(e); }
            }

            // AI Modal Logic
            function askVitoxAI() {
                const modalId = 'vitox-ai-modal';
                if (document.getElementById(modalId)) return;

                const modal = document.createElement('div');
                modal.id = modalId;
                modal.style.cssText = `
                        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                        background: rgba(0,0,0,0.85); z-index: 6000;
                        display: flex; align-items: center; justify-content: center;
                        backdrop-filter: blur(10px);
                     `;
                modal.innerHTML = `
                        <div style="width: 600px; max-width: 90%; background: #0a0a0a; border: 1px solid #333; border-radius: 20px; box-shadow: 0 0 50px rgba(0,0,0,0.8); overflow: hidden; display: flex; flex-direction: column;">
                            <div style="padding: 20px; border-bottom: 1px solid #222; display: flex; justify-content: space-between; align-items: center; background: linear-gradient(90deg, #111, #1a1a1a);">
                                <div style="display: flex; align-items: center; gap: 10px;">
                                    <i class="fas fa-robot" style="color: #ff0055; font-size: 1.2rem;"></i>
                                    <h3 style="margin: 0; font-weight: 700;">Vitox AI Intelligence</h3>
                                </div>
                                <button onclick="document.getElementById('${modalId}').remove()" style="background: none; border: none; color: #888; font-size: 1.2rem; cursor: pointer;">&times;</button>
                            </div>
                            
                            <div style="padding: 24px; flex: 1;">
                                <div style="margin-bottom: 20px;">
                                    <label style="display: block; color: #aaa; font-size: 0.8rem; margin-bottom: 8px;">SELECT MODEL</label>
                                    <select id="ai-model-select" style="width: 100%; padding: 12px; background: #111; border: 1px solid #333; border-radius: 8px; color: white; outline: none; font-family: 'Outfit', sans-serif;">
                                        <option value="gemini-flash">Gemini 1.5 Flash (Fast & Free)</option>
                                        <option value="gemini-pro">Gemini 1.5 Pro (Recommended)</option>
                                        <option value="llama-3-free">Llama 3 8B (OpenRouter Free)</option>
                                        <option value="mistral-free">Mistral 7B (OpenRouter Free)</option>
                                        <option value="google-gemma-free">Gemma 7B (Google Free)</option>
                                    </select>
                                </div>

                                <div style="margin-bottom: 20px;">
                                    <textarea id="ai-prompt" placeholder="Ask anything about this video..." style="width: 100%; height: 100px; background: #111; border: 1px solid #333; border-radius: 12px; color: white; padding: 16px; outline: none; resize: none; font-family: 'Outfit', sans-serif;"></textarea>
                                </div>

                                <div id="ai-response-area" style="min-height: 100px; background: rgba(255,0,85,0.05); border: 1px dashed rgba(255,0,85,0.2); border-radius: 12px; padding: 16px; margin-bottom: 20px; font-size: 0.9rem; line-height: 1.6; color: #eee; display: none;">
                                    <!-- AI Response -->
                                </div>

                                <button onclick="runVitoxAI()" id="run-ai-btn" style="width: 100%; padding: 14px; background: #ff0055; color: white; border: none; border-radius: 12px; font-weight: 700; cursor: pointer; transition: 0.2s;">
                                    <i class="fas fa-sparkles"></i> GENERATE INSIGHTS
                                </button>
                            </div>
                        </div>
                     `;
                document.body.appendChild(modal);
            }

            async function runVitoxAI() {
                const prompt = document.getElementById('ai-prompt').value;
                const model = document.getElementById('ai-model-select').value;
                const resultArea = document.getElementById('ai-response-area');
                const btn = document.getElementById('run-ai-btn');

                if (!prompt.trim()) return showToast("Please enter a prompt");

                btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ANALYZING VIDEO...';
                btn.disabled = true;
                btn.style.opacity = '0.7';

                const user = JSON.parse(localStorage.getItem('vitox_user'));
                try {
                    const res = await fetch('/api/ai/ask', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ prompt, model, email: user ? user.email : null })
                    });
                    const data = await res.json();

                    resultArea.style.display = 'block';
                    resultArea.innerHTML = `
                        <strong style="color: #ff0055;">Vitox AI (${model.replace(/-/g, ' ')}):</strong><br><br>
                        ${data.answer || "No response received."}
                    `;
                } catch (e) {
                    console.error("AI Assistant Error:", e);
                    showToast("AI Request Failed");
                } finally {
                    btn.innerHTML = '<i class="fas fa-sparkles"></i> GENERATE INSIGHTS';
                    btn.disabled = false;
                    btn.style.opacity = '1';
                }
            }

            // Administrative Panel Logic
            async function loadAdminPanel() {
                const user = JSON.parse(localStorage.getItem('vitox_user'));
                if (!user || user.email !== 'junaidshah78634@gmail.com') {
                    showToast("Access Denied: Admin only");
                    loadVideos();
                    return;
                }

                const grid = document.getElementById('main-video-grid');
                const emptyState = document.getElementById('empty-state');
                if (emptyState) emptyState.style.display = 'none';
                grid.innerHTML = '<div style="padding: 40px; color: white; width: 100%; text-align:center;"><h2><i class="fas fa-cog fa-spin"></i> Initializing Command Center...</h2></div>';

                try {
                    // Fetch Stats
                    const statsRes = await fetch('/api/admin/stats', { headers: { 'X-Admin-Email': user.email } });
                    const stats = await statsRes.json();

                    // Fetch Users
                    const usersRes = await fetch('/api/admin/users', { headers: { 'X-Admin-Email': user.email } });
                    const allUsers = await usersRes.json();
                    
                    // Fetch Bug Reports
                    const bugsRes = await fetch('/api/admin/bugs', { headers: { 'X-Admin-Email': user.email } });
                    const allBugs = await bugsRes.json();

                    grid.innerHTML = `
                    <div style="padding: 40px; color: white; width: 100%;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 40px;">
                            <h1 style="font-size: 2.5rem; font-weight: 800; margin:0;">Admin Command Center</h1>
                            <div style="background: #ff0055; padding: 10px 20px; border-radius: 12px; font-weight: 800; font-size: 0.9rem;">PLATFORM OWNER</div>
                        </div>

                        <!-- Quick Stats -->
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 40px;">
                            <div style="background: rgba(255,255,255,0.05); padding: 24px; border-radius: 16px; border: 1px solid rgba(255,255,255,0.1);">
                                <div style="color: #aaa; font-size: 0.8rem; margin-bottom: 8px;">TOTAL USERS</div>
                                <div style="font-size: 1.8rem; font-weight: 800;">${stats.users}</div>
                            </div>
                            <div style="background: rgba(255,255,255,0.05); padding: 24px; border-radius: 16px; border: 1px solid rgba(255,255,255,0.1);">
                                <div style="color: #aaa; font-size: 0.8rem; margin-bottom: 8px;">TOTAL VIDEOS</div>
                                <div style="font-size: 1.8rem; font-weight: 800;">${stats.videos}</div>
                            </div>
                            <div style="background: rgba(255,255,255,0.05); padding: 24px; border-radius: 16px; border: 1px solid rgba(255,255,255,0.1);">
                                <div style="color: #aaa; font-size: 0.8rem; margin-bottom: 8px;">TOTAL VIEWS</div>
                                <div style="font-size: 1.8rem; font-weight: 800;">${(stats.views / 1000).toFixed(1)}k</div>
                            </div>
                            <div style="background: rgba(255,255,255,0.05); padding: 24px; border-radius: 16px; border: 1px solid rgba(255,255,255,0.1);">
                                <div style="color: #aaa; font-size: 0.8rem; margin-bottom: 8px;">TOTAL SQUARES</div>
                                <div style="font-size: 1.8rem; font-weight: 800;">${(stats.points / 1000).toFixed(1)}k</div>
                            </div>
                        </div>

                        <!--User Management-- >
                        <h3 style="margin-bottom: 20px;">User Management</h3>
                        <div style="background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.1); border-radius: 20px; overflow: hidden;">
                            <table style="width: 100%; border-collapse: collapse; font-size: 0.9rem;">
                                <thead style="background: rgba(255,255,255,0.05);">
                                    <tr>
                                        <th style="padding: 16px; text-align: left;">User</th>
                                        <th style="padding: 16px; text-align: left;">Status</th>
                                        <th style="padding: 16px; text-align: left;">Points</th>
                                        <th style="padding: 16px; text-align: right;">Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${allUsers.map(u => `
                                        <tr style="border-bottom: 1px solid rgba(255,255,255,0.05);">
                                            <td style="padding: 16px;">
                                                <div style="font-weight: 700;">${u.name}</div>
                                                <div style="font-size: 0.8rem; color: #888;">${u.email}</div>
                                            </td>
                                            <td style="padding: 16px;">
                                                ${u.status === 'banned' ? '<span style="color: #ff4444;">Banned</span>' : (u.status === 'pending_brand' ? '<span style="color: #ffaa00;">Pending Brand</span>' : '<span style="color: #00ff88;">Active</span>')}
                                                ${u.is_verified_brand ? ' <i class="fas fa-check-circle" style="color: #00ff88;" title="Verified Brand"></i>' : ''}
                                            </td>
                                            <td style="padding: 16px;">${u.points}</td>
                                            <td style="padding: 16px; text-align: right; display: flex; gap: 8px; justify-content: flex-end;">
                                                ${u.status === 'pending_brand' ? `
                                                    <button onclick="adminUserAction('${u.email}', 'verify_brand')" style="background: #00ff88; color: black; border: none; padding: 6px 12px; border-radius: 6px; font-weight: 800; cursor: pointer;">APPROVE</button>
                                                ` : ''}
                                                ${u.status === 'banned' ? `
                                                    <button onclick="adminUserAction('${u.email}', 'unban')" style="background: white; color: black; border: none; padding: 6px 12px; border-radius: 6px; font-weight: 800; cursor: pointer;">UNBAN</button>
                                                ` : `
                                                    <button onclick="adminUserAction('${u.email}', 'ban')" style="background: rgba(255,0,0,0.2); color: #ff4444; border: 1px solid #ff4444; padding: 6px 12px; border-radius: 6px; font-weight: 800; cursor: pointer;">BAN</button>
                                                `}
                                                <button onclick="openAdminChat('${u.email}')" style="background: #ffd700; color: black; border: none; padding: 6px 12px; border-radius: 6px; font-weight: 800; cursor: pointer;"><i class="fas fa-comment"></i> CHAT</button>
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                        </div>
                        
                        <!-- Bug Reports Management -->
                        <h3 style="margin-top: 40px; margin-bottom: 20px; display:flex; align-items:center; gap:12px;">Platform Bug Reports <span style="background:#ff5500; color:white; font-size:0.8rem; padding: 4px 10px; border-radius: 20px;">${allBugs.filter(b=>b.status==='open').length} Open</span></h3>
                        <div style="background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.1); border-radius: 20px; overflow: hidden; margin-bottom: 40px;">
                            <table style="width: 100%; border-collapse: collapse; font-size: 0.9rem;">
                                <thead style="background: rgba(255,255,255,0.05);">
                                    <tr>
                                        <th style="padding: 16px; text-align: left; width: 20%;">Reporter</th>
                                        <th style="padding: 16px; text-align: left; width: 40%;">Issue Details</th>
                                        <th style="padding: 16px; text-align: left; width: 15%;">Status</th>
                                        <th style="padding: 16px; text-align: right; width: 25%;">Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${allBugs.length === 0 ? '<tr><td colspan="4" style="padding: 30px; text-align: center; color: #888;">No bugs reported yet. Platform is flawless! 🚀</td></tr>' : ''}
                                    ${allBugs.map(b => `
                                        <tr style="border-bottom: 1px solid rgba(255,255,255,0.05); opacity: ${b.status==='resolved' ? '0.6' : '1'};">
                                            <td style="padding: 16px; vertical-align: top;">
                                                <div style="font-weight: 700; color: #ccc;">${b.user_email.split('@')[0]}</div>
                                                <div style="font-size: 0.75rem; color: #777;">${new Date(b.timestamp).toLocaleDateString()}</div>
                                            </td>
                                            <td style="padding: 16px;">
                                                <div style="font-weight: 700; margin-bottom: 6px; color: ${b.status==='open' ? '#ffaa00' : '#888'};">${b.title}</div>
                                                <div style="font-size: 0.85rem; color: #bbb; line-height: 1.5;">${b.description}</div>
                                                ${b.screenshot_url ? `<a href="${b.screenshot_url}" target="_blank" style="display:inline-block; margin-top:8px; font-size:0.8rem; color:#0088ff; text-decoration:none;"><i class="fas fa-image"></i> View Screenshot</a>` : ''}
                                            </td>
                                            <td style="padding: 16px; vertical-align: top;">
                                                <span style="background: ${b.status==='open' ? 'rgba(255,85,0,0.1)' : 'rgba(0,255,136,0.1)'}; color: ${b.status==='open' ? '#ff5500' : '#00ff88'}; padding: 4px 10px; border-radius: 6px; font-size: 0.8rem; font-weight: 700;">${b.status.toUpperCase()}</span>
                                            </td>
                                            <td style="padding: 16px; text-align: right; vertical-align: top;">
                                                ${b.status==='open' ? `
                                                    <button onclick="adminBugAction(${b.id}, 'resolved')" style="background: #00ff88; color: black; border: none; padding: 6px 12px; border-radius: 6px; font-weight: 800; cursor: pointer;">MARK RESOLVED</button>
                                                ` : `
                                                    <button onclick="adminBugAction(${b.id}, 'open')" style="background: transparent; color: #888; border: 1px solid #555; padding: 6px 12px; border-radius: 6px; font-weight: 800; cursor: pointer;">RE-OPEN</button>
                                                `}
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div >
                    `;
                } catch (e) { console.error(e); grid.innerHTML = '<h2>Failed to load Admin Panel. Try again.</h2>'; }
            }

            async function adminUserAction(email, action) {
                const user = JSON.parse(localStorage.getItem('vitox_user'));
                try {
                    const res = await fetch('/api/admin/user/action', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'X-Admin-Email': user.email },
                        body: JSON.stringify({ email, action })
                    });
                    const data = await res.json();
                    showToast(data.message);
                    loadAdminPanel(); // Refresh UI
                } catch (e) { console.error(e); }
            }
            
            async function adminBugAction(bugId, status) {
                const user = JSON.parse(localStorage.getItem('vitox_user'));
                try {
                    const res = await fetch('/api/admin/bugs/action', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'X-Admin-Email': user.email },
                        body: JSON.stringify({ id: bugId, status: status })
                    });
                    const data = await res.json();
                    showToast(data.message);
                    loadAdminPanel(); // Refresh UI immediately
                } catch (e) { console.error(e); }
            }

            async function submitBugReport() {
                const title = document.getElementById('bug-title').value.trim();
                const desc = document.getElementById('bug-desc').value.trim();
                const img = document.getElementById('bug-img-url').value.trim();
                const user = JSON.parse(localStorage.getItem('vitox_user') || '{}');
                
                if(!title || !desc) return showToast("Title and Description are required.");
                
                try {
                    const res = await fetch('/api/bugs/report', {
                        method: 'POST', headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ email: user.email || 'anonymous', title: title, description: desc, screenshot_url: img })
                    });
                    const data = await res.json();
                    if(res.ok) {
                        showToast("Bug reported! Thank you.");
                        document.getElementById('bug-report-modal').style.display = 'none';
                        document.getElementById('bug-title').value = '';
                        document.getElementById('bug-desc').value = '';
                        document.getElementById('bug-img-url').value = '';
                        document.getElementById('bug-upload-status').innerHTML = '';
                    } else {
                        showToast(data.message);
                    }
                } catch(e) { console.error(e); showToast("Failed to submit error report"); }
            }

            async function uploadBugScreenshot(input) {
                if (!input.files || !input.files[0]) return;
                const file = input.files[0];
                const status = document.getElementById('bug-upload-status');
                const urlInput = document.getElementById('bug-img-url');

                status.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Uploading...';

                const formData = new FormData();
                formData.append('image', file);

                try {
                    const res = await fetch('/api/image/upload', {
                        method: 'POST',
                        body: formData
                    });
                    const data = await res.json();
                    if (data.url) {
                        urlInput.value = data.url;
                        status.innerHTML = '<span style="color: #00ff88;"><i class="fas fa-check"></i> Ready</span>';
                    } else {
                        status.innerHTML = '<span style="color: #ff0055;">Failed</span>';
                        showToast(data.error || "Upload failed");
                    }
                } catch (e) {
                    console.error(e);
                    status.innerHTML = '<span style="color: #ff0055;">Error</span>';
                }
            }

            // --- OFFICIAL ADMIN CHAT LOGIC ---
            let adminChatPoller = null;

            function openAdminChat(targetUserEmail) {
                const admin = JSON.parse(localStorage.getItem('vitox_user'));
                if (!admin) { showToast("Login required"); return; }

                const isPlatformAdmin = admin.email === 'junaidshah78634@gmail.com';

                // If not admin, target is admin by default (Support Line)
                if (!isPlatformAdmin) {
                    targetUserEmail = 'junaidshah78634@gmail.com';
                }

                // If platform admin clicks sidebar link without target
                if (isPlatformAdmin && !targetUserEmail) {
                    showToast("Loading Admin Panel...");
                    loadView('Admin Panel');
                    return;
                }

                if (!targetUserEmail) {
                    showToast("Support line unavailable");
                    return;
                }

                const drawer = document.getElementById('admin-chat-drawer');
                if (drawer) drawer.style.right = '0';

                const targetDisplay = targetUserEmail === 'junaidshah78634@gmail.com' ? "Official Support" : `@${targetUserEmail.split('@')[0]} `;
                const targetEl = document.getElementById('admin-chat-target');
                if (targetEl) targetEl.innerText = `Direct Line to: ${targetDisplay} `;

                loadAdminHistory(targetUserEmail);

                const sendBtn = document.getElementById('admin-chat-send');
                if (sendBtn) sendBtn.onclick = () => sendAdminMsg(targetUserEmail);

                if (adminChatPoller) clearInterval(adminChatPoller);
                adminChatPoller = setInterval(() => loadAdminHistory(targetUserEmail, true), 3000);
            }

            function closeAdminChat() {
                const drawer = document.getElementById('admin-chat-drawer');
                if (drawer) drawer.style.right = '-100%';
                if (adminChatPoller) clearInterval(adminChatPoller);
            }

            async function loadAdminHistory(targetEmail, isPolling = false) {
                try {
                    const res = await fetch(`/api/admin/chat/history?email=${targetEmail}`);
                    const msgs = await res.json();
                    const content = document.getElementById('admin-messages-content');
                    if (!content) return;

                    const wasAtBottom = content.scrollHeight - content.clientHeight <= content.scrollTop + 50;

                    content.innerHTML = msgs.map(m => {
                        const isSystem = m.sender_email === 'junaidshah78634@gmail.com';
                        const admin = JSON.parse(localStorage.getItem('vitox_user'));
                        const isMe = m.sender_email === admin.email;

                        return `
                    <div style="align-self: ${isMe ? 'flex-end' : 'flex-start'}; max-width: 85%;">
                                <div style="background: ${isSystem ? 'linear-gradient(135deg, #ffd700, #ffaa00)' : '#1a1a1a'}; 
                                            color: ${isSystem ? 'black' : 'white'}; 
                                            padding: 14px 18px; 
                                            border-radius: ${isMe ? '18px 18px 4px 18px' : '18px 18px 18px 4px'}; 
                                            font-size: 0.95rem; 
                                            border: 1px solid ${isSystem ? '#ffd700' : 'rgba(255,255,255,0.05)'};
                                            box-shadow: ${isSystem ? '0 5px 15px rgba(255,215,0,0.2)' : 'none'};
                                            font-weight: ${isSystem ? '700' : 'normal'};">
                                    ${isSystem ? '<i class="fas fa-shield-halved" style="margin-right:8px; opacity:0.6;"></i>' : ''}
                                    ${m.content}
                                </div>
                                <div style="font-size: 0.7rem; color: #888; margin-top: 6px; text-align: ${isMe ? 'right' : 'left'}; display: flex; align-items: center; justify-content: ${isMe ? 'flex-end' : 'flex-start'}; gap: 5px;">
                                    ${isSystem ? '<span style="color:#ffd700; font-weight:900;">OFFICIAL</span>' : ''}
                                    ${new Date(m.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}
                                </div>
                            </div>
                    `;
                    }).join('');

                    if (!isPolling || wasAtBottom) content.scrollTop = content.scrollHeight;
                } catch (e) { console.error(e); }
            }

            async function sendAdminMsg(targetEmail) {
                const input = document.getElementById('admin-chat-input');
                const content = input.value.trim();
                if (!content) return;

                const user = JSON.parse(localStorage.getItem('vitox_user'));
                const isAdmin = user && user.email === 'junaidshah78634@gmail.com';

                try {
                    const url = isAdmin ? '/api/admin/chat/send' : '/api/collab/chat/send';
                    const res = await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'X-Admin-Email': user.email },
                        body: JSON.stringify({
                            sender_email: user.email,
                            receiver_email: isAdmin ? targetEmail : 'junaidshah78634@gmail.com',
                            content: content
                        })
                    });
                    if (res.ok) {
                        input.value = '';
                        loadAdminHistory(targetEmail);
                    }
                } catch (e) { console.error(e); }
            }

            async function submitPost() {
                const user = JSON.parse(localStorage.getItem('vitox_user'));
                if (!user) return showToast("Login required!");

                const content = document.getElementById('post-content').value.trim();
                const imageUrl = document.getElementById('post-image').value.trim();

                if (!content) return showToast("Post content cannot be empty");

                try {
                    const res = await fetch('/api/posts/create', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ user_email: user.email, content, image_url: imageUrl })
                    });
                    if (res.ok) {
                        showToast("Post published to your Squad!");
                        document.getElementById('create-post-modal').style.display = 'none';
                        document.getElementById('post-content').value = '';
                        document.getElementById('post-image').value = '';
                        loadView('Squad');
                    }
                } catch (e) { console.error(e); }
            }

            async function loadCommunityFeed() {
                const grid = document.getElementById('main-video-grid');
                if (grid) grid.innerHTML = '<div style="padding: 40px; text-align: center;"><h2><i class="fas fa-sync fa-spin"></i> Syncing Squad Feed...</h2></div>';

                try {
                    const res = await fetch('/api/posts');
                    const posts = await res.json();

                    grid.innerHTML = `
                    <div style="padding: 40px; max-width: 800px; margin: 0 auto; width: 100%;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 40px;">
                            <h1 style="font-weight: 800; font-size: 2.2rem; margin:0;">Squad Community</h1>
                            <button onclick="document.getElementById('create-post-modal').style.display='flex'" style="padding: 10px 20px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.1); color: white; border-radius: 12px; font-weight: 700; cursor: pointer;">
                                <i class="fas fa-plus"></i> New Post
                            </button>
                        </div>
                        
                        ${posts.length === 0 ? '<div style="text-align:center; padding: 100px 0; color: #888;"><h3>No posts in your community yet.</h3><p>Be the first to share something!</p></div>' : ''}

                <div style="display: flex; flex-direction: column; gap: 24px;">
                    ${posts.map(p => `
                                <div style="background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.08); border-radius: 20px; padding: 24px;">
                                    <div style="display: flex; gap: 15px; align-items: center; margin-bottom: 16px;">
                                        <div style="width: 44px; height: 44px; background: #333; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 800; font-size: 1.1rem;">
                                            ${p.user_email.charAt(0).toUpperCase()}
                                        </div>
                                        <div>
                                            <div style="font-weight: 700; font-size: 1rem;">@${p.user_email.split('@')[0]} <i class="fas fa-check-circle" style="color: #00ff88; font-size: 0.8rem;"></i></div>
                                            <div style="font-size: 0.8rem; color: #888;">${new Date(p.timestamp).toLocaleDateString()}</div>
                                        </div>
                                    </div>
                                    <div style="font-size: 1.1rem; line-height: 1.6; color: #eee; white-space: pre-wrap; margin-bottom: 20px;">${p.content}</div>
                                    ${p.image_url ? `<img src="${p.image_url}" style="width: 100%; border-radius: 16px; margin-bottom: 20px; border: 1px solid rgba(255,255,255,0.05);">` : ''}
                                    <div style="display: flex; gap: 24px; color: #aaa; font-size: 0.9rem;">
                                        <span style="cursor: pointer;"><i class="fas fa-thumbs-up"></i> ${p.likes || 0}</span>
                                        <span style="cursor: pointer;"><i class="fas fa-comment"></i> Reply</span>
                                        <span style="cursor: pointer;"><i class="fas fa-share"></i></span>
                                    </div>
                                </div>
                            `).join('')}
                </div>
                    </div>
                    `;
                } catch (e) { console.error(e); }
            }

            function toggleNotifications() {
                const drawer = document.getElementById('notification-drawer');
                if (drawer.style.right === '0px') {
                    drawer.style.right = '-100%';
                } else {
                    drawer.style.right = '0';
                }
            }

            function simulateLiveChat() {
                const chatContent = document.getElementById('live-chat-content');
                const messages = [
                    "LOVE FROM INDIA! ðŸ‡®ðŸ‡³",
                    "Great quality stream!",
                    "Can you show your setup?",
                    "This is lit! ðŸ”¥",
                    "Helloooo!",
                    "Squad assemble!",
                    "Best creator ever!",
                    "Play some music!",
                    "Anyone from Mumbai?",
                    "Checking in from NYC! ðŸ—½"
                ];
                const users = ["Alex", "Deepak", "Sarah", "Raj", "Luna", "Kevin", "Zoya", "Mano", "Tyson"];

                if (liveChatInterval) clearInterval(liveChatInterval);
                if (window.streamTimer) clearInterval(window.streamTimer);

                let startTime = Date.now();
                window.streamTimer = setInterval(() => {
                    let elapsed = Date.now() - startTime;
                    let h = Math.floor(elapsed / 3600000);
                    let m = Math.floor((elapsed % 3600000) / 60000);
                    let s = Math.floor((elapsed % 60000) / 1000);
                    let display = [h, m, s].map(v => v < 10 ? '0' + v : v).join(':');
                    const durEl = document.getElementById('stream-duration');
                    if (durEl) durEl.innerText = display;
                }, 1000);

                liveChatInterval = setInterval(() => {
                    if (!document.getElementById('live-chat-content')) {
                        clearInterval(liveChatInterval);
                        clearInterval(window.streamTimer);
                        return;
                    }
                    const randomUser = users[Math.floor(Math.random() * users.length)];
                    const randomMsg = messages[Math.floor(Math.random() * messages.length)];

                    const msgEl = document.createElement('div');
                    msgEl.innerHTML = `<span style="color: #888; font-weight: 700;">${randomUser}:</span> ${randomMsg}`;
                    chatContent.appendChild(msgEl);
                    chatContent.scrollTop = chatContent.scrollHeight;

                    // Update views slightly
                    const viewEl = document.getElementById('view-count-header');
                    if (viewEl) {
                        let current = parseInt(viewEl.innerText.replace(',', '')) || 1200;
                        current += Math.floor(Math.random() * 5);
                        viewEl.innerText = current.toLocaleString();
                    }

                    const likeEl = document.getElementById('like-count-header');
                    if (likeEl) {
                        let current = parseInt(likeEl.innerText.replace(',', '')) || 450;
                        if (Math.random() > 0.7) current += 1;
                        likeEl.innerText = current.toLocaleString();
                    }
                }, 3000);
            }

            function stopStreaming() {
                const user = JSON.parse(localStorage.getItem('vitox_user'));
                if (window.currentLiveId && user) {
                    fetch('/api/video/delete', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ video_id: window.currentLiveId, email: user.email })
                    }).then(() => {
                        window.currentLiveId = null;
                    });
                }
                if (liveChatInterval) clearInterval(liveChatInterval);
                if (window.streamTimer) clearInterval(window.streamTimer);
                if (liveAlertInterval) clearInterval(liveAlertInterval);
                if (liveHeartsInterval) clearInterval(liveHeartsInterval);
                stopLiveMedia();
                showToast("Broadcast ended successfully!");
                loadVideos();
            }

            let liveAlertInterval = null;

            function runLiveCountdown() {
                let count = 10;
                const timerEl = document.getElementById('countdown-timer');
                const overlay = document.getElementById('live-countdown-overlay');

                const timer = setInterval(() => {
                    count--;
                    timerEl.innerText = count;
                    if (count <= 0) {
                        clearInterval(timer);
                        overlay.style.opacity = '0';
                        setTimeout(() => overlay.remove(), 1000);
                        startInteractionSimulations();
                    }
                }, 1000);
            }

            let liveHeartsInterval = null;

            function startInteractionSimulations() {
                simulateLiveChat();

                // Show Lower Third for 8 seconds
                const lt = document.getElementById('lower-third');
                if (lt) {
                    setTimeout(() => lt.style.transform = 'translateX(0)', 1000);
                    setTimeout(() => lt.style.transform = 'translateX(-150%)', 9000);
                }

                // Start Floating Hearts
                liveHeartsInterval = setInterval(() => {
                    if (!document.getElementById('hearts-container')) {
                        clearInterval(liveHeartsInterval);
                        return;
                    }
                    spawnHeart();
                }, 800);

                // Periodically show Subscriber/Donation Alerts
                liveAlertInterval = setInterval(() => {
                    if (!document.getElementById('alert-container')) {
                        clearInterval(liveAlertInterval);
                        return;
                    }
                    const types = ['sub', 'donation'];
                    const type = types[Math.floor(Math.random() * types.length)];
                    showStudioAlert(type);
                }, 12000);
            }

            function spawnHeart() {
                const container = document.getElementById('hearts-container');
                if (!container) return;
                const heart = document.createElement('i');
                heart.className = 'fas fa-heart';
                const colors = ['#ff0055', '#ffb700', '#00ff88', '#ffffff'];
                const size = (1 + Math.random()).toFixed(1);
                const dur = (2 + Math.random()).toFixed(1);
                heart.style.cssText = `position:absolute;bottom:0;left:${Math.random() * 80}%;color:${colors[Math.floor(Math.random() * colors.length)]};font-size:${size}rem;opacity:0.8;animation:float-heart ${dur}s linear forwards;`;
                container.appendChild(heart);
                setTimeout(() => heart.remove(), 3000);
            }

            function showStudioAlert(type) {
                const container = document.getElementById('alert-container');
                if (!container) return;
                const alertEl = document.createElement('div');

                const users = ["Rahul", "Priya", "Amit", "Saira", "Vikram", "Neha", "Arjun", "Meera"];
                const user = users[Math.floor(Math.random() * users.length)];

                alertEl.style.cssText = `background:rgba(0,0,0,0.85);border:2px solid #ff0055;padding:14px 32px;border-radius:50px;color:white;font-weight:800;display:flex;align-items:center;gap:16px;box-shadow:0 0 30px rgba(255,0,85,0.4);animation:alert-slide-in 0.6s cubic-bezier(0.19,1,0.22,1) forwards;backdrop-filter:blur(10px);white-space:nowrap;`;

                if (type === 'sub') {
                    alertEl.innerHTML = `<i class="fas fa-star" style="color:#ff0055;font-size:1.4rem;"></i> <span>${user} joined the Squad! âš¡</span>`;
                    updateSubGoal();
                } else {
                    const amounts = ["â‚¹100", "â‚¹500", "â‚¹1000", "â‚¹50", "â‚¹200"];
                    const amount = amounts[Math.floor(Math.random() * amounts.length)];
                    alertEl.style.borderColor = "#ffd700";
                    alertEl.style.boxShadow = "0 0 30px rgba(255,215,0,0.4)";
                    alertEl.innerHTML = `<i class="fas fa-gift" style="color:#ffd700;font-size:1.4rem;"></i> <span>${user} sent a gift of ${amount}! ðŸŽ</span>`;
                }

                container.appendChild(alertEl);
                setTimeout(() => {
                    alertEl.style.animation = "alert-slide-out 0.6s forwards";
                    setTimeout(() => alertEl.remove(), 600);
                }, 5000);
            }

            function sendLiveChatMsg() {
                const input = document.getElementById('live-chat-input');
                const chatContent = document.getElementById('live-chat-content');
                const user = JSON.parse(localStorage.getItem('vitox_user'));
                if (!input || !chatContent) return;
                const msg = input.value.trim();
                if (!msg) return;
                const name = user ? user.name.split(' ')[0] : 'You';
                const msgEl = document.createElement('div');
                msgEl.style.cssText = 'display:flex;gap:8px;align-items:flex-start;';
                msgEl.innerHTML = `<div style="width:28px;height:28px;border-radius:50%;background:linear-gradient(45deg,#ff0055,#ffb700);display:flex;align-items:center;justify-content:center;font-weight:700;font-size:0.75rem;flex-shrink:0;">${name.charAt(0).toUpperCase()}</div><div><span style="color:#ff0055;font-weight:700;font-size:0.85rem;">${name}</span> <span style="font-size:0.88rem;">${msg}</span></div>`;
                chatContent.appendChild(msgEl);
                chatContent.scrollTop = chatContent.scrollHeight;
                input.value = '';
            }

            function updateSubGoal() {
                const countEl = document.getElementById('sub-count-display');
                const bar = document.getElementById('sub-goal-bar');
                if (!countEl || !bar) return;

                let parts = countEl.innerText.split(' / ');
                let current = parseInt(parts[0].replace(',', '')) + 1;
                let target = parseInt(parts[1].replace(',', ''));

                countEl.innerText = `${current.toLocaleString()} / ${target.toLocaleString()}`;
                bar.style.width = (current / target * 100) + '%';
            }

            let mediaRecorder = null;
            let recordedChunks = [];

            async function toggleRecording() {
                const recBtn = document.getElementById('record-btn');
                if (mediaRecorder && mediaRecorder.state === 'recording') {
                    mediaRecorder.stop();
                    recBtn.innerHTML = '<i class="fas fa-circle" style="color: #ff0050;"></i> RECORD SESSION';
                    recBtn.style.color = '#fff';
                } else {
                    if (!liveStream) return showToast("No active stream to record!");
                    recordedChunks = [];
                    mediaRecorder = new MediaRecorder(liveStream);
                    mediaRecorder.ondataavailable = (e) => { if (e.data.size > 0) recordedChunks.push(e.data); };
                    mediaRecorder.onstop = () => {
                        const blob = new Blob(recordedChunks, { type: 'video/webm' });
                        const url = URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = `Vitox_Session_${Date.now()}.webm`;
                        a.click();
                        showToast("Recording saved to computer!");
                    };
                    mediaRecorder.start();
                    recBtn.innerHTML = '<i class="fas fa-square" style="color: #ff0050;"></i> STOP RECORDING';
                    recBtn.style.color = '#ff0055';
                    showToast("Screen Recording Started!");
                }
            }

            // Live streaming session variables defined globally above

            async function openGoLiveModal() {
                const user = JSON.parse(localStorage.getItem('vitox_user'));
                if (!user) return showToast("Login required to stream!");

                document.getElementById('go-live-modal').style.display = 'flex';
                toggleCreateMenu();

                // Set default source to Camera and trigger it
                document.getElementById('stream-source').value = 'camera';
                switchSource('camera');
            }

            async function switchSource(source) {
                stopLiveMedia();
                const obsConfig = document.getElementById('obs-config');
                if (obsConfig) obsConfig.style.display = source === 'obs' ? 'block' : 'none';

                if (source === 'obs') {
                    // Show instructional image or placeholder for OBS Virtual Camera
                    const videoPreview = document.getElementById('live-preview');
                    if (videoPreview) {
                        videoPreview.srcObject = null;
                        videoPreview.poster = "https://images.unsplash.com/photo-1542751371-adc38448a05e?auto=format&fit=crop&w=800&q=80";
                    }
                    showToast("Connect OBS via Virtual Camera");
                    return;
                }

                try {
                    if (source === 'screen') {
                        liveStream = await navigator.mediaDevices.getDisplayMedia({ video: true, audio: true });
                    } else {
                        liveStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
                    }
                    const videoPreview = document.getElementById('live-preview');
                    if (videoPreview) {
                        videoPreview.srcObject = liveStream;
                        videoPreview.play();
                    }
                } catch (err) {
                    console.error("Source switching failed:", err);
                    showToast("Failed to access " + source);
                    document.getElementById('stream-source').value = 'camera';
                }
            }

            function stopLiveMedia() {
                if (liveStream) {
                    liveStream.getTracks().forEach(track => track.stop());
                    liveStream = null;
                }
            }

            async function uploadLiveThumbnail(input) {
                if (!input.files || !input.files[0]) return;
                const file = input.files[0];
                const status = document.getElementById('thumb-upload-status');
                const urlInput = document.getElementById('stream-thumb-input');

                status.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Uploading...';

                const formData = new FormData();
                formData.append('image', file);

                try {
                    const res = await fetch('/api/image/upload', {
                        method: 'POST',
                        body: formData
                    });
                    const data = await res.json();
                    if (data.url) {
                        urlInput.value = data.url;
                        status.innerHTML = '<span style="color: #00ff88;"><i class="fas fa-check"></i> Ready</span>';
                        showToast("Thumbnail uploaded!");
                    } else {
                        status.innerHTML = '<span style="color: #ff0055;">Failed</span>';
                        showToast(data.error || "Upload failed");
                    }
                } catch (e) {
                    console.error(e);
                    status.innerHTML = '<span style="color: #ff0055;">Error</span>';
                }
            }

            async function startStreamingSession() {
                const title = document.getElementById('stream-title-input').value.trim();
                const thumb = document.getElementById('stream-thumb-input').value.trim();
                const category = document.getElementById('stream-category').value;
                const user = JSON.parse(localStorage.getItem('vitox_user'));

                if (!title) return showToast("Please enter a stream title");

                // Register Live Stream in DB
                try {
                    const res = await fetch('/api/video/upload', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            email: user.email,
                            title: title,
                            description: "ðŸ”´ Live Stream via Vitox Studio",
                            video_url: "live-placeholder", // Flag for frontend
                            thumbnail_url: thumb || "https://images.unsplash.com/photo-1628116904618-97103239a5de?auto=format&fit=crop&w=1920&q=80",
                            type: "live",
                            category: category
                        })
                    });
                    const data = await res.json();
                    if (data.video_id) window.currentLiveId = data.video_id;
                } catch (e) { console.error("Failed to register stream:", e); }

                document.getElementById('go-live-modal').style.display = 'none';
                showToast("Going Live in 3... 2... 1...");

                setTimeout(() => {
                    loadView('Live Stream', { title, category, user });
                }, 1500);
            }

            async function applyForBrand() {
                const user = JSON.parse(localStorage.getItem('vitox_user'));
                if (!user) return alert("Login first!");

                try {
                    const res = await fetch('/api/brand/apply', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ email: user.email })
                    });
                    const data = await res.json();
                    showToast(data.message);
                    if (data.status === 'success') {
                        user.status = 'pending_brand';
                        localStorage.setItem('vitox_user', JSON.stringify(user));
                        loadView('Creator Hub'); // Refresh
                    }
                } catch (e) { console.error(e); }
            }

            async function submitComment(videoId) {
                const user = JSON.parse(localStorage.getItem('vitox_user'));
                const input = document.getElementById('comment-input');
                const content = input.value.trim();
                if (!user) { alert("Login to comment!"); return; }
                if (!content) return;

                try {
                    await fetch('/api/video/comment', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ video_id: videoId, email: user.email, content: content })
                    });
                    input.value = '';
                    document.getElementById('comment-actions').style.display = 'none';
                    loadComments(videoId);
                    // Increment visual total
                    const total = document.getElementById('comment-total');
                    if (total) total.innerText = (parseInt(total.innerText.replace(/,/g, '')) + 1).toLocaleString();

                    const snapTotal = document.getElementById(`snap-comm-count-${videoId}`);
                    if (snapTotal) snapTotal.innerText = parseInt(snapTotal.innerText) + 1;
                    
                    // Reward Creator reputation points for comments
                    fetch('/api/record-engagement', {
                        method: 'POST', headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ video_id: videoId, user_email: user.email, action: 'positive_comment' })
                    });
                } catch (e) { console.error(e); }
            }

            function openSnapComments(videoId) {
                const drawer = document.getElementById('snap-comment-drawer');
                const backdrop = document.getElementById('snap-comment-backdrop');

                if (drawer) drawer.style.right = '0';
                if (backdrop) backdrop.style.display = 'block';

                // Setup loading state
                const content = document.getElementById('snap-comments-content');
                content.innerHTML = '<div style="text-align:center; padding: 50px; opacity: 0.5;">Loading comments...</div>';

                // Fetch comments
                loadSnapComments(videoId);

                // Setup submit listener
                const submitBtn = document.getElementById('snap-comment-submit');
                submitBtn.onclick = () => submitSnapComment(videoId);
            }

            function closeSnapComments() {
                const drawer = document.getElementById('snap-comment-drawer');
                const backdrop = document.getElementById('snap-comment-backdrop');
                if (drawer) drawer.style.right = '-100%';
                if (backdrop) backdrop.style.display = 'none';
            }

            async function loadSnapComments(videoId) {
                try {
                    const res = await fetch(`/api/video/comments/${videoId}`);
                    const comments = await res.json();
                    const content = document.getElementById('snap-comments-content');

                    if (comments.length === 0) {
                        content.innerHTML = '<div style="text-align:center; padding: 50px; opacity: 0.3;">No comments yet. Be the first!</div>';
                        return;
                    }

                    content.innerHTML = comments.map(c => `
                    <div style="display: flex; gap: 12px; margin-bottom: 24px;">
                        <div style="width: 32px; height: 32px; border-radius: 50%; background: #333; display: flex; align-items: center; justify-content: center; font-size: 0.8rem; font-weight: bold; flex-shrink: 0;">
                            ${(c.user_email || '?').charAt(0).toUpperCase()}
                        </div>
                        <div style="flex:1;">
                            <div style="font-weight: 700; font-size: 0.85rem; margin-bottom: 4px;">@${c.user_email.split('@')[0]}</div>
                            <div style="font-size: 0.95rem; color: #ddd; line-height: 1.4;">${c.content}</div>
                        </div>
                    </div>
                `).join('');
                } catch (e) { console.error(e); }
            }

            async function submitSnapComment(videoId) {
                const input = document.getElementById('snap-comment-input');
                const content = input.value.trim();
                if (!content) return;

                const user = JSON.parse(localStorage.getItem('vitox_user'));
                if (!user) { showToast("Please login to comment!"); return; }

                try {
                    const res = await fetch('/api/video/comment', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ video_id: videoId, email: user.email, content: content })
                    });
                    if (res.ok) {
                        input.value = '';
                        loadSnapComments(videoId);
                        const commCount = document.getElementById(`snap-comm-count-${videoId}`);
                        if (commCount) commCount.innerText = parseInt(commCount.innerText || 0) + 1;
                    }
                } catch (e) { console.error(e); }
            }


            // Collab Chat Logic
            let collabChatPoller = null;
            let _collabTarget = null;
            let _collabUser = null;

            async function openCollabChat(creatorEmail, force=false) {
                const user = JSON.parse(localStorage.getItem('vitox_user'));
                if (!user) { showCollabLocked('login'); return; }
                if (user.email === creatorEmail) { showToast("You can't message yourself!"); return; }

                // Check eligibility from backend
                try {
                    let eligible = force;
                    let data = { type: force ? 'creator' : 'unknown' };
                    if (!force) {
                        const res = await fetch(`/api/collab/eligibility?email=${user.email}&target=${creatorEmail}`);
                        data = await res.json();
                        eligible = data.eligible;
                    }

                    if (!eligible) {
                        showCollabLocked(data.reason, data.squad_count, data.needed, data.points, creatorEmail);
                        return;
                    }

                    // Eligible! Open the chat
                    _collabUser = user;
                    _collabTarget = creatorEmail;

                    const drawer = document.getElementById('collab-chat-drawer');
                    drawer.style.right = '0';

                    // Set avatar + badge
                    const avatarEl = document.getElementById('collab-avatar');
                    if (avatarEl) {
                        avatarEl.innerText = creatorEmail.charAt(0).toUpperCase();
                        if (data.type === 'brand') avatarEl.style.background = 'linear-gradient(135deg,#ffd700,#ff5500)';
                        else if (data.type === 'creator') avatarEl.style.background = 'linear-gradient(135deg,#00cc66,#0088ff)';
                    }

                    const targetEl = document.getElementById('collab-chat-target');
                    if (targetEl) targetEl.innerHTML = '@' + creatorEmail.split('@')[0] +
                        (data.type === 'brand' ? ' <span style="background:#ffd700;color:#000;font-size:0.6rem;padding:2px 6px;border-radius:4px;font-weight:800;vertical-align:middle;">🏷️ BRAND</span>' : '');

                    loadCollabHistory(user.email, creatorEmail);

                    const sendBtn = document.getElementById('collab-chat-send');
                    sendBtn.onclick = () => sendCollabMsg(user.email, creatorEmail);

                    if (collabChatPoller) clearInterval(collabChatPoller);
                    collabChatPoller = setInterval(() => loadCollabHistory(user.email, creatorEmail, true), 3000);
                } catch(e) {
                    console.error(e);
                    showToast('Error checking eligibility. Please try again.');
                }
            }

            function showCollabLocked(reason, squadCount, needed, points, targetEmail) {
                // remove existing modal if any
                const existing = document.getElementById('collab-locked-modal');
                if (existing) existing.remove();

                const modal = document.createElement('div');
                modal.id = 'collab-locked-modal';
                modal.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.85);z-index:200010;display:flex;align-items:center;justify-content:center;backdrop-filter:blur(8px);';

                let content = '';
                if (reason === 'login') {
                    content = `
                        <div style="font-size:3rem;margin-bottom:16px;">🔒</div>
                        <h2 style="font-size:1.4rem;margin-bottom:8px;">Login Required</h2>
                        <p style="color:#666;margin-bottom:24px;">Sign in to use the Collab Chat system.</p>
                        <button onclick="document.getElementById('collab-locked-modal').remove()" style="background:#1a1a1a;border:1px solid rgba(255,255,255,0.1);color:#aaa;padding:12px 24px;border-radius:12px;cursor:pointer;margin-right:10px;">Close</button>
                    `;
                } else if (reason === 'not_enough_squad_or_points' || reason === 'not_enough_squad') {
                    const progress = Math.min(100, Math.round(((squadCount||0) / 1000) * 100));
                    content = `
                        <div style="font-size:3rem;margin-bottom:16px;">🔒</div>
                        <h2 style="font-size:1.4rem;margin-bottom:8px;">Collab Chat Locked</h2>
                        <p style="color:#666;font-size:0.9rem;line-height:1.6;margin-bottom:20px;">To use Collab Messaging, you need to reach <b>1,000 Squad Members</b>.</p>
                        
                        <div style="background:#0d0d0d;border:1px solid rgba(255,255,255,0.05);border-radius:16px;padding:20px;margin-bottom:20px;text-align:left;">
                            <div style="display:flex;justify-content:space-between;margin-bottom:10px;font-size:0.85rem;">
                                <span style="color:#aaa;">Current Progress</span>
                                <span style="font-weight:700;">${squadCount||0} / 1,000</span>
                            </div>
                            <div style="height:8px;background:#222;border-radius:4px;overflow:hidden;margin-bottom:14px;">
                                <div style="height:100%;width:${progress}%;background:linear-gradient(90deg,#ff0055,#ff5500);border-radius:4px;"></div>
                            </div>
                            <div style="font-size:0.8rem;color:#888;">
                                <i class="fas fa-info-circle"></i> Complete your profile, post videos, and grow your Squad!
                            </div>
                        </div>
                        
                        <p style="color:#555;font-size:0.8rem;margin-bottom:20px;">OR register as a <b style="color:#ffd700;">Verified Brand</b> using your official company email.</p>
                        <div style="display:flex;gap:10px;width:100%;">
                            <button onclick="document.getElementById('collab-locked-modal').remove()" style="flex:1;background:#1a1a1a;border:1px solid rgba(255,255,255,0.1);color:#aaa;padding:12px;border-radius:12px;cursor:pointer;">Maybe Later</button>
                            <button onclick="document.getElementById('collab-locked-modal').remove(); showBrandRegistration();" style="flex:2;background:linear-gradient(135deg,#ffd700,#ff5500);color:#000;border:none;padding:12px;border-radius:12px;cursor:pointer;font-weight:800;">🏷️ Register as Brand</button>
                        </div>
                    `;
                } else if (reason === 'not_enough_reputation') {
                    // Specific logic for trying to message elite creators
                    content = `
                        <div style="font-size:3rem;margin-bottom:16px;">👑</div>
                        <h2 style="font-size:1.4rem;margin-bottom:8px;">Elite Creator Locked</h2>
                        <p style="color:#888;font-size:0.9rem;line-height:1.6;margin-bottom:20px;">You are trying to message an <b style="color:white;">Elite Creator</b> (100k+ Squad). To prevent spam, you must have a <b style="color:#00cc66;">Reputation Score of 50,000+</b>.</p>
                        
                        <div style="background:#0d0d0d;border:1px solid rgba(255,255,255,0.08);border-radius:16px;padding:20px;margin-bottom:20px;width:100%;">
                            <div style="display:flex;justify-content:space-between;margin-bottom:10px;">
                                <span style="color:#aaa;font-size:0.85rem;">Your Reputation</span>
                                <span style="font-weight:800;color:#ff0055;">${points||0} / 50,000</span>
                            </div>
                        </div>
                        
                        <p style="color:#555;font-size:0.8rem;margin-bottom:20px;">Keep posting great content! You get points when people <b>Like, Full Watch, and Share</b> your videos.</p>
                        <button onclick="document.getElementById('collab-locked-modal').remove();" style="width:100%;background:#1a1a1a;border:1px solid rgba(255,255,255,0.1);color:#aaa;padding:12px 24px;border-radius:12px;cursor:pointer;">I understand</button>
                    `;
                } else {
                    content = `<div style="font-size:3rem;margin-bottom:16px;">🔒</div><h2>Access Restricted</h2><p style="color:#666;margin-bottom:20px;">You don't have permission to use Collab Chat.</p><button onclick="document.getElementById('collab-locked-modal').remove();" style="background:#1a1a1a;border:1px solid rgba(255,255,255,0.1);color:#aaa;padding:12px 24px;border-radius:12px;cursor:pointer;">Close</button>`;
                }

                modal.innerHTML = `
                    <div style="background:#111;border:1px solid rgba(255,255,255,0.1);border-radius:24px;padding:36px;max-width:440px;width:90%;text-align:center;">
                        ${content}
                        ${targetEmail ? `<div style="margin-top: 20px; padding-top: 15px; border-top: 1px dashed rgba(255,255,255,0.1);"><button onclick="document.getElementById('collab-locked-modal').remove(); openCollabChat('${targetEmail}', true);" style="background:transparent; border:1px solid #00ff88; color:#00ff88; font-weight:700; padding:6px 16px; border-radius:6px; font-size:0.8rem; cursor:pointer;"><i class="fas fa-bug"></i> Test Bypass</button></div>` : ''}
                    </div>
                `;
                document.body.appendChild(modal);
            }

            function showBrandRegistration() {
                const user = JSON.parse(localStorage.getItem('vitox_user') || 'null');
                if (!user) { showToast('Please login first!'); return; }

                const modal = document.createElement('div');
                modal.id = 'brand-reg-modal';
                modal.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.85);z-index:200011;display:flex;align-items:center;justify-content:center;backdrop-filter:blur(8px);';
                modal.innerHTML = `
                    <div style="background:#111;border:1px solid rgba(255,215,0,0.2);border-radius:24px;padding:32px;max-width:460px;width:90%;">
                        <div style="text-align:center;margin-bottom:24px;">
                            <div style="font-size:2.5rem;margin-bottom:8px;">🏷️</div>
                            <h2 style="font-size:1.3rem;margin-bottom:4px;">Brand Verification</h2>
                            <p style="color:#666;font-size:0.85rem;">Register your brand to unlock Collab Chat</p>
                        </div>
                        <div id="brand-reg-result"></div>
                        <div id="brand-reg-form">
                            <div style="background:rgba(255,215,0,0.05);border:1px solid rgba(255,215,0,0.15);border-radius:12px;padding:14px;margin-bottom:16px;font-size:0.8rem;color:#aaa;line-height:1.6;">
                                ⚡ <b style="color:#ffd700;">Auto-Checker:</b> Brands must use their official company email (e.g. marketing@yourcompany.com). Gmail/Yahoo/Hotmail are NOT accepted.
                            </div>
                            <div style="margin-bottom:12px;">
                                <label style="color:#aaa;font-size:0.8rem;display:block;margin-bottom:6px;">Company Name *</label>
                                <input id="b-name" placeholder="e.g. Zomato India Pvt Ltd" style="width:100%;background:#1a1a1a;border:1px solid rgba(255,255,255,0.1);color:white;padding:10px 14px;border-radius:10px;font-size:0.9rem;">
                            </div>
                            <div style="margin-bottom:12px;">
                                <label style="color:#aaa;font-size:0.8rem;display:block;margin-bottom:6px;">Official Company Email * <small style="color:#555;">(must match your business domain)</small></label>
                                <input id="b-email" value="${user.email}" placeholder="marketing@company.com" style="width:100%;background:#1a1a1a;border:1px solid rgba(255,255,255,0.1);color:white;padding:10px 14px;border-radius:10px;font-size:0.9rem;">
                            </div>
                            <div style="margin-bottom:12px;">
                                <label style="color:#aaa;font-size:0.8rem;display:block;margin-bottom:6px;">Company Website</label>
                                <input id="b-website" placeholder="https://yourcompany.com" style="width:100%;background:#1a1a1a;border:1px solid rgba(255,255,255,0.1);color:white;padding:10px 14px;border-radius:10px;font-size:0.9rem;">
                            </div>
                            <div style="margin-bottom:20px;">
                                <label style="color:#aaa;font-size:0.8rem;display:block;margin-bottom:6px;">Brand Category</label>
                                <select id="b-cat" style="width:100%;background:#1a1a1a;border:1px solid rgba(255,255,255,0.1);color:white;padding:10px 14px;border-radius:10px;font-size:0.9rem;">
                                    <option value="tech">Tech & Electronics</option>
                                    <option value="fashion">Fashion & Lifestyle</option>
                                    <option value="food">Food & Beverage</option>
                                    <option value="gaming">Gaming</option>
                                    <option value="finance">Finance & Fintech</option>
                                    <option value="education">Education</option>
                                    <option value="entertainment">Entertainment</option>
                                    <option value="other">Other</option>
                                </select>
                            </div>
                            <div style="display:flex;gap:10px;">
                                <button onclick="document.getElementById('brand-reg-modal').remove()" style="flex:1;background:#1a1a1a;border:1px solid rgba(255,255,255,0.1);color:#aaa;padding:12px;border-radius:12px;cursor:pointer;">Cancel</button>
                                <button onclick="submitBrandRegistration()" style="flex:2;background:linear-gradient(135deg,#ffd700,#ff5500);color:#000;border:none;padding:12px;border-radius:12px;cursor:pointer;font-weight:800;">⚡ Auto-Verify Brand</button>
                            </div>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
            }

            async function submitBrandRegistration() {
                const name = document.getElementById('b-name')?.value?.trim();
                const email = document.getElementById('b-email')?.value?.trim();
                const website = document.getElementById('b-website')?.value?.trim();
                const category = document.getElementById('b-cat')?.value;
                const resultEl = document.getElementById('brand-reg-result');

                if (!name || !email) { showToast('Company name and email are required!'); return; }

                resultEl.innerHTML = `<div style="text-align:center;padding:16px;color:#ffd700;"><i class="fas fa-spinner fa-spin"></i> Auto-checking brand eligibility...</div>`;

                try {
                    // Step 1: Check eligibility
                    const checkRes = await fetch('/api/brand/check-eligibility', {
                        method: 'POST', headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ email, company_name: name })
                    });
                    const checkData = await checkRes.json();

                    if (checkData.already_verified) {
                        resultEl.innerHTML = `<div style="background:rgba(0,204,102,0.1);border:1px solid rgba(0,204,102,0.3);border-radius:12px;padding:16px;text-align:center;margin-bottom:16px;"><div style="color:#00cc66;font-weight:800;font-size:1.1rem;">✅ Already Verified!</div><div style="color:#aaa;font-size:0.85rem;margin-top:4px;">Brand ID: <b style="color:#ffd700;">${checkData.brand_id}</b></div></div>`;
                        document.getElementById('brand-reg-form').innerHTML = '';
                        // Update local storage
                        const u = JSON.parse(localStorage.getItem('vitox_user')||'{}');
                        u.is_verified_brand = true; u.brand_id = checkData.brand_id;
                        localStorage.setItem('vitox_user', JSON.stringify(u));
                        return;
                    }

                    if (!checkData.eligible) {
                        resultEl.innerHTML = `<div style="background:rgba(255,0,85,0.1);border:1px solid rgba(255,0,85,0.3);border-radius:12px;padding:16px;margin-bottom:16px;"><div style="color:#ff0055;font-weight:800;">❌ Not Eligible</div><div style="color:#aaa;font-size:0.85rem;margin-top:4px;">${checkData.reason}</div></div>`;
                        return;
                    }

                    // Step 2: Register brand
                    const regRes = await fetch('/api/brand/register', {
                        method: 'POST', headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ email, company_name: name, website, category })
                    });
                    const regData = await regRes.json();

                    if (regData.status === 'success') {
                        resultEl.innerHTML = `
                            <div style="background:rgba(0,204,102,0.1);border:1px solid rgba(0,204,102,0.3);border-radius:16px;padding:20px;text-align:center;margin-bottom:16px;">
                                <div style="font-size:2rem;margin-bottom:8px;">🎉</div>
                                <div style="color:#00cc66;font-weight:800;font-size:1.1rem;">Brand Verified!</div>
                                <div style="margin-top:12px;background:rgba(255,215,0,0.1);border:1px solid rgba(255,215,0,0.2);border-radius:10px;padding:12px;">
                                    <div style="color:#555;font-size:0.75rem;margin-bottom:4px;">YOUR BRAND ID</div>
                                    <div style="color:#ffd700;font-weight:800;font-size:1.1rem;letter-spacing:2px;">${regData.brand_id}</div>
                                    <div style="color:#555;font-size:0.72rem;margin-top:4px;">Category: ${regData.category}</div>
                                </div>
                                <div style="color:#888;font-size:0.8rem;margin-top:12px;">Collab Chat is now unlocked! Reload the page to start collaborating.</div>
                            </div>
                        `;
                        document.getElementById('brand-reg-form').innerHTML = `<button onclick="location.reload()" style="width:100%;background:linear-gradient(135deg,#ffd700,#ff5500);color:#000;border:none;padding:14px;border-radius:12px;cursor:pointer;font-weight:800;font-size:1rem;">🚀 Start Collaborating</button>`;
                        // Update local storage
                        const u = JSON.parse(localStorage.getItem('vitox_user')||'{}');
                        u.is_verified_brand = true; u.brand_id = regData.brand_id;
                        localStorage.setItem('vitox_user', JSON.stringify(u));
                    } else {
                        resultEl.innerHTML = `<div style="background:rgba(255,0,85,0.1);border:1px solid rgba(255,0,85,0.3);border-radius:12px;padding:16px;margin-bottom:16px;"><div style="color:#ff0055;font-weight:800;">❌ Registration Failed</div><div style="color:#aaa;font-size:0.85rem;margin-top:4px;">${regData.message}</div></div>`;
                    }
                } catch(e) {
                    resultEl.innerHTML = `<div style="color:#ff0055;padding:12px;">Error: ${e.message}</div>`;
                }
            }


            function closeCollabChat() {
                document.getElementById('collab-chat-drawer').style.right = '-100%';
                if (collabChatPoller) clearInterval(collabChatPoller);
            }

            function insertTemplate(text) {
                const input = document.getElementById('collab-chat-input');
                if (input) { input.value = text; input.focus(); input.style.height = 'auto'; input.style.height = input.scrollHeight + 'px'; }
            }

            function appendEmoji(emoji) {
                const input = document.getElementById('collab-chat-input');
                if (input) { input.value += emoji; input.focus(); }
            }

            function sendCollabProposal() {
                if (!_collabTarget) return;
                const modal = document.createElement('div');
                modal.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.8);z-index:200002;display:flex;align-items:center;justify-content:center;backdrop-filter:blur(5px);';
                modal.innerHTML = `
                    <div style="background:#111;border:1px solid rgba(255,255,255,0.1);border-radius:24px;padding:32px;max-width:420px;width:90%;">
                        <h3 style="margin:0 0 4px;font-size:1.3rem;">🤝 Send Collab Proposal</h3>
                        <p style="color:#666;font-size:0.85rem;margin-bottom:20px;">to @${_collabTarget.split('@')[0]}</p>
                        <div style="margin-bottom:14px;">
                            <label style="color:#aaa;font-size:0.8rem;display:block;margin-bottom:6px;">Deal Type</label>
                            <select id="p-type" style="width:100%;background:#1a1a1a;border:1px solid rgba(255,255,255,0.1);color:white;padding:10px 14px;border-radius:10px;font-size:0.9rem;">
                                <option>Collaboration Video</option>
                                <option>Paid Sponsorship</option>
                                <option>Brand Ambassador</option>
                                <option>Revenue Share</option>
                                <option>Shoutout Exchange</option>
                            </select>
                        </div>
                        <div style="margin-bottom:14px;">
                            <label style="color:#aaa;font-size:0.8rem;display:block;margin-bottom:6px;">Proposed Budget / Offer</label>
                            <input id="p-budget" placeholder="e.g. ₹5,000 / Revenue Share / Free Collab" style="width:100%;background:#1a1a1a;border:1px solid rgba(255,255,255,0.1);color:white;padding:10px 14px;border-radius:10px;font-size:0.9rem;">
                        </div>
                        <div style="margin-bottom:20px;">
                            <label style="color:#aaa;font-size:0.8rem;display:block;margin-bottom:6px;">Message</label>
                            <textarea id="p-msg" placeholder="Describe your idea..." rows="3" style="width:100%;background:#1a1a1a;border:1px solid rgba(255,255,255,0.1);color:white;padding:10px 14px;border-radius:10px;font-size:0.9rem;resize:none;font-family:inherit;"></textarea>
                        </div>
                        <div style="display:flex;gap:10px;">
                            <button onclick="this.closest('div[style]').remove()" style="flex:1;background:#1a1a1a;border:1px solid rgba(255,255,255,0.1);color:#aaa;padding:12px;border-radius:12px;cursor:pointer;">Cancel</button>
                            <button onclick="submitProposal()" style="flex:2;background:linear-gradient(135deg,#ff0055,#7000ff);color:white;border:none;padding:12px;border-radius:12px;cursor:pointer;font-weight:800;">Send Proposal 🚀</button>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
            }

            function submitProposal() {
                const type = document.getElementById('p-type')?.value;
                const budget = document.getElementById('p-budget')?.value;
                const msg = document.getElementById('p-msg')?.value;
                if (!type || !budget) { showToast('Please fill deal type and budget'); return; }

                const fullMsg = `📋 COLLAB PROPOSAL\n━━━━━━━━━━━━━━\nType: ${type}\nOffer: ${budget}\nDetails: ${msg || 'No details provided'}\n━━━━━━━━━━━━━━\nReply to discuss!`;
                const input = document.getElementById('collab-chat-input');
                if (input) input.value = fullMsg;

                // Close modal and send
                document.querySelectorAll('div[style*="inset:0"]').forEach(m => { if(m.querySelector('#p-type')) m.remove(); });
                document.getElementById('collab-chat-send').click();
            }

            async function loadCollabHistory(myEmail, targetEmail, isPolling = false) {
                try {
                    const res = await fetch(`/api/collab/chat/history?user1=${myEmail}&user2=${targetEmail}`);
                    const msgs = await res.json();
                    const content = document.getElementById('collab-messages-content');
                    const emptyEl = document.getElementById('collab-empty');

                    if (msgs.length === 0) {
                        if (emptyEl) emptyEl.style.display = 'block';
                        return;
                    }
                    if (emptyEl) emptyEl.style.display = 'none';

                    const oldScroll = content.scrollTop;
                    const wasAtBottom = content.scrollHeight - content.clientHeight <= content.scrollTop + 50;

                    // Group messages by date
                    let lastDate = null;
                    const renderedMsgs = msgs.map(m => {
                        const isMe = m.sender_email === myEmail;
                        const isProposal = (m.content || '').includes('COLLAB PROPOSAL');
                        const ts = new Date(m.timestamp);
                        const dateStr = ts.toLocaleDateString([], {day:'numeric', month:'short', year:'numeric'});
                        const timeStr = ts.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                        const formattedContent = (m.content || '').replace(/\n/g, '<br>');

                        let dateSep = '';
                        if (dateStr !== lastDate) { lastDate = dateStr; dateSep = `<div style="text-align:center;color:#333;font-size:0.72rem;margin:12px 0;">${dateStr}</div>`; }

                        if (isProposal) {
                            return dateSep + `
                                <div style="align-self:${isMe?'flex-end':'flex-start'};max-width:90%;width:100%;">
                                    <div style="background:linear-gradient(135deg,rgba(255,0,85,0.1),rgba(112,0,255,0.1));border:1px solid rgba(255,0,85,0.3);border-radius:16px;padding:16px;">
                                        <div style="font-size:0.7rem;color:#ff0055;font-weight:800;margin-bottom:8px;letter-spacing:1px;">📋 COLLAB PROPOSAL</div>
                                        <div style="font-size:0.85rem;color:#ddd;line-height:1.6;white-space:pre-line;">${formattedContent.replace('<br>📋 COLLAB PROPOSAL<br>━━━━━━━━━━━━━━<br>','')}</div>
                                        ${!isMe ? `<div style="display:flex;gap:8px;margin-top:12px;"><button onclick="insertTemplate('I accept! Let\'s discuss more details.'" style="flex:1;background:#00cc66;border:none;color:white;padding:8px;border-radius:8px;cursor:pointer;font-size:0.8rem;font-weight:700;">✅ Accept</button><button onclick="insertTemplate('Thanks but I will have to decline.')" style="flex:1;background:#1a1a1a;border:1px solid rgba(255,255,255,0.1);color:#aaa;padding:8px;border-radius:8px;cursor:pointer;font-size:0.8rem;">❌ Decline</button></div>` : ''}
                                    </div>
                                    <div style="font-size:0.7rem;color:#444;margin-top:4px;text-align:${isMe?'right':'left'};">${timeStr} ${isMe?'✓✓':''}</div>
                                </div>`;
                        }

                        return dateSep + `
                            <div style="align-self:${isMe?'flex-end':'flex-start'};max-width:80%;">
                                <div style="background:${isMe?'linear-gradient(135deg,#ff0055,#cc0044)':'#1e1e1e'};color:white;padding:11px 15px;border-radius:${isMe?'18px 18px 4px 18px':'18px 18px 18px 4px'};font-size:0.9rem;line-height:1.5;word-break:break-word;">
                                    ${formattedContent}
                                </div>
                                <div style="font-size:0.7rem;color:#444;margin-top:3px;text-align:${isMe?'right':'left'};">${timeStr} ${isMe?'<span style="color:#00cc66;">✓✓</span>':''}</div>
                            </div>`;
                    });

                    content.innerHTML = renderedMsgs.join('');

                    if (!isPolling || wasAtBottom) {
                        content.scrollTop = content.scrollHeight;
                    } else {
                        content.scrollTop = oldScroll;
                    }
                } catch (e) { console.error(e); }
            }

            async function sendCollabMsg(myEmail, targetEmail) {
                const input = document.getElementById('collab-chat-input');
                const content = input.value.trim();
                if (!content) return;

                try {
                    const res = await fetch('/api/collab/chat/send', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ sender_email: myEmail, receiver_email: targetEmail, content: content })
                    });
                    const data = await res.json();
                    if (data.status === 'success') {
                        input.value = '';
                        loadCollabHistory(myEmail, targetEmail);
                    } else {
                        showToast(data.message);
                    }
                } catch (e) { console.error(e); }
            }

            // Toast Engine
            function showToast(msg) {
                let container = document.getElementById('toast-container');
                if (!container) {
                    container = document.createElement('div');
                    container.id = 'toast-container';
                    document.body.appendChild(container);
                }
                const t = document.createElement('div');
                t.className = 'toast';
                t.innerText = msg;
                container.appendChild(t);
                setTimeout(() => t.remove(), 3000);
            }

            async function toggleLike(videoId, channelEmail) {
                const user = JSON.parse(localStorage.getItem('vitox_user'));
                if (!user) { showToast("Please login to like!"); return; }

                const mainBtn = document.getElementById('like-btn');
                if (mainBtn) {
                    mainBtn.classList.add('pulse-active');
                    setTimeout(() => mainBtn.classList.remove('pulse-active'), 300);
                }

                try {
                    const res = await fetch('/api/video/like', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ video_id: videoId, email: user.email })
                    });
                    const data = await res.json();
                    showToast(data.status === 'liked' ? "Liked! â¤ï¸" : "Like Removed");

                    // Update Snap card counts if they exist
                    const snapLikeCount = document.getElementById(`snap-like-count-${videoId}`);
                    if (snapLikeCount) {
                        snapLikeCount.innerText = data.likes;
                    }
                    const snapLikeIcon = document.getElementById(`snap-like-icon-${videoId}`);
                    if (snapLikeIcon) {
                        snapLikeIcon.style.color = data.status === 'liked' ? '#ff0055' : '#fff';
                    }
                    
                    if (data.status === 'liked') {
                        // Reward Creator reputation points for likes
                        fetch('/api/record-engagement', {
                            method: 'POST', headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ video_id: videoId, user_email: user.email, action: 'like' })
                        });
                    }

                    if (mainBtn) loadEngagementStats(videoId, channelEmail);
                } catch (e) { console.error(e); }
            }

            async function toggleSubscribe(channelEmail, videoId) {
                const user = JSON.parse(localStorage.getItem('vitox_user'));
                if (!user) { showToast("Please login to join the Squad!"); return; }

                const mainBtn = document.getElementById('sub-btn');
                if (mainBtn) {
                    mainBtn.classList.add('pulse-active');
                    setTimeout(() => mainBtn.classList.remove('pulse-active'), 300);
                }

                try {
                    const res = await fetch('/api/channel/subscribe', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ subscriber: user.email, channel: channelEmail })
                    });
                    const data = await res.json();
                    showToast(data.status === 'subscribed' ? "Added to Squad! ðŸš€" : "Left the Squad");

                    // Update Snap card follow buttons
                    const snapSubBtn = document.getElementById(`snap-sub-btn-${videoId}`);
                    if (snapSubBtn) {
                        snapSubBtn.innerText = data.status === 'subscribed' ? 'Joined' : 'Squad';
                        snapSubBtn.style.background = data.status === 'subscribed' ? 'rgba(255,255,255,0.2)' : 'white';
                        snapSubBtn.style.color = data.status === 'subscribed' ? 'white' : 'black';
                    }

                    if (mainBtn) loadEngagementStats(videoId, channelEmail);
                } catch (e) { console.error(e); }
            }

            // Logic for Category Filtering
            function filterByCategory(cat) {
                const chips = document.querySelectorAll('.chip');
                chips.forEach(c => {
                    c.classList.remove('active');
                    if (c.innerText.includes(cat)) c.classList.add('active');
                });

                if (cat === 'All') {
                    renderVideos(allVideos.filter(v => v.type === 'video' || v.type === 'live' || !v.type));
                    return;
                }

                if (cat === 'Drama') {
                   // "Spicy Drama" Logic: Search for specific viral/drama keywords
                   const dramaKeywords = ['drama', 'fight', 'roast', 'exposed', 'shocking', 'wrong', 'viral'];
                   const dramaVideos = allVideos.filter(v => {
                       const content = (v.title + ' ' + (v.description || '')).toLowerCase();
                       return dramaKeywords.some(k => content.includes(k)) || (v.category && v.category.includes('Drama'));
                   });
                   
                   if (dramaVideos.length === 0) {
                       // Fallback: Show trending videos with a 'Drama' badge simulation
                       renderVideos(allVideos.slice(0, 5), true); 
                   } else {
                       renderVideos(dramaVideos, true);
                   }
                   return;
                }

                const filtered = allVideos.filter(vid => {
                    if (cat === 'Live') return vid.type === 'live';
                    return (vid.category && (vid.category === cat || vid.category.includes(cat))) ||
                        (vid.title && vid.title.toLowerCase().includes(cat.toLowerCase()));
                });
                renderVideos(filtered);
            }

            // Mobile Search Toggle
            function toggleMobileSearch() {
                const searchBar = document.getElementById('search-bar-container');
                const backBtn = document.querySelector('.mobile-back-btn');

                searchBar.classList.toggle('mobile-active');

                if (searchBar.classList.contains('mobile-active')) {
                    backBtn.style.display = 'flex';
                    document.getElementById('search-input').focus();
                } else {
                    backBtn.style.display = 'none';
                }
            }

            // Mobile Search Toggle Logic is handled by toggleMobileSearch above


            async function handleCredentialResponse(response) {
                const base64Url = response.credential.split('.')[1];
                const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
                const payload = JSON.parse(window.atob(base64));

                // Sync with Python Backend
                try {
                    const res = await fetch('/api/user', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            email: payload.email,
                            name: payload.name,
                            picture: payload.picture
                        })
                    });

                    const dbUser = await res.json();
                    localStorage.setItem('vitox_user', JSON.stringify(dbUser));
                    updateLoginUI(dbUser);
                } catch (error) {
                    localStorage.setItem('vitox_user', JSON.stringify(payload));
                    updateLoginUI(payload);
                }
            }

            function updateLoginUI(user) {
                if (user) {
                    const loginContainer = document.getElementById('login-container');
                    const avatar = document.getElementById('user-avatar');

                    if (loginContainer) loginContainer.style.display = 'none';

                    if (avatar) {
                        avatar.textContent = user.name.charAt(0).toUpperCase();
                        // Remove Mavo property temporarily to prevent overwrite
                        avatar.removeAttribute('property');

                        if (user.picture) {
                            avatar.style.backgroundImage = `url(${user.picture})`;
                            avatar.style.backgroundSize = 'cover';
                            avatar.style.backgroundPosition = 'center';
                            avatar.style.color = 'transparent';
                        }

                        // Show Admin Button and Link if authorized
                        if (user.email === 'junaidshah78634@gmail.com') {
                            const headerRight = document.querySelector('.header-right');
                            const adminSidebarLink = document.getElementById('admin-sidebar-link');

                            if (adminSidebarLink) adminSidebarLink.style.display = 'block';

                            if (!document.getElementById('admin-link-btn')) {
                                const adminBtn = document.createElement('button');
                                adminBtn.id = 'admin-link-btn';
                                adminBtn.className = 'btn-text';
                                adminBtn.innerHTML = '<i class="fas fa-shield-halved"></i> Admin';
                                adminBtn.onclick = () => loadView('Admin Panel');
                                adminBtn.style.color = '#ff4d4d';
                                headerRight.insertBefore(adminBtn, headerRight.firstChild);
                            }
                        }
                    }
                }
            }

            // Check if user is already logged in on page load
            window.addEventListener('load', () => {
                const savedUser = localStorage.getItem('vitox_user');
                if (savedUser) {
                    updateLoginUI(JSON.parse(savedUser));
                }

                // Load real videos from DB
                loadVideos();

                // Category Chip Interaction
                const chips = document.querySelectorAll('.chip');
                chips.forEach(chip => {
                    chip.onclick = () => {
                        const originalOnclick = chip.getAttribute('onclick');
                        if (!originalOnclick) {
                            chips.forEach(c => c.classList.remove('active'));
                            chip.classList.add('active');
                            const category = chip.innerText.replace(' Spicy ', '');
                            filterByCategory(category);
                        }
                    };
                });

                // User Retention Hooks Initialization
                setTimeout(() => {
                    if (typeof initRetentionHooks === 'function') initRetentionHooks();
                    checkDailyReward();
                    updateStreakUI();
                }, 1500);
            });

            function updateStreakUI() {
                const indicator = document.getElementById('streak-indicator');
                const countText = document.getElementById('streak-count');
                if (!indicator || !countText) return;

                let streak = parseInt(localStorage.getItem('vitox_streak') || '0');
                const lastUpdated = localStorage.getItem('vitox_streak_last_date');
                const today = new Date().toDateString();
                const yesterday = new Date(Date.now() - 86400000).toDateString();

                if (lastUpdated === today) {
                    // Already counted today
                } else if (lastUpdated === yesterday) {
                    // Consecutive day
                    streak += 1;
                    localStorage.setItem('vitox_streak', streak);
                    localStorage.setItem('vitox_streak_last_date', today);
                } else {
                    // Streak broken or brand new
                    streak = 1;
                    localStorage.setItem('vitox_streak', streak);
                    localStorage.setItem('vitox_streak_last_date', today);
                }

                if (streak >= 1) {
                    indicator.style.display = 'flex';
                    countText.innerText = streak + (streak === 1 ? ' Day Streak' : ' Day Streak');
                }
            }

            function checkDailyReward() {
                const lastLogin = localStorage.getItem('vitox_last_daily_reward');
                const today = new Date().toDateString();
                
                if (lastLogin !== today) {
                    setTimeout(() => {
                        showDailyRewardModal();
                    }, 2000);
                }
            }

            function showDailyRewardModal() {
                const modal = document.createElement('div');
                modal.id = 'daily-reward-modal';
                modal.style.cssText = `
                    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                    background: rgba(0,0,0,0.85); z-index: 100000;
                    display: flex; align-items: center; justify-content: center;
                    backdrop-filter: blur(10px); animation: fadeIn 0.3s forwards;
                `;
                
                modal.innerHTML = `
                    <div style="background: #111; border: 2px solid #ff0055; border-radius: 24px; padding: 40px; text-align: center; max-width: 400px; width: 90%; box-shadow: 0 0 50px rgba(255,0,85,0.3); animation: scale-in 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);">
                        <div style="font-size: 4rem; margin-bottom: 20px;">ðŸŽ</div>
                        <h2 style="color: white; font-weight: 800; margin-bottom: 10px;">Daily Streak Reward!</h2>
                        <p style="color: #aaa; line-height: 1.6; margin-bottom: 25px;">You've returned to Vitox! Claim your daily 50 points and 2x Badge Progress for the next hour.</p>
                        <button id="claim-reward-btn" style="background: #ff0055; color: white; border: none; padding: 15px 40px; border-radius: 40px; font-weight: 800; font-size: 1.1rem; cursor: pointer; transition: 0.3s; box-shadow: 0 10px 20px rgba(255,0,85,0.2);">
                            CLAIM REWARD
                        </button>
                    </div>
                `;
                
                document.body.appendChild(modal);
                
                document.getElementById('claim-reward-btn').onclick = () => {
                    localStorage.setItem('vitox_last_daily_reward', new Date().toDateString());
                    
                    // Logic to add points
                    const userStr = localStorage.getItem('vitox_user');
                    if (userStr) {
                        const user = JSON.parse(userStr);
                        fetch('/api/add-points', {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify({ email: user.email, amount: 50, description: 'Daily Login Reward' })
                        });
                    }
                    
                    showToast("ðŸŽ 50 Points Added! 2x Progress Active.");
                    modal.style.animation = 'scale-in 0.3s reverse forwards';
                    setTimeout(() => modal.remove(), 300);
                    
                    // Visual feedback for progression
                    if (typeof incrementWatchCount === 'function') incrementWatchCount(); 
                };
            }

            function toggleUserMenu() {
                const menu = document.getElementById('user-menu');
                const createMenu = document.getElementById('create-dropdown');
                if (createMenu) createMenu.style.display = 'none';
                menu.style.display = menu.style.display === 'block' ? 'none' : 'block';
            }

            function toggleCreateMenu() {
                const createMenu = document.getElementById('create-dropdown');
                const userMenu = document.getElementById('user-menu');
                if (userMenu) userMenu.style.display = 'none';
                createMenu.style.display = createMenu.style.display === 'block' ? 'none' : 'block';
            }

            // Close menus on outside click
            window.addEventListener('click', (e) => {
                const userMenu = document.getElementById('user-menu');
                const createMenu = document.getElementById('create-dropdown');

                if (userMenu && !e.target.closest('.user-avatar') && !e.target.closest('#user-menu')) {
                    userMenu.style.display = 'none';
                }
                if (createMenu && !e.target.closest('.create-container')) {
                    createMenu.style.display = 'none';
                }
            });

            function showPricing() {
                const user = JSON.parse(localStorage.getItem('vitox_user') || 'null');
                if (!user) {
                    showToast("Please login first to join Premium Squad!");
                    return;
                }

                const modal = document.createElement('div');
                modal.className = 'collab-modal-overlay';
                modal.style.display = 'flex';
                modal.style.zIndex = '200000';
                modal.innerHTML = `
                    <div class="collab-modal" style="max-width: 500px; padding: 40px; text-align: center; border: 2px solid #ffd700; background: #0a0a0a; border-radius: 32px; box-shadow: 0 0 50px rgba(255,215,0,0.15);">
                        <div style="width: 80px; height: 80px; background: rgba(255,215,0,0.1); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 20px; border: 2px solid #ffd700;">
                            <i class="fas fa-gem" style="color: #ffd700; font-size: 2.5rem;"></i>
                        </div>
                        <h2 style="color: #ffd700; font-size: 2rem; margin-bottom: 8px; font-weight: 800;">Vitox Premium</h2>
                        <p style="color: #888; margin-bottom: 32px; font-size: 1.1rem;">Unlock the elite creator experience</p>
                        
                        <div style="text-align: left; margin: 0 auto 32px auto; display: block; background: rgba(255,255,255,0.03); padding: 24px; border-radius: 20px; border: 1px solid rgba(255,255,255,0.05);">
                            <div style="margin-bottom: 16px; display: flex; align-items: center; gap: 12px;"><i class="fas fa-bolt" style="color: #ffd700;"></i> <span><b>Unlimited AI Usage</b> (No daily limits)</span></div>
                            <div style="margin-bottom: 16px; display: flex; align-items: center; gap: 12px;"><i class="fas fa-check-circle" style="color: #ffd700;"></i> <span><b>Golden Tick</b> Verified Badge</span></div>
                            <div style="margin-bottom: 16px; display: flex; align-items: center; gap: 12px;"><i class="fas fa-cloud-upload" style="color: #ffd700;"></i> <span><b>4K Video Support</b> (Up to 2GB)</span></div>
                            <div style="display: flex; align-items: center; gap: 12px;"><i class="fas fa-crown" style="color: #ffd700;"></i> <span><b>Priority Support</b> & Ad Revenue</span></div>
                        </div>

                        <div style="font-size: 2rem; font-weight: 800; color: white; margin-bottom: 24px;">â‚¹99<span style="font-size: 1rem; color: #666; font-weight: 400;">/month</span></div>

                        <button id="rzp-button1" style="background: linear-gradient(45deg, #ffd700, #ffaa00); color: black; border: none; padding: 18px 32px; border-radius: 40px; font-weight: 800; font-size: 1.2rem; cursor: pointer; width: 100%; transition: 0.3s; box-shadow: 0 10px 20px rgba(255,215,0,0.2);">
                            UPGRADE TO PREMIUM
                        </button>
                        
                        <button onclick="this.parentElement.parentElement.remove()" style="background: transparent; color: #555; border: none; margin-top: 20px; cursor: pointer; font-weight: 600;">Close</button>
                    </div>
                `;
                document.body.appendChild(modal);

                document.getElementById('rzp-button1').onclick = function(e) {
                    modal.remove();
                    startRazorpayPayment();
                    e.preventDefault();
                }
            }

            function startRazorpayPayment() {
                const user = JSON.parse(localStorage.getItem('vitox_user'));
                
                const options = {
                    "key": "rzp_test_YOUR_KEY_HERE", // Replace with real key when ready
                    "amount": "9900", // 99.00 INR
                    "currency": "INR",
                    "name": "Vitox Media",
                    "description": "Monthly Premium Subscription",
                    "image": "https://creatorstudio-pro.onrender.com/favicon.svg",
                    "handler": function (response){
                        // Payment Success
                        showToast(`ðŸš€ Success! Payment ID: ${response.razorpay_payment_id}`);
                        upgradeUserToPremium(response.razorpay_payment_id);
                    },
                    "prefill": {
                        "name": user.name || "Vitox User",
                        "email": user.email
                    },
                    "theme": {
                        "color": "#ff0055"
                    }
                };
                
                const rzp1 = new Razorpay(options);
                rzp1.on('payment.failed', function (response){
                    showToast("âŒ Payment Failed: " + response.error.description);
                });
                rzp1.open();
            }

            async function upgradeUserToPremium(paymentId) {
                const user = JSON.parse(localStorage.getItem('vitox_user'));
                try {
                    const res = await fetch('/api/upgrade-premium', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ email: user.email, payment_id: paymentId })
                    });
                    const data = await res.json();
                    if (data.status === 'success') {
                        showToast("ðŸ‘‘ Welcome to the Squad! You are now Premium.");
                        // Update UI to show gold theme/badge
                        location.reload(); 
                    }
                } catch (e) { console.error(e); }
            }

            function logout() {
                localStorage.removeItem('vitox_user');
                location.reload();
            }

            // Privacy & Terms Modal
            function showPagesModal() {
                const modal = document.createElement('div');
                modal.style.cssText = `
                position: fixed; top: 0; left: 0; right: 0; bottom: 0;
                background: rgba(0,0,0,0.8); z-index: 5000;
                display: flex; align-items: center; justify-content: center;
                backdrop-filter: blur(5px);
            `;

                modal.innerHTML = `
                <div style="background: #1e1e1e; width: 90%; max-width: 600px; max-height: 80vh; border-radius: 16px; overflow-y: auto; padding: 24px; position: relative; border: 1px solid rgba(255,255,255,0.1);">
                    <button onclick="this.closest('div').parentNode.remove()" style="position: absolute; top: 16px; right: 16px; background: none; border: none; color: white; font-size: 1.5rem;"><i class="fas fa-times"></i></button>
                    
                    <h2 style="margin-top: 0; display: flex; align-items: center; gap: 10px;">
                        <i class="fas fa-shield-halved" style="color: #ff0055;"></i> Privacy & Terms
                    </h2>
                    
                    <div style="margin-top: 20px; line-height: 1.6; color: #ccc; font-size: 0.95rem;">
                        <h3 style="color: white; margin-bottom: 8px;">1. Privacy Policy</h3>
                        <p>At Vitox, we prioritize your data privacy. We collect minimal data (email, name, picture) solely for authentication via Google. We do not sell your personal data to third parties.</p>
                        
                        <h3 style="color: white; margin: 20px 0 8px;">2. Content Policy</h3>
                        <p>Users are responsible for the content they upload. <strong>Strictly prohibited:</strong> Nudity, hate speech, violence, and copyright infringement.</p>
                        
                        <h3 style="color: white; margin: 20px 0 8px;">3. Monetization (1050 Rule)</h3>
                        <p>Creators are eligible for monetization after reaching 1,000 subscribers and 10,000 views. Videos are monetized directly via the creator's personal Google AdSense account. <strong>You keep 100% of the AdSense revenue generated on your videos!</strong> Vitox does not take a cut from your personal video ads.</p>

                        <h3 style="color: white; margin: 20px 0 8px;">4. Vitox Platform Revenue</h3>
                        <p>While creators keep 100% of revenue from their specific video ads, Vitox generates revenue to maintain the platform through: <strong>1) Premium Subscriptions (Vitox+)</strong> for ad-free browsing and exclusive badges, and <strong>2) Platform-Wide Display Ads</strong> shown on the homepage and feed, which do not interfere with creator's video earnings.</p>

                        <h3 style="color: white; margin: 20px 0 8px;">5. User Data & Deletion</h3>
                        <p>You can request full data deletion by contacting <a href="mailto:support@vitox.in" style="color: #ff0055;">support@vitox.in</a> or using the 'Delete Account' option in settings.</p>
                        
                        <div style="margin-top: 30px; padding: 16px; background: rgba(255,255,255,0.05); border-radius: 8px; font-size: 0.85rem;">
                            <strong>Contact Us:</strong><br>
                            Vitox Media Pvt Ltd.<br>
                            Email: contact@vitox.in
                        </div>
                    </div>
                </div>
            `;

                document.body.appendChild(modal);
            }

            // Professional AdSense Linking Modal
            function showAdSenseModal() {
                const modal = document.createElement('div');
                modal.style.cssText = `
                position: fixed; top: 0; left: 0; right: 0; bottom: 0;
                background: rgba(0,0,0,0.8); z-index: 10006;
                display: flex; align-items: center; justify-content: center;
                backdrop-filter: blur(8px);
            `;

                modal.innerHTML = `
                <div style="background: #111; width: 90%; max-width: 480px; border-radius: 20px; overflow: hidden; position: relative; border: 1px solid rgba(0,255,136,0.15); box-shadow: 0 25px 60px rgba(0,0,0,0.9), 0 0 30px rgba(0,255,136,0.05); animation: scale-in 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);">
                    <button onclick="this.closest('div').parentNode.remove()" style="position: absolute; top: 16px; right: 16px; background: none; border: none; color: #888; font-size: 1.5rem; cursor: pointer; transition: 0.2s; z-index: 2;" onmouseover="this.style.color='#fff'" onmouseout="this.style.color='#888'"><i class="fas fa-times"></i></button>
                    
                    <div style="padding: 40px 30px 30px; text-align: center; border-bottom: 1px solid rgba(255,255,255,0.05); background: radial-gradient(circle at top, rgba(0,255,136,0.08) 0%, rgba(17,17,17,1) 70%);">
                        <div style="width: 72px; height: 72px; background: #00ff88; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 24px; box-shadow: 0 0 25px rgba(0,255,136,0.4);">
                            <i class="fab fa-google" style="color: black; font-size: 2.2rem;"></i>
                        </div>
                        <h2 style="margin: 0 0 12px; font-weight: 800; font-size: 1.6rem; color: #fff;">Connect to AdSense</h2>
                        <p style="color: #aaa; font-size: 0.95rem; line-height: 1.5; margin: 0;">Link your Vitox channel to your personal Google AdSense account. <strong style="color:#00ff88;">You keep 100% of the revenue</strong> generated from ads shown specifically on your videos!</p>
                    </div>

                    <div style="padding: 30px; background: #0a0a0a;">
                        <div style="display: flex; align-items: center; gap: 16px; margin-bottom: 20px;">
                            <div style="width: 36px; height: 36px; background: rgba(0,255,136,0.1); border-radius: 8px; display: flex; align-items: center; justify-content: center;">
                                <i class="fas fa-shield-check" style="color: #00ff88; font-size: 1.1rem;"></i>
                            </div>
                            <div style="font-size: 0.95rem; color: #ddd; font-weight: 500;">Secure OAuth 2.0 connection</div>
                        </div>
                        <div style="display: flex; align-items: center; gap: 16px; margin-bottom: 32px;">
                            <div style="font-size: 0.95rem; color: #ddd; font-weight: 500;">Setup tax profile & payments</div>
                        </div>

                        <div style="margin-bottom: 24px; text-align: left;">
                            <label style="display: block; font-size: 0.85rem; color: #aaa; margin-bottom: 8px; font-weight: 500;">Your AdSense Publisher ID (Parents' ID if under 18)</label>
                            <input type="text" id="adsense-pub-id" placeholder="e.g. pub-1234567890123456" style="width: 100%; box-sizing: border-box; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); padding: 12px 16px; border-radius: 8px; color: white; outline: none; font-family: 'Outfit', sans-serif; font-size: 0.95rem; transition: border-color 0.2s;" onfocus="this.style.borderColor='#00ff88'" onblur="this.style.borderColor='rgba(255,255,255,0.1)'">
                            <div style="font-size: 0.75rem; color: #777; margin-top: 6px;">We use this ID to show your ads on your videos.</div>
                        </div>

                        <button id="adsense-connect-btn" onclick="simulateAdSenseConnect(this)" style="width: 100%; padding: 16px; background: #00ff88; color: black; border: none; border-radius: 12px; font-weight: 800; font-size: 1rem; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px; transition: 0.2s; box-shadow: 0 4px 15px rgba(0,255,136,0.3);">
                            <span>Continue to Google AdSense</span> <i class="fas fa-arrow-right"></i>
                        </button>
                    </div>
                </div>
            `;
                document.body.appendChild(modal);
            }

            function simulateAdSenseConnect(btn) {
                const pubIdInput = document.getElementById('adsense-pub-id');
                const pubId = pubIdInput ? pubIdInput.value.trim() : '';

                if (!pubId || !pubId.startsWith('pub-')) {
                    alert("Please enter a valid AdSense Publisher ID starting with 'pub-'. If you are under 18, please use your parents' AdSense ID here.");
                    return;
                }

                if(btn.disabled) return;
                btn.disabled = true;
                btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> <span>Connecting securely...</span>';
                btn.style.opacity = '0.7';
                btn.style.cursor = 'wait';
                
                const user = JSON.parse(localStorage.getItem('vitox_user'));
                
                // Real Backend Sync
                fetch('/api/user/adsense', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        email: user ? user.email : '',
                        adsense_pub: pubId
                    })
                }).then(() => {
                    btn.innerHTML = '<i class="fas fa-check-circle" style="font-size: 1.2rem;"></i> <span>Account Linked!</span>';
                    btn.style.background = '#fff';
                    btn.style.color = '#000';
                    btn.style.boxShadow = '0 4px 15px rgba(255,255,255,0.3)';
                    btn.style.opacity = '1';
                    
                    setTimeout(() => {
                        localStorage.setItem('vitox_adsense_pub', pubId);
                        window.location.href = "earn.html"; 
                    }, 1200);
                }).catch(err => {
                    console.error(err);
                    alert("Sync failed, but linked locally.");
                    window.location.href = "earn.html";
                });
            }
            function shareVideo(videoId) {
                const baseUrl = window.location.origin + window.location.pathname;
                const shareUrl = videoId ? `${baseUrl}?v=${videoId}` : window.location.href;

                if (navigator.share) {
                    navigator.share({
                        title: 'Watch this on Vitox',
                        url: shareUrl
                    }).catch(console.error);
                } else {
                    navigator.clipboard.writeText(shareUrl).then(() => {
                        showToast("Link copied to clipboard!");
                    }).catch(() => {
                        showToast("Failed to copy link.");
                    });
                }
            }

            async function runVitoxTool(toolName) {
                const promptInput = document.getElementById('tool-prompt').value.trim();
                const user = JSON.parse(localStorage.getItem('vitox_user'));
                if (!promptInput) return showToast("Please describe what you want to generate.", "error");
                
                const overlay = document.getElementById('ai-loading-overlay');
                const placeholder = document.getElementById('ai-tool-placeholder');
                const preview = document.getElementById('ai-tool-preview');
                const btn = document.getElementById('tool-gen-btn');

                if (overlay) overlay.style.display = 'flex';
                if (btn) { btn.disabled = true; btn.style.opacity = '0.5'; }

                try {
                    // Let's first ask Gemini to enhance the prompt for a better image
                    const res = await fetch('/api/ai/ask', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            prompt: `Enhance this prompt to generate a stunning, highly detailed ${toolName} image. Provide ONLY the enhanced prompt string, nothing else. Original: ${promptInput}`,
                            model: 'gemini-flash',
                            email: user ? user.email : null
                        })
                    });
                    const data = await res.json();
                    const enhancedPrompt = data.answer || promptInput;
                    
                    // Use Pollinations AI for free, fast, high-quality image generation based on the prompt
                    const seed = Math.floor(Math.random() * 1000000);
                    const width = viewName.includes('Thumbnail') ? 1280 : (viewName.includes('Logo') ? 512 : 1024);
                    const height = viewName.includes('Thumbnail') ? 720 : (viewName.includes('Logo') ? 512 : 1024);
                    const imageUrl = `https://image.pollinations.ai/prompt/${encodeURIComponent(enhancedPrompt)}?seed=${seed}&width=${width}&height=${height}&nologo=true`;
                    
                    if (placeholder) placeholder.style.display = 'none';
                    if (preview) {
                        preview.innerHTML = `
                            <img src="${imageUrl}" alt="AI Generated Asset" style="width: 100%; height: 100%; object-fit: contain; animation: fadeIn 1s; background: #000;">
                            <div style="position: absolute; bottom: 0; left: 0; right: 0; background: rgba(0,0,0,0.85); padding: 20px; font-size: 0.85rem; color: #eee; backdrop-filter: blur(8px); transform: translateY(100%); transition: 0.3s;" id="ai-asset-details" onmouseenter="this.style.transform='translateY(0)'" onmouseleave="this.style.transform='translateY(calc(100% - 10px))'">
                                <div style="display: flex; justify-content: center; width: 100%; height: 10px; cursor: pointer; margin-top: -10px;">
                                    <div style="width: 40px; height: 4px; background: rgba(255,255,255,0.3); border-radius: 4px;"></div>
                                </div>
                                <div style="color: #ff0055; font-weight: 800; margin-bottom: 8px; font-size: 0.75rem; letter-spacing: 1px;">⚙️ ENHANCED PROMPT</div>
                                <div style="font-size: 0.8rem; color: #bbb; margin-bottom: 15px;">${enhancedPrompt}</div>
                                <div style="display: flex; gap: 10px;">
                                    <button onclick="downloadAsset('${imageUrl}')" style="background: white; color: black; border: none; padding: 8px 16px; border-radius: 6px; font-weight: 800; cursor: pointer; transition: 0.2s;"><i class="fas fa-download"></i> Save to Device</button>
                                </div>
                            </div>
                        `;
                        // Auto-show the details drawer for 3 seconds then hide
                        setTimeout(() => {
                           const details = document.getElementById('ai-asset-details');
                           if(details) details.style.transform = 'translateY(calc(100% - 10px))';
                        }, 3000);
                        setTimeout(() => {
                           const details = document.getElementById('ai-asset-details');
                           if(details) details.style.transform = 'translateY(0)';
                        }, 100);
                    }
                    showToast(`${toolName} Generated!`);
                } catch (e) {
                    console.error(e);
                    showToast("AI Generation Error", "error");
                } finally {
                    if (overlay) overlay.style.display = 'none';
                    if (btn) { btn.disabled = false; btn.style.opacity = '1'; }
                }
            }

            async function generateAILogo() {
                const prompt = document.getElementById('logo-prompt').value.trim();
                const preview = document.getElementById('ai-logo-preview');
                if (!prompt) return showToast("Enter a prompt first", "error");

                preview.innerHTML = '<i class="fas fa-spinner fa-spin" style="color: #ff0055; font-size: 2rem;"></i>';
                
                const seed = Math.floor(Math.random() * 1000000);
                const imageUrl = `https://image.pollinations.ai/prompt/${encodeURIComponent(prompt + " gaming logo, minimalist, clean, vector style, white background")}?seed=${seed}&width=512&height=512&nologo=true`;

                // Preload image
                const img = new Image();
                img.onload = () => {
                    preview.innerHTML = `<img src="${imageUrl}" style="width: 100%; height: 100%; object-fit: cover; animation: scale-in 0.5s;">`;
                    showToast("Custom Logo Refined!");
                };
                img.onerror = () => {
                    preview.innerHTML = '<i class="fas fa-exclamation-triangle" style="color: #ff0000; font-size: 2rem;"></i>';
                    showToast("Generation failed", "error");
                };
                img.src = imageUrl;
            }

            function downloadAsset(url) {
                const a = document.createElement('a');
                a.href = url;
                a.download = `Vitox_AI_Studio_${Date.now()}.jpg`;
                a.click();
            }

            function showToast(msg, type='success') {
                const existing = document.querySelector('.vitox-toast');
                if (existing) existing.remove();

                const toast = document.createElement('div');
                toast.className = 'vitox-toast';
                toast.style.cssText = `position:fixed; bottom: 40px; left: 50%; transform: translateX(-50%); background: ${type==='success'?'rgba(0,0,0,0.9)':'rgba(255,0,85,0.9)'}; color: white; padding: 14px 28px; border-radius: 50px; z-index: 100000; box-shadow: 0 10px 40px rgba(0,0,0,0.6); font-weight: 700; font-size: 0.95rem; animation: alert-slide-in 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); border: 1px solid rgba(255,255,255,0.1); backdrop-filter: blur(10px);`;
                toast.innerHTML = (type==='success'?'<i class="fas fa-check-circle" style="color:#00ff88; margin-right: 10px;"></i>' : '<i class="fas fa-exclamation-circle" style="color:white; margin-right: 10px;"></i>') + msg;
                document.body.appendChild(toast);
                setTimeout(() => {
                    toast.style.animation = 'alert-slide-in 0.4s reverse forwards';
                    setTimeout(() => toast.remove(), 400);
                }, 4000);
            }
            // User Retention / Psychology Hooks
            function initRetentionHooks() {
                const hooksContainer = document.getElementById('retention-hooks-container');
                if (!hooksContainer) return;
                
                // Only show on 'All' category or Feed
                const activeCategory = document.querySelector('.categories-bar .chip.active');
                if (activeCategory && activeCategory.innerText !== 'All') {
                    hooksContainer.style.display = 'none';
                    return;
                }
                
                hooksContainer.style.display = 'block';

                // 1. Progress Hook (Continue logic)
                const historyStr = localStorage.getItem('vitox_history');
                const cwCard = document.getElementById('continue-watching-card');
                if (historyStr && historyStr !== '[]') {
                    const history = JSON.parse(historyStr);
                    if (history.length > 0) {
                        const lastVideo = history[0];
                        document.getElementById('cw-title').innerText = lastVideo.title || 'Untitled';
                        document.getElementById('cw-channel').innerText = '@' + (lastVideo.user_email ? lastVideo.user_email.split('@')[0] : 'user');
                        let thumbUrl = lastVideo.url && lastVideo.url.includes('cloudinary') ? 
                            lastVideo.url.replace('/video/upload/', '/video/upload/c_fill,h_100,w_180,so_auto/').replace(/\.[^/.]+$/, ".jpg") : 
                            'https://dummyimage.com/180x100/111/ff0055.png';
                        // Keep live stream placeholder nice
                        if (lastVideo.url === 'live-placeholder') thumbUrl = 'https://dummyimage.com/180x100/111/ff0000.png&text=LIVE';
                        document.getElementById('cw-img').src = thumbUrl;
                        cwCard.style.display = 'block';
                        cwCard.onclick = () => {
                            const found = allVideos.find(v => String(v.id) === String(lastVideo.id));
                            if (found) {
                                playVideo(found.video_url, found.title, found.user_email, found.views, found.timestamp, found.description, found.id, found.type);
                            } else {
                                playVideo(lastVideo.url, lastVideo.title, lastVideo.user_email, lastVideo.views, lastVideo.timestamp, '', lastVideo.id, 'video');
                            }
                        };
                    }
                } else {
                    cwCard.style.display = 'none';
                }

                // 2. Gamification Logic
                updateGamificationUI();
            }

            function incrementWatchCount() {
                let count = parseInt(localStorage.getItem('vitox_watch_count') || '0');
                if (count < 0 || isNaN(count)) {
                    count = 0;
                }
                
                count += 1;
                localStorage.setItem('vitox_watch_count', count);
                
                // Dopamine hits
                if (count === 1) { showToast("ðŸŽ‰ Badge Unlocked: First Blood!"); }
                if (count === 5) { showToast("ðŸ† Badge Unlocked: Avid Watcher!"); }
                if (count === 10) { showToast("ðŸ‘‘ Badge Unlocked: Vitox Master!"); }
                
                updateGamificationUI();
            }

            function updateGamificationUI() {
                const count = parseInt(localStorage.getItem('vitox_watch_count') || '0');
                const badgeLevel = document.getElementById('badge-level');
                const badgeProgress = document.getElementById('badge-progress');
                const badgeIcon = document.getElementById('badge-icon');
                if (!badgeLevel) return;

                let levelName = "Rookie";
                let progress = 0;
                let color = "#cd7f32"; // Bronze

                if (count < 5) {
                    levelName = "Rookie (Lvl 1)";
                    progress = (count / 5) * 100;
                    badgeIcon.className = "fas fa-seedling";
                } else if (count < 10) {
                    levelName = "Explorer (Lvl 2)";
                    progress = ((count - 5) / 5) * 100;
                    color = "#c0c0c0"; // Silver
                    badgeIcon.className = "fas fa-compass";
                } else {
                    levelName = "Vitox Master";
                    progress = 100;
                    color = "#ffd700"; // Gold
                    badgeIcon.className = "fas fa-crown";
                }

                badgeLevel.innerText = levelName;
                badgeLevel.style.color = color;
                badgeProgress.style.width = progress + '%';
                badgeProgress.style.background = color;
                badgeIcon.style.color = color;
                badgeIcon.parentElement.style.borderColor = color;
                badgeIcon.parentElement.style.boxShadow = `0 0 15px ${color}44`;
                badgeIcon.parentElement.style.background = `${color}11`;
            }

            // ===================================================
            // FEATURE 1: TRENDING ALGORITHM
            // ===================================================
            function renderTrendingStrip(videos) {
                const container = document.getElementById('trending-chips');
                if (!container || !videos || !videos.length) return;
                const trending = [...videos].filter(v => v.type !== 'live').sort((a, b) => (b.views||0) - (a.views||0)).slice(0, 8);
                container.innerHTML = '';
                trending.forEach((v, i) => {
                    const chip = document.createElement('div');
                    chip.style.cssText = `background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.08);border-radius:40px;padding:8px 16px;cursor:pointer;display:flex;align-items:center;gap:10px;transition:0.2s;${i===0?'border-color:rgba(255,85,0,0.5);background:rgba(255,85,0,0.08);':''}`;
                    const views = v.views >= 1000 ? (v.views/1000).toFixed(1)+'K' : (v.views||0);
                    chip.innerHTML = `<span style="color:${i===0?'#ff5500':'#888'};font-weight:800;font-size:0.8rem;">#${i+1}</span><span style="font-size:0.85rem;font-weight:600;max-width:150px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${v.title}</span><span style="color:#555;font-size:0.75rem;">${views} views</span>`;
                    chip.onmouseenter = () => chip.style.background = 'rgba(255,255,255,0.08)';
                    chip.onmouseleave = () => chip.style.background = i===0?'rgba(255,85,0,0.08)':'rgba(255,255,255,0.04)';
                    chip.onclick = () => playVideo(v.video_url, v.title, v.user_email, v.views, v.timestamp, v.description, v.id, v.type);
                    container.appendChild(chip);
                });
            }

            // ===================================================
            // FEATURE 2: FOR YOU (Personalized Feed)
            // ===================================================
            function renderForYouSection(videos) {
                const watchHistory = JSON.parse(localStorage.getItem('vitox_watch_history') || '[]');
                if (!watchHistory.length || !videos || !videos.length) return;
                const keywords = watchHistory.flatMap(h => (h.title||'').toLowerCase().split(' ')).filter(w => w.length > 3);
                const scored = videos.filter(v => !watchHistory.some(h => h.id === v.id)).map(v => {
                    const content = (v.title+' '+(v.description||'')+' '+(v.category||'')).toLowerCase();
                    return { ...v, score: keywords.filter(k => content.includes(k)).length };
                }).filter(v => v.score > 0).sort((a, b) => b.score - a.score).slice(0, 6);
                if (!scored.length) return;
                const row = document.getElementById('for-you-row');
                const grid = document.getElementById('for-you-grid');
                if (!row || !grid) return;
                row.style.display = 'block';
                grid.innerHTML = '';
                scored.forEach(v => {
                    const card = document.createElement('div');
                    card.style.cssText = 'background:#111;border-radius:12px;overflow:hidden;cursor:pointer;border:1px solid rgba(255,255,255,0.06);transition:0.2s;';
                    const thumb = v.thumbnail_url || 'https://dummyimage.com/320x180/111/ff0055.png';
                    const views = v.views >= 1000 ? (v.views/1000).toFixed(1)+'K' : (v.views||0);
                    card.innerHTML = `<div style="position:relative;aspect-ratio:16/9;overflow:hidden;"><img src="${thumb}" style="width:100%;height:100%;object-fit:cover;" loading="lazy"><div style="position:absolute;bottom:6px;right:6px;background:#7000ff;color:white;padding:2px 8px;border-radius:4px;font-size:0.65rem;font-weight:800;">FOR YOU</div></div><div style="padding:10px;"><div style="font-weight:700;font-size:0.85rem;line-height:1.3;margin-bottom:4px;">${v.title}</div><div style="color:#666;font-size:0.75rem;">${views} views</div></div>`;
                    card.onmouseenter = () => card.style.borderColor = 'rgba(112,0,255,0.3)';
                    card.onmouseleave = () => card.style.borderColor = 'rgba(255,255,255,0.06)';
                    card.onclick = () => playVideo(v.video_url, v.title, v.user_email, v.views, v.timestamp, v.description, v.id, v.type);
                    grid.appendChild(card);
                });
            }

            // ===================================================
            // FEATURE 3: CREATOR LEADERBOARD
            // ===================================================
            function loadLeaderboardView() {
                const grid = document.getElementById('main-video-grid');
                const emptyState = document.getElementById('empty-state');
                if(emptyState) emptyState.style.display = 'none';
                const c = {};
                allVideos.forEach(v => {
                    if(!c[v.user_email]) c[v.user_email] = {email:v.user_email,totalViews:0,videoCount:0};
                    c[v.user_email].totalViews += (v.views||0);
                    c[v.user_email].videoCount++;
                });
                const sorted = Object.values(c).sort((a,b) => b.totalViews - a.totalViews).slice(0,20);
                const medals = ['','',''];
                grid.style.display = 'block';
                grid.innerHTML = `<div style="max-width:700px;margin:0 auto;"><h2 style="font-size:1.5rem;font-weight:800;margin-bottom:24px;"><i class="fas fa-trophy" style="color:#ffd700;"></i> Creator Leaderboard</h2>${sorted.map((cr,i)=>`<div style="background:#111;border:1px solid ${i<3?'rgba(255,215,0,0.2)':'rgba(255,255,255,0.06)'};border-radius:16px;padding:16px 20px;margin-bottom:12px;display:flex;align-items:center;gap:16px;"><div style="font-size:${i<3?2:1}rem;font-weight:800;color:${i<3?'#ffd700':'#555'};width:40px;text-align:center;">${medals[i]||'#'+(i+1)}</div><div style="width:44px;height:44px;background:#222;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:800;font-size:1.1rem;color:white;border:2px solid ${i<3?'#ffd700':'rgba(255,255,255,0.1)'}">${cr.email.charAt(0).toUpperCase()}</div><div style="flex:1;"><div style="font-weight:700;">${cr.email.split('@')[0]}</div><div style="color:#666;font-size:0.8rem;">${cr.videoCount} videos</div></div><div style="text-align:right;"><div style="font-weight:800;color:${i<3?'#ffd700':'white'};font-size:1.1rem;">${cr.totalViews>=1000?(cr.totalViews/1000).toFixed(1)+'K':cr.totalViews}</div><div style="color:#555;font-size:0.75rem;">total views</div></div></div>`).join('')}</div>`;
            }

            // ===================================================
            // FEATURE 4: SHARE & EARN
            // ===================================================
            function shareAndEarn(videoId, videoTitle) {
                const shareUrl = window.location.origin + window.location.pathname + '?v=' + videoId;
                const doPoints = () => {
                    const user = JSON.parse(localStorage.getItem('vitox_user') || 'null');
                    if (user) { 
                        // Reward viewing user for sharing
                        fetch('/api/add-points', {method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({email:user.email,amount:10,description:'Shared a video'})}); 
                        // Reward content creator for the share
                        fetch('/api/record-engagement', {method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({video_id:videoId,user_email:user.email,action:'share'})});
                        showToast(' +10 Points for sharing!'); 
                    }
                    else { showToast(' Link copied! Login to earn points.'); }
                };
                if (navigator.share) { navigator.share({title:videoTitle+' on Vitox',text:'Watch this!',url:shareUrl}).then(doPoints).catch(()=>{}); }
                else { navigator.clipboard.writeText(shareUrl).then(() => { doPoints(); showToast(' Link copied!'); }); }
            }

            // ===================================================
            // FEATURE 5: IN-APP PUSH NOTIFICATIONS
            // ===================================================
            function showPushNotification(title, body) {
                const bar = document.getElementById('push-notif-bar');
                if(!bar) return;
                document.getElementById('push-notif-title').innerText = title;
                document.getElementById('push-notif-body').innerText = body;
                bar.style.display = 'flex';
                setTimeout(() => { bar.style.display = 'none'; }, 6000);
            }
            function schedulePushNotifications() {
                setTimeout(() => {
                    if (allVideos && allVideos.length > 0) {
                        const v = allVideos[Math.floor(Math.random() * Math.min(allVideos.length, 5))];
                        showPushNotification(' Trending on Vitox', '"' + v.title + '" is blowing up!');
                    }
                }, 3.5 * 60 * 1000);
            }

            // ===================================================
            // FEATURE 6: VIDEO CHAPTERS (from description)
            // ===================================================
            function parseChapters(description) {
                if (!description) return [];
                const chapters = [];
                const re = /^(\d{1,2}:\d{2}(?::\d{2})?)\s+(.+)/;
                description.split('\n').forEach(line => {
                    const m = line.trim().match(re);
                    if (m) { const p = m[1].split(':').map(Number); const sec = p.length===3?p[0]*3600+p[1]*60+p[2]:p[0]*60+p[1]; chapters.push({time:m[1],title:m[2].trim(),seconds:sec}); }
                });
                return chapters;
            }

            // ===================================================
            // WIRE UP: After loadVideos, run all hooks
            // ===================================================
            function loadForYouView() {
                loadVideos();
                setTimeout(() => { const el = document.getElementById('for-you-row'); if(el) el.scrollIntoView({behavior:'smooth'}); }, 1500);
            }

            // Patch renderVideos to also update Trending + For You
            (function() {
                const _orig = renderVideos;
                renderVideos = function(videos, flag) {
                    _orig(videos, flag);
                    if (allVideos && allVideos.length > 0) {
                        renderTrendingStrip(allVideos);
                        renderForYouSection(allVideos);
                        schedulePushNotifications();
                    }
                };
            })();

        </script>

    <!-- ✨ Auto Festival Theme System -->
    <div id="festival-banner" style="display:none; position:fixed; top:56px; left:0; right:0; z-index:99999; padding:10px 20px; text-align:center; font-weight:800; font-size:0.95rem; letter-spacing:0.5px; cursor:pointer; backdrop-filter:blur(10px);" onclick="document.getElementById('festival-banner').style.display='none'">
        <span id="festival-banner-text"></span>
        <span style="margin-left:12px; font-size:0.75rem; opacity:0.7;">(click to close)</span>
    </div>
    <canvas id="festival-canvas" style="position:fixed; top:0; left:0; width:100%; height:100%; pointer-events:none; z-index:99998;"></canvas>

    <script>
    (function() {
        const today = new Date();
        const month = today.getMonth() + 1; // 1-12
        const day = today.getDate();

        // Festival definitions — {name, emoji, startM, startD, endM, endD, banner color, text}
        const festivals = [
            {
                name: 'Holi',
                emoji: '🎨',
                startM: 3, startD: 10, endM: 3, endD: 16,
                bg: 'linear-gradient(90deg, #ff0055, #ff6600, #ffcc00, #00cc66, #0066ff, #cc00ff)',
                color: '#fff',
                msg: '🎨 Happy Holi from Vitox! Rang Barse! 🌈',
                effect: 'holi'
            },
            {
                name: 'Diwali',
                emoji: '🪔',
                startM: 10, startD: 20, endM: 11, endD: 5,
                bg: 'linear-gradient(90deg, #1a0a00, #ff8800, #ffd700, #ff6600)',
                color: '#ffd700',
                msg: '🪔 Happy Diwali from Vitox! Shubh Deepawali! ✨',
                effect: 'sparkle'
            },
            {
                name: 'Independence Day',
                emoji: '🇮🇳',
                startM: 8, startD: 14, endM: 8, endD: 15,
                bg: 'linear-gradient(90deg, #ff6600, #fff, #128807)',
                color: '#000080',
                msg: '🇮🇳 Happy Independence Day! Jai Hind! 🙏',
                effect: 'tricolor'
            },
            {
                name: 'Republic Day',
                emoji: '🇮🇳',
                startM: 1, startD: 25, endM: 1, endD: 26,
                bg: 'linear-gradient(90deg, #ff6600, #fff, #128807)',
                color: '#000080',
                msg: '🇮🇳 Happy Republic Day! Jai Hind! 🎺',
                effect: 'tricolor'
            },
            {
                name: 'Eid',
                emoji: '🌙',
                startM: 3, startD: 29, endM: 3, endD: 31,
                bg: 'linear-gradient(90deg, #006633, #00cc66, #ffd700)',
                color: '#fff',
                msg: '🌙 Eid Mubarak from Vitox! Khushiyan ho! ⭐',
                effect: 'sparkle'
            },
            {
                name: 'New Year',
                emoji: '🎆',
                startM: 1, startD: 1, endM: 1, endD: 2,
                bg: 'linear-gradient(90deg, #0d0d0d, #7000ff, #ff0055, #ffd700)',
                color: '#fff',
                msg: '🎆 Happy New Year 2026 from Vitox! Naye saal ki shubhkaamnayein! 🥳',
                effect: 'sparkle'
            },
            {
                name: 'Christmas',
                emoji: '🎄',
                startM: 12, startD: 24, endM: 12, endD: 26,
                bg: 'linear-gradient(90deg, #0a2a0a, #cc0000, #ffffff, #006600)',
                color: '#fff',
                msg: '🎄 Merry Christmas from Vitox! Ho Ho Ho! 🎅',
                effect: 'snow'
            }
        ];

        // Find active festival
        let active = null;
        for (const f of festivals) {
            const start = new Date(today.getFullYear(), f.startM - 1, f.startD);
            const end   = new Date(today.getFullYear(), f.endM - 1, f.endD, 23, 59);
            if (today >= start && today <= end) { active = f; break; }
        }

        if (!active) return;

        // Show banner
        const banner = document.getElementById('festival-banner');
        if (banner) {
            banner.style.background = active.bg;
            banner.style.color = active.color;
            banner.style.display = 'block';
            banner.style.textShadow = '0 1px 3px rgba(0,0,0,0.4)';
            document.getElementById('festival-banner-text').textContent = active.msg;
        }

        // Canvas particles
        const canvas = document.getElementById('festival-canvas');
        const ctx = canvas.getContext('2d');
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
        window.addEventListener('resize', () => { canvas.width = window.innerWidth; canvas.height = window.innerHeight; });

        let particles = [];

        if (active.effect === 'holi') {
            // Colorful powder puffs
            const colors = ['#ff0055','#ff6600','#ffcc00','#00cc66','#0099ff','#cc00ff','#ff99cc','#00ffcc'];
            for (let i = 0; i < 120; i++) {
                particles.push({
                    x: Math.random() * canvas.width,
                    y: -Math.random() * canvas.height,
                    r: Math.random() * 14 + 4,
                    color: colors[Math.floor(Math.random() * colors.length)],
                    speed: Math.random() * 2 + 0.5,
                    wobble: Math.random() * 3 - 1.5,
                    alpha: Math.random() * 0.7 + 0.3,
                    rotate: Math.random() * 360,
                    rotateSpeed: Math.random() * 4 - 2
                });
            }
        } else if (active.effect === 'sparkle') {
            for (let i = 0; i < 80; i++) {
                particles.push({
                    x: Math.random() * canvas.width,
                    y: Math.random() * canvas.height,
                    r: Math.random() * 3 + 1,
                    color: ['#ffd700','#fff','#ff6600','#ffcc00'][Math.floor(Math.random()*4)],
                    speed: Math.random() * 1 + 0.2,
                    wobble: Math.random() * 2 - 1,
                    alpha: Math.random(),
                    fade: Math.random() * 0.02 + 0.005
                });
            }
        } else if (active.effect === 'tricolor') {
            const colors = ['#ff6600','#ffffff','#128807'];
            for (let i = 0; i < 90; i++) {
                particles.push({
                    x: Math.random() * canvas.width,
                    y: -Math.random() * canvas.height,
                    r: Math.random() * 8 + 3,
                    color: colors[Math.floor(Math.random() * 3)],
                    speed: Math.random() * 2 + 0.5,
                    wobble: Math.random() * 2 - 1,
                    alpha: 0.8,
                    rotate: Math.random() * 360,
                    rotateSpeed: Math.random() * 3 - 1.5
                });
            }
        } else if (active.effect === 'snow') {
            for (let i = 0; i < 100; i++) {
                particles.push({
                    x: Math.random() * canvas.width,
                    y: -Math.random() * canvas.height,
                    r: Math.random() * 6 + 2,
                    color: '#fff',
                    speed: Math.random() * 1.5 + 0.3,
                    wobble: Math.random() * 1.5 - 0.75,
                    alpha: Math.random() * 0.7 + 0.3
                });
            }
        }

        // Auto stop after 8 seconds to not distract
        let frames = 0;
        const MAX_FRAMES = 480; // ~8 sec at 60fps

        function animate() {
            if (frames++ > MAX_FRAMES) {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                return;
            }
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            particles.forEach(p => {
                ctx.save();
                ctx.globalAlpha = Math.max(0, p.alpha);
                ctx.fillStyle = p.color;
                ctx.beginPath();

                if (active.effect === 'holi') {
                    // Powder blob shape
                    ctx.translate(p.x, p.y);
                    ctx.rotate((p.rotate || 0) * Math.PI / 180);
                    ctx.ellipse(0, 0, p.r * 1.5, p.r, 0, 0, Math.PI * 2);
                    p.rotate = (p.rotate || 0) + (p.rotateSpeed || 1);
                } else {
                    ctx.arc(p.x, p.y, p.r, 0, Math.PI * 2);
                }

                ctx.fill();
                ctx.restore();

                // Move
                p.y += p.speed;
                p.x += p.wobble;

                // Sparkle fade
                if (active.effect === 'sparkle') {
                    p.alpha -= p.fade || 0.01;
                    if (p.alpha <= 0) {
                        p.alpha = 1;
                        p.x = Math.random() * canvas.width;
                        p.y = Math.random() * canvas.height;
                    }
                }

                // Reset falling particles
                if (p.y > canvas.height + 20) {
                    p.y = -20;
                    p.x = Math.random() * canvas.width;
                }
            });

            requestAnimationFrame(animate);
        }

        animate();
    })();
    </script>
</body>

</html>
