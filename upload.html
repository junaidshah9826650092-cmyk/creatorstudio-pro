<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vitox Upload | Premium V4</title>
    <link rel="stylesheet" href="style.css?v=1.3">
    <link rel="stylesheet" href="upload.css?v=1.3">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>

<body>
    <div class="upload-container">
        <header class="upload-header">
            <h2 id="modal-title">Upload Videos</h2>
            <div class="actions">
                <button class="icon-btn" onclick="alert('Feedback coming soon')"><i
                        class="fas fa-comment-alt"></i></button>
                <button class="icon-btn" onclick="location.href='index.html'"><i class="fas fa-times"></i></button>
            </div>
        </header>

        <div class="upload-body">
            <div class="form-area" id="main-scroll-area">
                <!-- Step 1: Drop Zone -->
                <div class="drop-zone" id="drop-zone" onclick="document.getElementById('file-input').click()">
                    <div class="circle-icon">
                        <i class="fas fa-upload"></i>
                    </div>
                    <p style="font-size: 1.1rem; margin-bottom: 8px; font-weight: 600;">Drag and drop video files to
                        upload</p>
                    <p style="color: #aaa; font-size: 0.85rem; margin-bottom: 24px;">Your videos will be private until
                        you publish them.</p>
                    <button class="btn-upload" style="margin-top:0;">Select Files</button>
                    <input type="file" id="file-input" accept="video/*" style="display: none;"
                        onchange="handleFileSelect(event)">
                </div>

                <!-- Step 2: Details Form -->
                <div class="details-section" id="details-section">
                    <div class="section-title">Details</div>
                    <div class="input-wrapper">
                        <label>Title (required)</label>
                        <input type="text" id="video-title" placeholder="Add a title that describes your video">
                        <div class="ai-btn-wrapper">
                            <button class="btn-ai" onclick="suggestAI(event)"><i class="fas fa-magic"></i> AI</button>
                        </div>
                    </div>
                    <div class="input-wrapper">
                        <label>Description</label>
                        <textarea id="video-desc" rows="5" placeholder="Tell viewers about your video"></textarea>
                    </div>
                    <div class="section-title" style="margin-top: 32px;">Thumbnail</div>
                    <p style="color: #aaa; font-size: 0.85rem; margin-bottom: 16px;">Select or upload a picture that
                        shows what's in your video.</p>
                    <div style="display: flex; gap: 16px;">
                        <div
                            style="width: 140px; height: 80px; border: 1px dashed #555; display: flex; align-items: center; justify-content: center; flex-direction: column; cursor: pointer; border-radius: 2px;">
                            <i class="fas fa-image" style="color: #aaa; margin-bottom: 4px;"></i>
                            <span style="font-size: 0.7rem; color: #aaa;">Upload file</span>
                        </div>
                        <div
                            style="width: 140px; height: 80px; background: #222; display: flex; align-items: center; justify-content: center; border-radius: 2px; opacity: 0.5;">
                            <span style="font-size: 0.7rem; color: #777;">Auto-gen 1</span>
                        </div>
                    </div>
                </div>
            </div>

            <aside class="video-preview-sidebar" id="preview-sidebar">
                <div class="preview-player">
                    <video id="preview-video" controls></video>
                </div>
                <div class="file-info-item">
                    <div class="file-info-label">Filename</div>
                    <div class="file-info-value" id="filename-display">video.mp4</div>
                </div>
                <div class="file-info-item">
                    <div class="file-info-label">Video Link</div>
                    <div class="file-info-value" style="color: #3ea6ff; cursor: pointer;">Processing...</div>
                </div>
            </aside>
        </div>

        <footer class="upload-footer">
            <div class="progress-section" id="progress-container">
                <div class="progress-bar-bg">
                    <div class="progress-bar-fill" id="progress-fill"></div>
                </div>
                <div class="status-text" id="status-msg">Ready to upload</div>
            </div>
            <div style="margin-left: auto;">
                <button class="btn-main" id="next-btn" disabled onclick="handleUpload()">Next</button>
            </div>
        </footer>
    </div>

    <script>
        const dropZone = document.getElementById('drop-zone');
        const fileInput = document.getElementById('file-input');
        const nextBtn = document.getElementById('next-btn');
        const detailsSection = document.getElementById('details-section');
        const previewSidebar = document.getElementById('preview-sidebar');
        const previewVideo = document.getElementById('preview-video');
        const progressContainer = document.getElementById('progress-container');
        const progressFill = document.getElementById('progress-fill');
        const statusMsg = document.getElementById('status-msg');

        let selectedFile = null;

        function handleFileSelect(e) { if (e.target.files.length > 0) handleFile(e.target.files[0]); }

        function handleFile(file) {
            if (!file.type.startsWith('video/')) { alert("Please upload a video."); return; }
            selectedFile = file;
            dropZone.style.display = 'none';
            detailsSection.style.display = 'block';
            previewSidebar.style.display = 'flex';
            nextBtn.disabled = false;
            document.getElementById('video-title').value = file.name.replace(/\.[^/.]+$/, "");
            document.getElementById('filename-display').innerText = file.name;
            previewVideo.src = URL.createObjectURL(file);
        }

        async function suggestAI(event) {
            const btn = event.currentTarget;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            try {
                const topic = document.getElementById('video-title').value || "Viral Video";
                const res = await fetch('/api/ai/suggest', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ topic: topic })
                });
                const data = await res.json();
                document.getElementById('video-title').value = data.title;
                document.getElementById('video-desc').value = data.description;
            } catch (e) { console.error(e); } finally { btn.innerHTML = '<i class="fas fa-magic"></i> AI'; }
        }

        async function handleUpload() {
            const user = JSON.parse(localStorage.getItem('vitox_user'));
            if (!user) { alert("Login first"); location.href = 'login.html'; return; }

            const title = document.getElementById('video-title').value;
            if (!title) { alert("Title is required"); return; }

            const cloudName = 'dybxv45hp';
            const uploadPreset = 'vitox_preset';

            nextBtn.disabled = true;
            progressContainer.style.display = 'block';
            statusMsg.innerText = "Attempting Cloud Upload...";
            statusMsg.style.color = "#ff003c";

            try {
                // --- TRY CLOUDINARY FIRST ---
                const cloudFormData = new FormData();
                cloudFormData.append('file', selectedFile);
                cloudFormData.append('upload_preset', uploadPreset);

                const res = await fetch(`https://api.cloudinary.com/v1_1/${cloudName}/video/upload`, {
                    method: 'POST',
                    body: cloudFormData
                });

                let videoUrl = "";
                let thumbUrl = "";

                if (res.ok) {
                    const data = await res.json();
                    videoUrl = data.secure_url;
                    thumbUrl = data.thumbnail_url || '';
                    statusMsg.innerText = "Cloud Upload Success!";
                } else {
                    // --- FALLBACK TO LOCAL SERVER ---
                    console.warn("Cloudinary failed, trying local fallback...");
                    statusMsg.innerText = "Cloud preset missing. Using Local Storage fallback...";

                    const localFormData = new FormData();
                    localFormData.append('file', selectedFile);

                    const localRes = await fetch('/api/video/upload-file', {
                        method: 'POST',
                        body: localFormData
                    });

                    if (!localRes.ok) throw new Error("Both Cloud and Local upload failed.");

                    const localData = await localRes.json();
                    videoUrl = localData.url;
                }

                // Final Step: Save to Database
                statusMsg.innerText = "Saving to database...";
                const dbRes = await fetch('/api/video/upload', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        email: user.email,
                        title: title,
                        description: document.getElementById('video-desc').value,
                        video_url: videoUrl,
                        thumbnail_url: thumbUrl
                    })
                });

                const dbData = await dbRes.json();
                if (dbData.status === 'success') {
                    alert("Video Published Successfully!");
                    location.href = 'index.html';
                } else {
                    throw new Error(dbData.message);
                }

            } catch (e) {
                console.error(e);
                statusMsg.innerText = "Error: " + e.message;
                statusMsg.style.color = "#ff4e4e";
                alert("Upload failed: " + e.message);
                nextBtn.disabled = false;
            }
        }
    </script>
</body>

</html>