<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vitox Upload | Premium V3</title>
    <!-- DEBUG: V3 - 10:50 AM -->
    <link rel="stylesheet" href="style.css?v=1.1">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="upload.css?v=1.1">
</head>

<body>
    <div class="upload-container">
        <!-- Header -->
        <header class="upload-header">
            <h2 id="modal-title">Upload videos</h2>
            <div class="actions">
                <button class="icon-btn" onclick="alert('Feedback coming soon')"><i
                        class="fas fa-comment-alt"></i></button>
                <button class="icon-btn" onclick="location.href='index.html'"><i class="fas fa-times"></i></button>
            </div>
        </header>

        <!-- Body -->
        <div class="upload-body">
            <!-- Form Area -->
            <div class="form-area" id="main-scroll-area">

                <!-- Step 1: Drop Zone -->
                <div class="drop-zone" id="drop-zone" onclick="document.getElementById('file-input').click()">
                    <div class="circle-icon">
                        <i class="fas fa-upload"></i>
                    </div>
                    <p style="font-size: 1.1rem; margin-bottom: 8px;">Drag and drop video files to upload</p>
                    <p style="color: #aaa; font-size: 0.85rem; margin-bottom: 24px;">Your videos will be private until
                        you publish them.</p>
                    <button class="btn-select">Select Files</button>
                    <input type="file" id="file-input" accept="video/*" style="display: none;"
                        onchange="handleFileSelect(event)">
                </div>

                <!-- Step 2: Details Form -->
                <div class="details-section" id="details-section">
                    <div class="section-title">Details</div>

                    <div class="input-wrapper">
                        <label>Title (required)</label>
                        <input type="text" id="video-title" placeholder="Add a title that describes your video">
                        <div class="ai-btn-wrapper">
                            <button class="btn-ai" onclick="suggestAI(event)">
                                <i class="fas fa-magic"></i> AI
                            </button>
                        </div>
                    </div>

                    <div class="input-wrapper">
                        <label>Description</label>
                        <textarea id="video-desc" rows="5" placeholder="Tell viewers about your video"></textarea>
                    </div>

                    <!-- Thumbnails Section -->
                    <div class="section-title" style="margin-top: 32px;">Thumbnail</div>
                    <p style="color: #aaa; font-size: 0.85rem; margin-bottom: 16px;">Select or upload a picture that
                        shows what's in your video.</p>
                    <div style="display: flex; gap: 16px;">
                        <div
                            style="width: 140px; height: 80px; border: 1px dashed #555; display: flex; align-items: center; justify-content: center; flex-direction: column; cursor: pointer; border-radius: 2px;">
                            <i class="fas fa-image" style="color: #aaa; margin-bottom: 4px;"></i>
                            <span style="font-size: 0.7rem; color: #aaa;">Upload file</span>
                        </div>
                        <div
                            style="width: 140px; height: 80px; background: #000; display: flex; align-items: center; justify-content: center; border-radius: 2px; opacity: 0.5;">
                            <span style="font-size: 0.7rem; color: #aaa;">Auto-gen 1</span>
                        </div>
                        <div
                            style="width: 140px; height: 80px; background: #000; display: flex; align-items: center; justify-content: center; border-radius: 2px; opacity: 0.5;">
                            <span style="font-size: 0.7rem; color: #aaa;">Auto-gen 2</span>
                        </div>
                    </div>

                </div>
            </div>

            <!-- Video Preview Sidebar (Right) -->
            <div class="video-preview-sidebar" id="preview-sidebar">
                <div class="preview-player">
                    <video id="preview-video" controls></video>
                </div>

                <div class="file-info-item">
                    <div class="file-info-label">Filename</div>
                    <div class="file-info-value" id="filename-display">video.mp4</div>
                </div>

                <div class="file-info-item">
                    <div class="file-info-label">Video Link</div>
                    <div class="file-info-value" style="color: #3ea6ff; cursor: pointer;">https://vitox.ai/v/xyz...
                    </div>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <footer class="upload-footer">
            <div class="progress-section" id="progress-container">
                <div class="progress-bar-bg">
                    <div class="progress-bar-fill" id="progress-fill"></div>
                </div>
                <div class="status-text" id="status-msg">Uploading 0% ...</div>
            </div>

            <div style="margin-left: auto;">
                <button class="btn-main" id="next-btn" disabled onclick="handleUpload()">Next</button>
            </div>
        </footer>
    </div>

    <script>

        // UI References
        const dropZone = document.getElementById('drop-zone');
        const fileInput = document.getElementById('file-input');
        const nextBtn = document.getElementById('next-btn');
        const mainScroll = document.getElementById('main-scroll-area');
        const detailsSection = document.getElementById('details-section');
        const previewSidebar = document.getElementById('preview-sidebar');
        const previewVideo = document.getElementById('preview-video');
        const progressContainer = document.getElementById('progress-container');
        const progressFill = document.getElementById('progress-fill');
        const statusMsg = document.getElementById('status-msg');

        let selectedFile = null;

        // -- Drag & Drop Logic --
        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.style.borderColor = 'var(--primary-accent)';
            dropZone.style.background = '#1f1f1f';
        });

        dropZone.addEventListener('dragleave', (e) => {
            e.preventDefault();
            dropZone.style.borderColor = '#333';
            dropZone.style.background = 'transparent';
        });

        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.style.borderColor = '#333';
            dropZone.style.background = 'transparent';

            if (e.dataTransfer.files.length > 0) {
                handleFile(e.dataTransfer.files[0]);
            }
        });

        function handleFileSelect(e) {
            if (e.target.files.length > 0) {
                handleFile(e.target.files[0]);
            }
        }

        function handleFile(file) {
            if (!file.type.startsWith('video/')) {
                alert("Please upload a valid video file.");
                return;
            }

            selectedFile = file;

            // UI Transition
            dropZone.style.display = 'none';
            detailsSection.style.display = 'block';
            previewSidebar.style.display = 'flex';
            progressContainer.style.display = 'block'; // Show valid state
            nextBtn.disabled = false;

            // Auto-fill details
            const cleanName = file.name.replace(/\.[^/.]+$/, "");
            document.getElementById('video-title').value = cleanName;
            document.getElementById('filename-display').innerText = file.name;

            // Setup Preview
            const url = URL.createObjectURL(file);
            previewVideo.src = url;
        }

        async function suggestAI(event) {
            const btn = event.currentTarget;
            const originalText = btn.innerHTML;
            const titleInput = document.getElementById('video-title');
            const descInput = document.getElementById('video-desc');

            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';

            try {
                const topic = titleInput.value || "Viral Video";
                const res = await fetch('/api/ai/suggest', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ topic: topic })
                });
                const data = await res.json();

                titleInput.value = data.title;
                descInput.value = data.description;
            } catch (e) {
                console.error(e);
            } finally {
                btn.innerHTML = originalText;
            }
        }

        async function handleUpload() {
            const user = JSON.parse(localStorage.getItem('vitox_user'));
            if (!user) {
                alert("Please login first");
                window.location.href = 'login.html';
                return;
            }

            if (!selectedFile) {
                alert("Please select a video file first");
                return;
            }

            const title = document.getElementById('video-title').value;
            const desc = document.getElementById('video-desc').value;

            if (!title) {
                alert("Please enter a title");
                return;
            }

            // --- CLOUDINARY CONFIG (PERMANENT CLOUD STORAGE) ---
            const cloudName = 'dybxv45hp'; // Updated with user's Cloud Name
            const uploadPreset = 'vitox_preset'; // User needs to create this Unsigned Preset

            nextBtn.disabled = true;
            progressContainer.style.display = 'block';
            statusMsg.innerText = "Connecting to Cloud (YouTube Style)...";

            const formData = new FormData();
            formData.append('file', selectedFile);
            formData.append('upload_preset', uploadPreset);

            try {
                // Upload directly to Cloudinary
                const res = await fetch(`https://api.cloudinary.com/v1_1/${cloudName}/video/upload`, {
                    method: 'POST',
                    body: formData
                });

                if (!res.ok) {
                    const errData = await res.json();
                    let errMsg = errData.error.message || "Cloud Upload Failed";
                    if (errMsg.includes("Unknown API key") || errMsg.includes("Invalid cloud name")) {
                        errMsg = "CRITICAL: Cloudinary Config Missing! Please update 'cloudName' in upload.html code with your actual Cloudinary name (Settings > Cloud Name).";
                    }
                    throw new Error(errMsg);
                }

                const data = await res.json();
                const videoUrl = data.secure_url;

                statusMsg.style.color = "var(--success)";
                statusMsg.innerText = "Cloud storage ready. Linking to Dashboard...";
                console.log("Cloud URL:", videoUrl);

                // Save Metadata to Python Backend
                const dbRes = await fetch('/api/video/upload', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        email: user.email,
                        title: title,
                        description: desc,
                        video_url: videoUrl,
                        thumbnail_url: data.thumbnail_url || ''
                    })
                });

                const dbData = await dbRes.json();
                if (dbData.status === 'success') {
                    alert("Video Published Successfully to Cloud!");
                    window.location.href = 'index.html';
                } else {
                    alert("Database Save Failed: " + dbData.message);
                }

            } catch (e) {
                console.error("Cloud Error:", e);
                statusMsg.style.color = "var(--error)";
                statusMsg.innerText = "Cloud Error: " + e.message;
                alert("Cloudinary Error: " + e.message + "\n\nPlease ensure your Cloudinary Preset is set to 'Unsigned'.");
                nextBtn.disabled = false;
            }
        }
    </script>
</body>

</html>
```