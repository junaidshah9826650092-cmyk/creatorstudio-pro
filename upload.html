<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vitox Upload | V8 GLOBAL CLOUD ONLY</title>
    <link rel="stylesheet" href="style.css?v=3.0">
    <link rel="stylesheet" href="upload.css?v=3.0">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- No ads on upload pages - AdSense policy compliance -->
</head>

<body style="background: #000;">
    <!-- Ads removed from upload form -->

    <div class="upload-container">
        <header class="upload-header">
            <div style="display: flex; flex-direction: column;">
                <h2 id="modal-title" style="margin-bottom: 4px;">Vitox Creator Studio</h2>
                <div style="font-size: 0.75rem; color: #888;">Save as private <i class="far fa-comment-alt"></i></div>
            </div>
            <div class="stepper">
                <div class="step active" id="step-node-1" data-title="Details"></div>
                <div class="step" id="step-node-2" data-title="Elements"></div>
                <div class="step" id="step-node-3" data-title="Checks"></div>
                <div class="step" id="step-node-4" data-title="Visibility"></div>
            </div>
            <div class="actions" style="display: flex; align-items: center; gap: 15px;">
                <div id="storage-status"
                    style="font-size: 0.7rem; font-weight: 700; padding: 4px 10px; border-radius: 20px; border: 1px solid #444; color: #888;">
                    <i class="fas fa-database"></i> Checking...
                </div>
                <button class="icon-btn" onclick="location.href='index.html'"><i class="fas fa-times"></i></button>
            </div>
        </header>

        <div class="upload-body">
            <div class="form-area" id="main-scroll-area">
                <!-- Drop Zone (Initial) -->
                <div class="drop-zone" id="drop-zone" onclick="document.getElementById('file-input').click()">
                    <div class="circle-icon"><i class="fas fa-cloud-upload-alt"></i></div>
                    <p style="font-size: 1.1rem; margin-bottom: 8px; font-weight: 600;">Vitox Creator Studio</p>
                    <p style="font-size: 0.85rem; color: #aaa; margin-bottom: 20px;">Drag and drop video files to upload
                    </p>
                    <button class="btn-upload" onclick="document.getElementById('file-input').click()">Select
                        Files</button>
                    <input type="file" id="file-input" accept="video/*" style="display: none;"
                        onchange="handleFileSelect(event)">
                </div>

                <!-- Step 1: Details -->
                <div class="step-content" id="step-1" style="display: none;">
                    <div class="details-section" id="details-section" style="display: block;">
                        <div class="section-title">Details</div>
                        <div class="input-wrapper">
                            <label>Title (required) <i class="far fa-question-circle"></i></label>
                            <input type="text" id="video-title" placeholder="Add a title that describes your video">
                            <div class="ai-btn-wrapper">
                                <button class="btn-ai" onclick="suggestAI(event)"><i class="fas fa-magic"></i>
                                    AI</button>
                            </div>
                        </div>

                        <!-- Video Type Selector -->
                        <div class="input-wrapper" style="margin-top: 24px; border: none; background: transparent;">
                            <label
                                style="position: static; font-size: 0.95rem; font-weight: 700; color: #fff; margin-bottom: 12px; display: block;">Video
                                Type</label>
                            <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                                <label class="type-option">
                                    <input type="radio" name="video_type" value="video" checked>
                                    <div class="option-card">
                                        <i class="fas fa-video"></i>
                                        <span>Regular Video</span>
                                    </div>
                                </label>
                                <label class="type-option">
                                    <input type="radio" name="video_type" value="short">
                                    <div class="option-card">
                                        <i class="fas fa-bolt"></i>
                                        <span>V-Snap (Short)</span>
                                    </div>
                                </label>
                            </div>
                        </div>

                        <!-- Category Selector -->
                        <div class="input-wrapper" style="margin-top: 24px;">
                            <label>Category (required)</label>
                            <select id="video-category"
                                style="width: 100%; background: transparent; border: none; color: white; padding: 28px 12px 10px 12px; font-size: 0.95rem; outline: none; appearance: none; cursor: pointer;">
                                <option value="All">All Categories</option>
                                <option value="Music">Music</option>
                                <option value="Gaming">Gaming</option>
                                <option value="Live">Live</option>
                                <option value="Tech">Tech</option>
                                <option value="News">News</option>
                                <option value="Comedy">Comedy</option>
                                <option value="Education">Education</option>
                            </select>
                            <i class="fas fa-chevron-down"
                                style="position: absolute; right: 15px; top: 28px; color: #888; pointer-events: none;"></i>
                        </div>
                        <div class="input-wrapper" style="margin-top: 32px;">
                            <label>Description <i class="far fa-question-circle"></i></label>
                            <textarea id="video-desc" rows="5"
                                placeholder="Tell viewers about your video (type @ to mention a channel)"></textarea>
                            <div style="margin-top: 10px;">
                                <button class="btn-ai" onclick="predictViral(event)" style="background: rgba(255,0,85,0.1); color: #ff0055; border: 1px solid rgba(255,0,85,0.2);"><i class="fas fa-chart-line"></i> AI Viral Predictor</button>
                                <div id="viral-result" style="font-size: 0.8rem; margin-top: 8px; font-weight: 700; color: #ff0088;"></div>
                            </div>
                        </div>

                        <div style="margin-top: 40px;">
                            <div style="font-weight: 700; font-size: 0.95rem; margin-bottom: 12px;">Thumbnail</div>
                            <div style="font-size: 0.8rem; color: #aaa; margin-bottom: 16px;">Set a thumbnail that
                                stands out and draws viewers' attention. <a href="#"
                                    style="color: #3ea6ff; text-decoration: none;">Learn more</a></div>
                            <div style="display: flex; gap: 12px; flex-wrap: wrap;">
                                <div class="thumb-picker active" onclick="selectThumbnail(this)">
                                    <i class="fas fa-image"></i>
                                    <span>Auto</span>
                                </div>
                                <div class="thumb-picker" onclick="selectThumbnail(this)">
                                    <i class="fas fa-magic"></i>
                                    <span>AI Gen</span>
                                </div>
                                <div class="thumb-picker" onclick="selectThumbnail(this)">
                                    <i class="fas fa-plus"></i>
                                    <span>Upload</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Step 2: Elements -->
                <div class="step-content" id="step-2" style="display: none;">
                    <div class="section-title">Video elements</div>
                    <p style="font-size: 0.85rem; color: #aaa; margin-bottom: 24px;">Use cards and an end screen to show
                        viewers related videos, websites, and calls to action. <a href="#"
                            style="color: #3ea6ff; text-decoration: none;">Learn more</a></p>

                    <div class="element-row">
                        <div class="element-icon"><i class="fas fa-closed-captioning"></i></div>
                        <div class="element-info">
                            <div class="element-title">Add subtitles</div>
                            <div class="element-desc">Reach a broader audience by adding subtitles to your video</div>
                        </div>
                        <button class="element-btn" onclick="alert('Feature coming soon!')">ADD</button>
                    </div>

                    <div class="element-row">
                        <div class="element-icon"><i class="fas fa-window-restore"></i></div>
                        <div class="element-info">
                            <div class="element-title">Add an end screen</div>
                            <div class="element-desc">Promote related content at the end of your video</div>
                        </div>
                        <button class="element-btn" onclick="alert('Feature coming soon!')">ADD</button>
                    </div>

                    <div class="element-row">
                        <div class="element-icon"><i class="fas fa-info-circle"></i></div>
                        <div class="element-info">
                            <div class="element-title">Add cards</div>
                            <div class="element-desc">Promote related content during your video</div>
                        </div>
                        <button class="element-btn" onclick="alert('Feature coming soon!')">ADD</button>
                    </div>
                </div>

                <!-- Step 3: Checks -->
                <div class="step-content" id="step-3" style="display: none;">
                    <div class="section-title">Checks</div>
                    <p style="font-size: 0.85rem; color: #aaa; margin-bottom: 24px;">We'll check your video for issues
                        that may restrict its visibility and then you will have the opportunity to fix issues before
                        publishing your video. <a href="#" style="color: #3ea6ff; text-decoration: none;">Learn more</a>
                    </p>

                    <div style="margin-top: 40px;">
                        <div style="display: flex; align-items: center; justify-content: space-between;">
                            <div style="display: flex; align-items: center; gap: 16px;">
                                <div style="font-weight: 700;">Content Safety</div>
                                <div id="copyright-status" style="color: #00ff88;"><i class="fas fa-robot"></i> Vitox AI: Safe to Publish</div>
                            </div>
                            <i class="fas fa-check-circle" style="color: #00ff88;"></i>
                        </div>
                        <hr style="border:none; border-top: 1px solid #333; margin: 20px 0;">
                        <p style="font-size: 0.75rem; color: #888;">Remember: These check results aren't final. Issues
                            may come up in the future that impact your video. <a href="#"
                                style="color: #3ea6ff; text-decoration: none;">Learn more</a></p>
                    </div>
                </div>

                <!-- Step 4: Visibility -->
                <div class="step-content" id="step-4" style="display: none;">
                    <div class="section-title">Visibility</div>
                    <p style="font-size: 0.85rem; color: #aaa; margin-bottom: 24px;">Choose when to publish and who can
                        see your video</p>

                    <div
                        style="border: 1px solid #333; border-radius: 8px; padding: 24px; background: rgba(255,255,255,0.02);">
                        <div style="font-weight: 700; margin-bottom: 8px;">Save or publish</div>
                        <div style="font-size: 0.8rem; color: #aaa; margin-bottom: 20px;">Make your video <span
                                style="font-weight:700;">public, unlisted,</span> or <span
                                style="font-weight:700;">private</span></div>

                        <div style="display: flex; flex-direction: column; gap: 20px; padding-left: 10px;">
                            <label style="display: flex; align-items: flex-start; gap: 12px; cursor: pointer;">
                                <input type="radio" name="visibility" value="private" checked style="margin-top: 4px;">
                                <div>
                                    <div style="font-weight: 500; font-size: 0.9rem;">Private</div>
                                    <div style="font-size: 0.75rem; color: #888;">Only you and people who you choose can
                                        watch your video</div>
                                </div>
                            </label>
                            <label style="display: flex; align-items: flex-start; gap: 12px; cursor: pointer;">
                                <input type="radio" name="visibility" value="unlisted" style="margin-top: 4px;">
                                <div>
                                    <div style="font-weight: 500; font-size: 0.9rem;">Unlisted</div>
                                    <div style="font-size: 0.75rem; color: #888;">Anyone with the video link can watch
                                        your video</div>
                                </div>
                            </label>
                            <label style="display: flex; align-items: flex-start; gap: 12px; cursor: pointer;">
                                <input type="radio" name="visibility" value="public" style="margin-top: 4px;">
                                <div>
                                    <div style="font-weight: 500; font-size: 0.9rem;">Public</div>
                                    <div style="font-size: 0.75rem; color: #888;">Everyone can watch your video</div>
                                </div>
                            </label>
                        </div>
                    </div>
                </div>
            </div>

            <aside class="video-preview-sidebar" id="preview-sidebar">
                <div class="preview-player" style="position: relative;">
                    <video id="preview-video" controls style="width: 100%; height: 100%; object-fit: contain;"></video>
                    <div id="processing-overlay"
                        style="position: absolute; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); display:flex; flex-direction:column; align-items:center; justify-content:center; gap:12px; z-index: 10;">
                        <i class="fas fa-spinner fa-spin" style="font-size: 2rem;"></i>
                        <span style="font-size: 0.8rem; font-weight: 600;">Processing video...</span>
                    </div>
                </div>
                <div class="file-info-item">
                    <div class="file-info-label">Video link</div>
                    <div class="file-info-value" style="color: #3ea6ff; cursor: pointer;">https://vitox.in/v/PnlbyZ6Z6KM
                        <i class="far fa-copy" style="margin-left: 8px;"></i>
                    </div>
                </div>
                <div class="file-info-item">
                    <div class="file-info-label">Filename</div>
                    <div class="file-info-value" id="file-name-val" style="color: #fff;">-</div>
                </div>

                <div style="margin-top: auto; padding-top: 20px;">
                    <div class="file-info-item" style="display:flex; align-items:center; gap:12px; margin-bottom:0;">
                        <i class="fas fa-upload" style="color:#aaa;"></i>
                        <div id="upload-status-badge"
                            style="background:#333; padding:2px 8px; border-radius:4px; font-size:0.7rem; font-weight:800; color:#fff;">
                            SD</div>
                        <i class="fas fa-check-circle" style="color:#00ff88;"></i>
                        <div style="font-size: 0.75rem; color:#aaa;" id="bottom-status-text">Checks complete. No issues
                            found.</div>
                    </div>
                </div>
            </aside>
        </div>

        <footer class="upload-footer">
            <div class="status-indicators" style="display: flex; align-items: center; gap: 20px;">
                <div style="display: flex; align-items: center; gap: 8px;">
                    <i class="fas fa-arrow-up" style="font-size: 0.8rem; color: #aaa;"></i>
                    <i class="fas fa-closed-captioning" style="font-size: 0.8rem; color: #aaa;"></i>
                    <i class="fas fa-check-circle" style="font-size: 0.8rem; color: #aaa;"></i>
                </div>
                <div id="status-msg" style="font-size: 0.8rem; color: #aaa; font-weight: 500;">Checks complete. No
                    issues found.</div>
            </div>

            <div class="progress-section" id="progress-container"
                style="display: none; position: absolute; bottom: 0; left: 0; right: 0; margin: 0;">
                <div class="progress-bar-bg" style="height: 2px;">
                    <div class="progress-bar-fill" id="progress-fill"></div>
                </div>
            </div>

            <div style="margin-left: auto; display: flex; gap: 12px;">
                <button class="btn-secondary" id="back-btn"
                    style="display:none; background:#222; border:1px solid #444; color:#fff; padding: 8px 16px; border-radius:4px; font-weight:600; cursor:pointer;"
                    onclick="changeStep(-1)">Back</button>
                <button class="btn-main" id="next-btn" disabled onclick="changeStep(1)"
                    style="background:#fff; color:#000; padding: 8px 24px; border-radius:4px; font-weight:600; border:none; cursor:pointer;">Next</button>
                <button class="btn-main" id="publish-btn"
                    style="display:none; background: #fff; color: #000; padding: 8px 24px; border-radius:4px; font-weight:600; border:none; cursor:pointer;"
                    onclick="handleUpload()">Save</button>
            </div>
        </footer>
    </div>

    <script>
        const cloudName = 'dybxv45hp';
        const uploadPreset = 'vitox_preset';

        const dropZone = document.getElementById('drop-zone');
        const fileInput = document.getElementById('file-input');
        const nextBtn = document.getElementById('next-btn');
        const detailsSection = document.getElementById('details-section');
        const previewSidebar = document.getElementById('preview-sidebar');
        const previewVideo = document.getElementById('preview-video');
        const progressFill = document.getElementById('progress-fill');
        const statusMsg = document.getElementById('status-msg');

        let selectedFile = null;
        let currentStep = 1;

        function handleFileSelect(e) { if (e.target.files.length > 0) handleFile(e.target.files[0]); }

        function handleFile(file) {
            if (!file.type.startsWith('video/')) { alert("Please upload a video file."); return; }
            selectedFile = file;
            dropZone.style.display = 'none';
            previewSidebar.style.display = 'flex';
            nextBtn.disabled = false;

            const title = file.name.replace(/\.[^/.]+$/, "");
            document.getElementById('video-title').value = title;
            document.getElementById('modal-title').innerText = title;
            document.getElementById('file-name-val').innerText = file.name;
            previewVideo.src = URL.createObjectURL(file);

            // Show first step
            changeStep(0);

            // Auto start dummy processing
            setTimeout(() => {
                document.getElementById('processing-overlay').style.display = 'none';
                document.getElementById('bottom-status-text').innerText = "Processing complete";
            }, 3000);
        }

        function changeStep(delta) {
            currentStep += delta;
            if (currentStep < 1) currentStep = 1;
            if (currentStep > 4) currentStep = 4;

            // Hide all content
            document.querySelectorAll('.step-content').forEach(el => el.style.display = 'none');
            // Show current
            document.getElementById(`step-${currentStep}`).style.display = 'block';

            // Update Stepper UI
            document.querySelectorAll('.stepper .step').forEach((el, idx) => {
                el.classList.remove('active', 'completed');
                if (idx + 1 < currentStep) el.classList.add('completed');
                if (idx + 1 === currentStep) el.classList.add('active');
            });

            // Footer buttons
            document.getElementById('back-btn').style.display = currentStep > 1 ? 'block' : 'none';
            document.getElementById('next-btn').style.display = currentStep < 4 ? 'block' : 'none';
            document.getElementById('publish-btn').style.display = currentStep === 4 ? 'block' : 'none';
        }

        async function suggestAI(event) {
            const btn = event.currentTarget; btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            try {
                const topic = document.getElementById('video-title').value || "Viral Video";
                const res = await fetch('/api/ai/suggest', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ topic: topic })
                });
                const data = await res.json();
                document.getElementById('video-title').value = data.title;
                document.getElementById('video-desc').value = data.description;
                document.getElementById('modal-title').innerText = data.title;
            } catch (e) { console.error(e); } finally { btn.innerHTML = '<i class="fas fa-magic"></i> AI'; }
        }

        async function predictViral(event) {
            const btn = event.currentTarget;
            const resEl = document.getElementById('viral-result');
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Analyzing...';
            resEl.innerText = "";
            
            try {
                const title = document.getElementById('video-title').value;
                const desc = document.getElementById('video-desc').value;
                const res = await fetch('/api/ai/predict', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ title, description: desc })
                });
                const data = await res.json();
                resEl.innerHTML = `<i class="fas fa-sparkles"></i> ${data.prediction}`;
            } catch (e) { resEl.innerText = "Prediction unavailable."; }
            finally { btn.innerHTML = '<i class="fas fa-chart-line"></i> AI Viral Predictor'; }
        }

        async function handleUpload() {
            const user = JSON.parse(localStorage.getItem('vitox_user'));
            if (!user) { alert("Please login first"); location.href = 'login.html'; return; }
            const title = document.getElementById('video-title').value;
            if (!title) { alert("Please provide a video title."); return; }

            nextBtn.disabled = true;
            statusMsg.innerText = "Connecting to Global Cloud...";
            statusMsg.style.color = "#ff003c";
            progressFill.style.width = "5%";

            try {
                const formData = new FormData();
                formData.append('file', selectedFile);
                formData.append('upload_preset', uploadPreset);

                const xhr = new XMLHttpRequest();
                xhr.open('POST', `https://api.cloudinary.com/v1_1/${cloudName}/video/upload`, true);

                xhr.upload.onprogress = (e) => {
                    if (e.lengthComputable) {
                        const percent = (e.loaded / e.total) * 100;
                        progressFill.style.width = percent + '%';
                        statusMsg.innerText = `Deploying to Nodes: ${Math.round(percent)}%`;
                    }
                };

                xhr.onload = async function () {
                    if (xhr.status === 200) {
                        const data = JSON.parse(xhr.responseText);
                        saveToDB(data.secure_url, data.thumbnail_url || "");
                    } else {
                        const err = JSON.parse(xhr.responseText);
                        statusMsg.innerText = "CLOUD REJECTED: " + (err.error.message || "Unknown error");

                        if (err.error.message && err.error.message.includes("preset")) {
                            statusMsg.innerHTML = '<span style="color: #ff9800;">CONFIG ERROR: Upload Preset Invalid.</span>';
                            alert("Upload Failed: Cloudinary Preset 'vitox_preset' is invalid. Please check your Cloudinary Settings.");
                            nextBtn.disabled = false;
                        } else {
                            statusMsg.innerText = "UPLOAD FAILED: " + err.error.message;
                            nextBtn.disabled = false;
                        }
                    }
                };

                xhr.onerror = () => { statusMsg.innerText = "NETWORK ERROR"; nextBtn.disabled = false; };
                xhr.send(formData);

            } catch (e) {
                statusMsg.innerText = "FATAL: " + e.message;
                nextBtn.disabled = false;
            }
        }

        async function saveToDB(videoUrl, thumbUrl) {
            const user = JSON.parse(localStorage.getItem('vitox_user'));
            const title = document.getElementById('video-title').value;
            const desc = document.getElementById('video-desc').value;
            statusMsg.innerText = "SYNCING WITH DASHBOARD...";

            const videoType = document.querySelector('input[name="video_type"]:checked').value; // Get selected type
            const category = document.getElementById('video-category').value;

            const dbRes = await fetch('/api/video/upload', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    email: user.email,
                    title: title,
                    description: desc,
                    video_url: videoUrl,
                    thumbnail_url: thumbUrl,
                    type: videoType,
                    category: category
                })
            });

            const dbData = await dbRes.json();
            if (dbData.status === 'success') {
                progressFill.style.width = "100%";
                statusMsg.innerText = "PUBLISHED TO CLOUD SUCCESSFULLY!";
                statusMsg.style.color = "#00ff88";
                setTimeout(() => { location.href = 'index.html'; }, 1500);
            } else {
                statusMsg.innerText = "DB FAILED: " + dbData.message;
                nextBtn.disabled = false;
            }
        }
        function selectThumbnail(el) {
            document.querySelectorAll('.thumb-picker').forEach(p => p.classList.remove('active'));
            el.classList.add('active');
        }
        async function checkStorage() {
            try {
                const res = await fetch('/api/storage/status');
                const data = await res.json();
                const badge = document.getElementById('storage-status');
                if (data.persistent) {
                    badge.innerHTML = '<i class="fas fa-shield-halved" style="color: #00ff88;"></i> CLOUD PERSISTENT';
                    badge.style.borderColor = "rgba(0,255,136,0.3)";
                    badge.style.color = "#00ff88";
                } else if (data.data_risk) {
                    badge.innerHTML = '<i class="fas fa-triangle-exclamation" style="color: #ff3c00;"></i> EPHEMERAL: DATA LOSS RISK';
                    badge.style.borderColor = "rgba(255,60,0,0.3)";
                    badge.style.color = "#ff3c00";
                    alert("CRITICAL: You are NOT using a PostgreSQL database on Render. Your videos will be deleted on every redeploy. Please link a Render PostgreSQL database to your service.");
                } else {
                    badge.innerHTML = '<i class="fas fa-database"></i> LOCAL DISK';
                }
            } catch (e) { }
        }
        checkStorage();
    </script>
</body>

</html>